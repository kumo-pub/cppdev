"use strict";(globalThis.webpackChunkwebsite=globalThis.webpackChunkwebsite||[]).push([[6940],{8453:(e,t,n)=>{n.d(t,{R:()=>l,x:()=>d});var s=n(6540);const i={},r=s.createContext(i);function l(e){const t=s.useContext(r);return s.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function d(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:l(e.components),s.createElement(r.Provider,{value:t},e.children)}},8492:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>x,contentTitle:()=>a,default:()=>g,frontMatter:()=>h,metadata:()=>s,toc:()=>o});const s=JSON.parse('{"id":"foundamentals/json/internals","title":"Architecture","description":"Architecture}","source":"@site/docs/foundamentals/json/internals.mdx","sourceDirName":"foundamentals/json","slug":"/foundamentals/json/internals","permalink":"/cppdev/zh-cn/docs/foundamentals/json/internals","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/foundamentals/json/internals.mdx","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Schema\uff08\u6a21\u5f0f\uff09","permalink":"/cppdev/zh-cn/docs/foundamentals/json/schema"},"next":{"title":"Performance","permalink":"/cppdev/zh-cn/docs/foundamentals/json/performance"}}');var i=n(4848),r=n(8453);const l=n.p+"assets/images/architecture-143a55e8106adc7ed434d5dffafd42f2.png",d=n.p+"assets/images/utilityclass-6cc0626d95fcb997a021c31ac00ccab7.png",c=n.p+"assets/images/iterative-parser-states-diagram-a5a7c74afbeefa4e20b06b326f8e91d6.png",h={},a="Architecture {#Architecture}",x={},o=[{value:"SAX and DOM",id:"sax-and-dom",level:2},{value:"Utility Classes",id:"utility-classes",level:2},{value:"Data Layout",id:"DataLayout",level:2},{value:"Flags",id:"Flags",level:2},{value:"Short String Optimization",id:"ShortString",level:2},{value:"MemoryPoolAllocator",id:"MemoryPoolAllocator",level:2},{value:"Skip Whitespace with SIMD",id:"SkipwhitespaceWithSIMD",level:2},{value:"Page Alignment Issue",id:"page-alignment-issue",level:3},{value:"Local Stream Copy",id:"LocalStreamCopy",level:2},{value:"Parsing to Double-Precision Floating-Point",id:"ParsingDouble",level:2},{value:"Integer to String Conversion",id:"itoa",level:2},{value:"Double-Precision Floating-Point to String Conversion",id:"dtoa",level:2},{value:"Iterative Parsing",id:"IterativeParser",level:2},{value:"Grammar",id:"IterativeParserGrammar",level:3},{value:"Parsing Table",id:"IterativeParserParsingTable",level:3},{value:"Implementation",id:"IterativeParserImplementation",level:3}];function j(e){const t={a:"a",blockquote:"blockquote",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.header,{children:(0,i.jsx)(t.h1,{id:"Architecture",children:"Architecture"})}),"\n",(0,i.jsx)(t.p,{children:"This section documents some design and implementation details."}),"\n",(0,i.jsx)(t.h2,{id:"sax-and-dom",children:"SAX and DOM"}),"\n",(0,i.jsx)(t.p,{children:"The UML diagram below illustrates the basic relationship between SAX and DOM."}),"\n","\n",(0,i.jsx)("img",{src:l}),"\n",(0,i.jsxs)(t.p,{children:["At the core of this relationship is the ",(0,i.jsx)(t.code,{children:"Handler"})," concept. On the SAX side, the ",(0,i.jsx)(t.code,{children:"Reader"})," parses JSON from a stream and sends events to a ",(0,i.jsx)(t.code,{children:"Handler"}),". The ",(0,i.jsx)(t.code,{children:"Writer"})," implements the ",(0,i.jsx)(t.code,{children:"Handler"})," concept to process the same set of events. On the DOM side, the ",(0,i.jsx)(t.code,{children:"Document"})," implements the ",(0,i.jsx)(t.code,{children:"Handler"})," concept to construct the DOM from these events. The ",(0,i.jsx)(t.code,{children:"Value"})," class provides the ",(0,i.jsx)(t.code,{children:"Value::Accept(Handler&)"})," function, which converts the DOM into events and dispatches them."]}),"\n",(0,i.jsxs)(t.p,{children:["In this design, SAX is independent of DOM. Even the ",(0,i.jsx)(t.code,{children:"Reader"})," and ",(0,i.jsx)(t.code,{children:"Writer"})," have no dependencies on each other. This provides flexibility in connecting event emitters and handlers. Additionally, ",(0,i.jsx)(t.code,{children:"Value"})," is independent of SAX. Therefore, besides serializing the DOM to JSON, users can also serialize it to XML or perform any other operations."]}),"\n",(0,i.jsx)(t.h2,{id:"utility-classes",children:"Utility Classes"}),"\n",(0,i.jsxs)(t.p,{children:["Both SAX and DOM APIs rely on three additional concepts: ",(0,i.jsx)(t.code,{children:"Allocator"}),", ",(0,i.jsx)(t.code,{children:"Encoding"}),", and ",(0,i.jsx)(t.code,{children:"Stream"}),". Their inheritance hierarchy is shown in the diagram below."]}),"\n","\n",(0,i.jsx)("img",{src:d}),"\n",(0,i.jsx)(t.h1,{id:"Value",children:"Value"}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.code,{children:"Value"})," (actually defined as ",(0,i.jsx)(t.code,{children:"GenericValue<UTF8<>>"}),") is the core of the DOM API. This section describes its design."]}),"\n",(0,i.jsx)(t.h2,{id:"DataLayout",children:"Data Layout"}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.code,{children:"Value"})," is a ",(0,i.jsx)(t.a,{href:"http://en.wikipedia.org/wiki/Variant_type",children:"variant type"}),". In the context of Merak, an instance of ",(0,i.jsx)(t.code,{children:"Value"})," can hold one of six JSON data types. This is achieved using a ",(0,i.jsx)(t.code,{children:"union"}),". Each ",(0,i.jsx)(t.code,{children:"Value"})," contains two members: ",(0,i.jsx)(t.code,{children:"union Data data_"})," and ",(0,i.jsx)(t.code,{children:"unsigned flags_"}),". The ",(0,i.jsx)(t.code,{children:"flags_"})," indicates the JSON type as well as additional information."]}),"\n",(0,i.jsx)(t.p,{children:"The table below shows the data layout for all types. The 32-bit/64-bit columns indicate the number of bytes occupied by each field."}),"\n",(0,i.jsxs)(t.table,{children:[(0,i.jsx)(t.thead,{children:(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.th,{children:"Null"}),(0,i.jsx)(t.th,{children:"Description"}),(0,i.jsx)(t.th,{style:{textAlign:"center"},children:"32-bit"}),(0,i.jsx)(t.th,{style:{textAlign:"center"},children:"64-bit"})]})}),(0,i.jsxs)(t.tbody,{children:[(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"(Unused)"}),(0,i.jsx)(t.td,{}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"8"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"(Unused)"}),(0,i.jsx)(t.td,{}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"(Unused)"}),(0,i.jsx)(t.td,{}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"unsigned flags_"})}),(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"kNullType kNullFlag"})}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"})]})]})]}),"\n",(0,i.jsxs)(t.table,{children:[(0,i.jsx)(t.thead,{children:(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.th,{children:"Bool"}),(0,i.jsx)(t.th,{children:"Description"}),(0,i.jsx)(t.th,{style:{textAlign:"center"},children:"32-bit"}),(0,i.jsx)(t.th,{style:{textAlign:"center"},children:"64-bit"})]})}),(0,i.jsxs)(t.tbody,{children:[(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"(Unused)"}),(0,i.jsx)(t.td,{}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"8"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"(Unused)"}),(0,i.jsx)(t.td,{}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"(Unused)"}),(0,i.jsx)(t.td,{}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"unsigned flags_"})}),(0,i.jsxs)(t.td,{children:[(0,i.jsx)(t.code,{children:"kBoolType"})," (either ",(0,i.jsx)(t.code,{children:"kTrueFlag"})," or ",(0,i.jsx)(t.code,{children:"kFalseFlag"}),")"]}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"})]})]})]}),"\n",(0,i.jsxs)(t.table,{children:[(0,i.jsx)(t.thead,{children:(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.th,{children:"String"}),(0,i.jsx)(t.th,{children:"Description"}),(0,i.jsx)(t.th,{style:{textAlign:"center"},children:"32-bit"}),(0,i.jsx)(t.th,{style:{textAlign:"center"},children:"64-bit"})]})}),(0,i.jsxs)(t.tbody,{children:[(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"Ch* str"})}),(0,i.jsx)(t.td,{children:"Pointer to string (may own ownership)"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"8"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"SizeType length"})}),(0,i.jsx)(t.td,{children:"String length"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"(Unused)"}),(0,i.jsx)(t.td,{}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"unsigned flags_"})}),(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"kStringType kStringFlag ..."})}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"})]})]})]}),"\n",(0,i.jsxs)(t.table,{children:[(0,i.jsx)(t.thead,{children:(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.th,{children:"Object"}),(0,i.jsx)(t.th,{children:"Description"}),(0,i.jsx)(t.th,{style:{textAlign:"center"},children:"32-bit"}),(0,i.jsx)(t.th,{style:{textAlign:"center"},children:"64-bit"})]})}),(0,i.jsxs)(t.tbody,{children:[(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"Member* members"})}),(0,i.jsx)(t.td,{children:"Pointer to member array (owns ownership)"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"8"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"SizeType size"})}),(0,i.jsx)(t.td,{children:"Number of members"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"SizeType capacity"})}),(0,i.jsx)(t.td,{children:"Member capacity"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"unsigned flags_"})}),(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"kObjectType kObjectFlag"})}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"})]})]})]}),"\n",(0,i.jsxs)(t.table,{children:[(0,i.jsx)(t.thead,{children:(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.th,{children:"Array"}),(0,i.jsx)(t.th,{children:"Description"}),(0,i.jsx)(t.th,{style:{textAlign:"center"},children:"32-bit"}),(0,i.jsx)(t.th,{style:{textAlign:"center"},children:"64-bit"})]})}),(0,i.jsxs)(t.tbody,{children:[(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"Value* values"})}),(0,i.jsx)(t.td,{children:"Pointer to value array (owns ownership)"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"8"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"SizeType size"})}),(0,i.jsx)(t.td,{children:"Number of values"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"SizeType capacity"})}),(0,i.jsx)(t.td,{children:"Value capacity"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"unsigned flags_"})}),(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"kArrayType kArrayFlag"})}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"})]})]})]}),"\n",(0,i.jsxs)(t.table,{children:[(0,i.jsx)(t.thead,{children:(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.th,{children:"Number (Int)"}),(0,i.jsx)(t.th,{children:"Description"}),(0,i.jsx)(t.th,{style:{textAlign:"center"},children:"32-bit"}),(0,i.jsx)(t.th,{style:{textAlign:"center"},children:"64-bit"})]})}),(0,i.jsxs)(t.tbody,{children:[(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"int i"})}),(0,i.jsx)(t.td,{children:"32-bit signed integer"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"(Zero padding)"}),(0,i.jsx)(t.td,{children:"0"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"(Unused)"}),(0,i.jsx)(t.td,{}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"8"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"unsigned flags_"})}),(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"kNumberType kNumberFlag kIntFlag kInt64Flag ..."})}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"})]})]})]}),"\n",(0,i.jsxs)(t.table,{children:[(0,i.jsx)(t.thead,{children:(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.th,{children:"Number (UInt)"}),(0,i.jsx)(t.th,{children:"Description"}),(0,i.jsx)(t.th,{style:{textAlign:"center"},children:"32-bit"}),(0,i.jsx)(t.th,{style:{textAlign:"center"},children:"64-bit"})]})}),(0,i.jsxs)(t.tbody,{children:[(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"unsigned u"})}),(0,i.jsx)(t.td,{children:"32-bit unsigned integer"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"(Zero padding)"}),(0,i.jsx)(t.td,{children:"0"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"(Unused)"}),(0,i.jsx)(t.td,{}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"8"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"unsigned flags_"})}),(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"kNumberType kNumberFlag kUintFlag kUint64Flag ..."})}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"})]})]})]}),"\n",(0,i.jsxs)(t.table,{children:[(0,i.jsx)(t.thead,{children:(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.th,{children:"Number (Int64)"}),(0,i.jsx)(t.th,{children:"Description"}),(0,i.jsx)(t.th,{style:{textAlign:"center"},children:"32-bit"}),(0,i.jsx)(t.th,{style:{textAlign:"center"},children:"64-bit"})]})}),(0,i.jsxs)(t.tbody,{children:[(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"int64_t i64"})}),(0,i.jsx)(t.td,{children:"64-bit signed integer"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"8"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"8"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"(Unused)"}),(0,i.jsx)(t.td,{}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"8"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"unsigned flags_"})}),(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"kNumberType kNumberFlag kInt64Flag ..."})}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"})]})]})]}),"\n",(0,i.jsxs)(t.table,{children:[(0,i.jsx)(t.thead,{children:(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.th,{children:"Number (Uint64)"}),(0,i.jsx)(t.th,{children:"Description"}),(0,i.jsx)(t.th,{style:{textAlign:"center"},children:"32-bit"}),(0,i.jsx)(t.th,{style:{textAlign:"center"},children:"64-bit"})]})}),(0,i.jsxs)(t.tbody,{children:[(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"uint64_t i64"})}),(0,i.jsx)(t.td,{children:"64-bit unsigned integer"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"8"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"8"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"(Unused)"}),(0,i.jsx)(t.td,{}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"8"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"unsigned flags_"})}),(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"kNumberType kNumberFlag kInt64Flag ..."})}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"})]})]})]}),"\n",(0,i.jsxs)(t.table,{children:[(0,i.jsx)(t.thead,{children:(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.th,{children:"Number (Double)"}),(0,i.jsx)(t.th,{children:"Description"}),(0,i.jsx)(t.th,{style:{textAlign:"center"},children:"32-bit"}),(0,i.jsx)(t.th,{style:{textAlign:"center"},children:"64-bit"})]})}),(0,i.jsxs)(t.tbody,{children:[(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"uint64_t i64"})}),(0,i.jsx)(t.td,{children:"Double-precision floating-point number"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"8"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"8"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:"(Unused)"}),(0,i.jsx)(t.td,{}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"8"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"unsigned flags_"})}),(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"kNumberType kNumberFlag kDoubleFlag"})}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"})]})]})]}),"\n",(0,i.jsx)(t.p,{children:"Some notes to consider:"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["To reduce memory consumption on 64-bit architectures, ",(0,i.jsx)(t.code,{children:"SizeType"})," is defined as ",(0,i.jsx)(t.code,{children:"unsigned"})," instead of ",(0,i.jsx)(t.code,{children:"size_t"}),"."]}),"\n",(0,i.jsx)(t.li,{children:"The zero padding for 32-bit integers may be placed before or after the actual type, depending on endianness. This allows 32-bit integers to be interpreted as 64-bit integers without any conversion."}),"\n",(0,i.jsxs)(t.li,{children:["An ",(0,i.jsx)(t.code,{children:"Int"})," is always an ",(0,i.jsx)(t.code,{children:"Int64"}),", but the reverse is not true."]}),"\n"]}),"\n",(0,i.jsx)(t.h2,{id:"Flags",children:"Flags"}),"\n",(0,i.jsxs)(t.p,{children:["The 32-bit ",(0,i.jsx)(t.code,{children:"flags_"})," contains the JSON type and other information. As shown in the tables above, each JSON type includes redundant ",(0,i.jsx)(t.code,{children:"kXXXType"})," and ",(0,i.jsx)(t.code,{children:"kXXXFlag"})," flags. This design optimizes for testing bit flags (e.g., ",(0,i.jsx)(t.code,{children:"IsNumber()"}),") and retrieving the sequence number of each type (e.g., ",(0,i.jsx)(t.code,{children:"GetType()"}),")."]}),"\n",(0,i.jsxs)(t.p,{children:["Strings have two optional flags. ",(0,i.jsx)(t.code,{children:"kCopyFlag"})," indicates that the string owns the copy of the string data. ",(0,i.jsx)(t.code,{children:"kInlineStrFlag"})," means ",(0,i.jsx)(t.a,{href:"#ShortString",children:"short string optimization"})," is used."]}),"\n",(0,i.jsxs)(t.p,{children:["Numbers are more complex. For regular integer values, ",(0,i.jsx)(t.code,{children:"flags_"})," may include ",(0,i.jsx)(t.code,{children:"kIntFlag"}),", ",(0,i.jsx)(t.code,{children:"kUintFlag"}),", ",(0,i.jsx)(t.code,{children:"kInt64Flag"}),", and/or ",(0,i.jsx)(t.code,{children:"kUint64Flag"}),", depending on the range of the integer. Numbers with fractional parts or integers exceeding the range of 64 bits are stored as ",(0,i.jsx)(t.code,{children:"double"})," with the ",(0,i.jsx)(t.code,{children:"kDoubleFlag"})," set."]}),"\n",(0,i.jsx)(t.h2,{id:"ShortString",children:"Short String Optimization"}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.a,{href:"https://github.com/Kosta-Github",children:"Kosta"})," contributed an excellent short string optimization. The principle of this optimization is described below. Excluding ",(0,i.jsx)(t.code,{children:"flags_"}),", a ",(0,i.jsx)(t.code,{children:"Value"})," has 12 or 16 bytes (for 32-bit or 64-bit architectures) to store actual data. This makes it possible to store short strings directly within the ",(0,i.jsx)(t.code,{children:"Value"})," instead of storing a pointer to the string. For 1-byte character types (e.g., ",(0,i.jsx)(t.code,{children:"char"}),"), it can store strings of up to 11 or 15 characters inside the ",(0,i.jsx)(t.code,{children:"Value"})," type."]}),"\n",(0,i.jsxs)(t.table,{children:[(0,i.jsx)(t.thead,{children:(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.th,{children:"ShortString (Ch=char)"}),(0,i.jsx)(t.th,{children:"Description"}),(0,i.jsx)(t.th,{style:{textAlign:"center"},children:"32-bit"}),(0,i.jsx)(t.th,{style:{textAlign:"center"},children:"64-bit"})]})}),(0,i.jsxs)(t.tbody,{children:[(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"Ch str[MaxChars]"})}),(0,i.jsx)(t.td,{children:"String buffer"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"11"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"15"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"Ch invLength"})}),(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"MaxChars - Length"})}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"1"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"1"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"unsigned flags_"})}),(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"kStringType kStringFlag ..."})}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"4"})]})]})]}),"\n",(0,i.jsxs)(t.p,{children:["A special technique is used here: it stores ",(0,i.jsx)(t.code,{children:"(MaxChars - length)"})," instead of the string length directly. This makes it possible to store 11 characters with a trailing ",(0,i.jsx)(t.code,{children:"\\0"}),"."]}),"\n",(0,i.jsx)(t.p,{children:"This optimization reduces memory usage for string copies, improves cache coherence, and further boosts runtime performance."}),"\n",(0,i.jsx)(t.h1,{id:"InternalAllocator",children:"Allocator"}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.code,{children:"Allocator"})," is a core concept in Merak:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-cpp",children:"concept Allocator {\n    static const bool kNeedFree;    //!< Indicates whether this allocator requires calling Free().\n\n    // Allocates a memory block.\n    // \\param size Size of the memory block in bytes.\n    // \\returns Pointer to the allocated memory block.\n    void* Malloc(size_t size);\n\n    // Resizes a memory block.\n    // \\param originalPtr Pointer to the current memory block. Null pointer is allowed.\n    // \\param originalSize Current size of the memory block in bytes. (Design note: Some allocators may not track this, so passing it explicitly saves memory.)\n    // \\param newSize New size of the memory block in bytes.\n    void* Realloc(void* originalPtr, size_t originalSize, size_t newSize);\n\n    // Frees a memory block.\n    // \\param ptr Pointer to the memory block to free. Null pointer is allowed.\n    static void Free(void *ptr);\n};\n"})}),"\n",(0,i.jsxs)(t.p,{children:["It is important to note that ",(0,i.jsx)(t.code,{children:"Malloc()"})," and ",(0,i.jsx)(t.code,{children:"Realloc()"})," are member functions, while ",(0,i.jsx)(t.code,{children:"Free()"})," is a static member function."]}),"\n",(0,i.jsx)(t.h2,{id:"MemoryPoolAllocator",children:"MemoryPoolAllocator"}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.code,{children:"MemoryPoolAllocator"})," is the default memory allocator for the DOM. It only allocates memory and does not free it, making it ideal for building DOM trees."]}),"\n",(0,i.jsxs)(t.p,{children:["Internally, it allocates memory blocks from an underlying allocator (default: ",(0,i.jsx)(t.code,{children:"CrtAllocator"}),") and stores these blocks in a singly linked list. When a user requests memory allocation, it follows these steps:"]}),"\n",(0,i.jsxs)(t.ol,{children:["\n",(0,i.jsxs)(t.li,{children:["Use the user-provided buffer if available. (See ",(0,i.jsx)(t.a,{href:"/cppdev/zh-cn/docs/foundamentals/json/dom",children:"User Buffer section in DOM"}),")"]}),"\n",(0,i.jsx)(t.li,{children:"If the user-provided buffer is full, use the current memory block."}),"\n",(0,i.jsx)(t.li,{children:"If the current memory block is full, allocate a new memory block."}),"\n"]}),"\n",(0,i.jsx)(t.h1,{id:"ParsingOptimization",children:"Parsing Optimization"}),"\n",(0,i.jsx)(t.h2,{id:"SkipwhitespaceWithSIMD",children:"Skip Whitespace with SIMD"}),"\n",(0,i.jsx)(t.p,{children:"When parsing JSON from a stream, the parser needs to skip four types of whitespace characters:"}),"\n",(0,i.jsxs)(t.ol,{children:["\n",(0,i.jsxs)(t.li,{children:["Space (",(0,i.jsx)(t.code,{children:"U+0020"}),")"]}),"\n",(0,i.jsxs)(t.li,{children:["Horizontal tab (",(0,i.jsx)(t.code,{children:"U+0009"}),")"]}),"\n",(0,i.jsxs)(t.li,{children:["Line feed (",(0,i.jsx)(t.code,{children:"U+000A"}),")"]}),"\n",(0,i.jsxs)(t.li,{children:["Carriage return (",(0,i.jsx)(t.code,{children:"U+000D"}),")"]}),"\n"]}),"\n",(0,i.jsx)(t.p,{children:"This is a naive implementation:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-cpp",children:"void SkipWhitespace(InputStream& s) {\n    while (s.Peek() == ' ' || s.Peek() == '\\n' || s.Peek() == '\\r' || s.Peek() == '\\t')\n        s.Take();\n}\n"})}),"\n",(0,i.jsx)(t.p,{children:"However, this requires four comparisons per character plus some branching, which has been identified as a performance hotspot."}),"\n",(0,i.jsxs)(t.p,{children:["To accelerate this process, Merak uses SIMD to compare 16 characters against the four whitespace characters in a single iteration. Currently, Merak supports SSE2, SSE4.2, and ARM Neon instructions. This optimization is only enabled for UTF-8 in-memory streams, including string streams or ",(0,i.jsx)(t.em,{children:"in situ"})," parsing."]}),"\n",(0,i.jsxs)(t.p,{children:["You can enable this optimization by defining ",(0,i.jsx)(t.code,{children:"RAPIDJSON_SSE2"}),", ",(0,i.jsx)(t.code,{children:"RAPIDJSON_SSE42"}),", or ",(0,i.jsx)(t.code,{children:"RAPIDJSON_NEON"})," before including ",(0,i.jsx)(t.code,{children:"merak/json.h"}),". Some compilers can detect these settings automatically, as shown in ",(0,i.jsx)(t.code,{children:"perftest.h"}),":"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-cpp",children:"// __SSE2__ and __SSE4_2__ are recognized by GCC, Clang, and Intel compilers:\n// We use -march=native in gmake to enable -msse2 and -msse4.2 if supported\n// Similarly, __ARM_NEON is used to detect Neon support\n#if defined(__SSE4_2__)\n#  define RAPIDJSON_SSE42\n#elif defined(__SSE2__)\n#  define RAPIDJSON_SSE2\n#elif defined(__ARM_NEON)\n#  define RAPIDJSON_NEON\n#endif\n"})}),"\n",(0,i.jsx)(t.p,{children:"It is important to note that this is a compile-time setting. Running the executable on machines that do not support these instructions will cause a crash."}),"\n",(0,i.jsx)(t.h3,{id:"page-alignment-issue",children:"Page Alignment Issue"}),"\n",(0,i.jsxs)(t.p,{children:["In early versions of Merak, a ",(0,i.jsx)(t.a,{href:"https://code.google.com/archive/p/merak/json/issues/104",children:"bug"})," was reported: ",(0,i.jsx)(t.code,{children:"SkipWhitespace_SIMD()"})," would rarely cause a crash (approximately 1 in 500,000 occurrences). After investigation, it was suspected that ",(0,i.jsx)(t.code,{children:"_mm_loadu_si128()"})," accessed memory beyond ",(0,i.jsx)(t.code,{children:"'\\0'"})," and crossed a protected page boundary."]}),"\n",(0,i.jsxs)(t.p,{children:["In the ",(0,i.jsx)(t.a,{href:"http://www.intel.com/content/www/us/en/architecture-and-technology/64-ia-32-architectures-optimization-manual.html",children:"Intel\xae 64 and IA-32 Architectures Optimization Reference Manual"}),", section 10.2.1 states:"]}),"\n",(0,i.jsxs)(t.blockquote,{children:["\n",(0,i.jsx)(t.p,{children:"To support algorithms that require unaligned 128-bit SIMD memory accesses, the caller\u2019s memory buffer allocation should include padding so that the called function can safely use the address pointer for unaligned 128-bit SIMD memory operations. When combining unaligned SIMD memory operations, the minimum alignment size should be equal to the size of the SIMD register."}),"\n"]}),"\n",(0,i.jsx)(t.p,{children:"This is clearly not feasible for Merak, as Merak should not force users to align memory."}),"\n",(0,i.jsxs)(t.p,{children:["To fix this issue, the current code first processes bytes one by one until the next aligned address. After that, aligned reads are used for SIMD processing. See ",(0,i.jsx)(t.a,{href:"https://github.com/kumose/merak/issues/85",children:"#85"}),"."]}),"\n",(0,i.jsx)(t.h2,{id:"LocalStreamCopy",children:"Local Stream Copy"}),"\n",(0,i.jsxs)(t.p,{children:["During optimization, we found that some compilers fail to place accesses to stream member data into local variables or registers. Test results show that for some stream types, creating a copy of the stream and using it in inner loops improves performance. For example, the actual (non-SIMD) ",(0,i.jsx)(t.code,{children:"SkipWhitespace()"})," is implemented as:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-cpp",children:"template<typename InputStream>\nvoid SkipWhitespace(InputStream& is) {\n    internal::StreamLocalCopy<InputStream> copy(is);\n    InputStream& s(copy.s);\n\n    while (s.Peek() == ' ' || s.Peek() == '\\n' || s.Peek() == '\\r' || s.Peek() == '\\t')\n        s.Take();\n}\n"})}),"\n",(0,i.jsxs)(t.p,{children:["Based on the characteristics of the stream, ",(0,i.jsx)(t.code,{children:"StreamLocalCopy"})," creates (or does not create) a copy of the stream object, uses it locally, and copies the stream state back to the original stream."]}),"\n",(0,i.jsx)(t.h2,{id:"ParsingDouble",children:"Parsing to Double-Precision Floating-Point"}),"\n",(0,i.jsxs)(t.p,{children:["Parsing a string to a ",(0,i.jsx)(t.code,{children:"double"})," is non-trivial. The standard library function ",(0,i.jsx)(t.code,{children:"strtod()"})," can do this, but it is relatively slow. By default, the parser uses normal precision settings, which have a maximum error of 3 ",(0,i.jsx)(t.a,{href:"http://en.wikipedia.org/wiki/Unit_in_the_last_place",children:"ULP"})," and are implemented in ",(0,i.jsx)(t.code,{children:"internal::StrtodNormalPrecision()"}),"."]}),"\n",(0,i.jsxs)(t.p,{children:["When the ",(0,i.jsx)(t.code,{children:"kParseFullPrecisionFlag"})," is used, the parser instead calls ",(0,i.jsx)(t.code,{children:"internal::StrtodFullPrecision()"}),", which automatically invokes three versions of conversion:"]}),"\n",(0,i.jsxs)(t.ol,{children:["\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.a,{href:"http://www.exploringbinary.com/fast-path-decimal-to-floating-point-conversion/",children:"Fast-Path"}),"."]}),"\n",(0,i.jsxs)(t.li,{children:["A custom DIY-FP implementation from ",(0,i.jsx)(t.a,{href:"https://github.com/floitsch/double-conversion",children:"double-conversion"}),"."]}),"\n",(0,i.jsx)(t.li,{children:"A big-integer algorithm from (Clinger, William D. How to read floating point numbers accurately. Vol. 25. No. 6. ACM, 1990)."}),"\n"]}),"\n",(0,i.jsx)(t.p,{children:"If the first conversion method fails, it tries the second, and so on."}),"\n",(0,i.jsx)(t.h1,{id:"GenerationOptimization",children:"Generation Optimization"}),"\n",(0,i.jsx)(t.h2,{id:"itoa",children:"Integer to String Conversion"}),"\n",(0,i.jsxs)(t.p,{children:["The naive algorithm for integer-to-string conversion requires one division per decimal digit. We implemented several versions and evaluated them in ",(0,i.jsx)(t.a,{href:"https://github.com/miloyip/itoa-benchmark",children:"itoa-benchmark"}),"."]}),"\n",(0,i.jsxs)(t.p,{children:["Although the SSE2 version is the fastest, it has only a small performance gap with the second-fastest ",(0,i.jsx)(t.code,{children:"branchlut"})," version. Additionally, ",(0,i.jsx)(t.code,{children:"branchlut"})," is a pure C++ implementation, so we use ",(0,i.jsx)(t.code,{children:"branchlut"})," in Merak."]}),"\n",(0,i.jsx)(t.h2,{id:"dtoa",children:"Double-Precision Floating-Point to String Conversion"}),"\n",(0,i.jsxs)(t.p,{children:["Originally, Merak used ",(0,i.jsx)(t.code,{children:'snprintf(..., ..., "%g")'})," for double-to-string conversion. This is inaccurate because the default precision is 6. Later, we found it to be slow and identified alternative approaches."]}),"\n",(0,i.jsxs)(t.p,{children:["Google\u2019s V8 ",(0,i.jsx)(t.a,{href:"https://github.com/floitsch/double-conversion",children:"double-conversion"}),' library implements a newer, fast algorithm called Grisu3 (Loitsch, Florian. "Printing floating-point numbers quickly and accurately with integers." ACM Sigplan Notices 45.6 (2010): 233-243.).']}),"\n",(0,i.jsx)(t.p,{children:"However, this implementation is not header-only, so we implemented a header-only version of Grisu2. This algorithm guarantees that the result is always precise and, in most cases, generates the shortest possible (canonical) string representation."}),"\n",(0,i.jsxs)(t.p,{children:["This header-only conversion function is evaluated in ",(0,i.jsx)(t.a,{href:"https://github.com/miloyip/dtoa-benchmark",children:"dtoa-benchmark"}),"."]}),"\n",(0,i.jsx)(t.h1,{id:"Parser",children:"Parser"}),"\n",(0,i.jsx)(t.h2,{id:"IterativeParser",children:"Iterative Parsing"}),"\n",(0,i.jsx)(t.p,{children:"The iterative parser is a non-recursive implementation of a recursive-descent LL(1) parser."}),"\n",(0,i.jsx)(t.h3,{id:"IterativeParserGrammar",children:"Grammar"}),"\n",(0,i.jsx)(t.p,{children:"The grammar used by the parser is based on the strict JSON grammar:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:"S -> array | object\narray -> [ values ]\nobject -> { members }\nvalues -> non-empty-values | \u03b5\nnon-empty-values -> value addition-values\naddition-values -> \u03b5 | , non-empty-values\nmembers -> non-empty-members | \u03b5\nnon-empty-members -> member addition-members\naddition-members -> \u03b5 | , non-empty-members\nmember -> STRING : value\nvalue -> STRING | NUMBER | NULL | BOOLEAN | object | array\n"})}),"\n",(0,i.jsxs)(t.p,{children:["Note that left factoring is applied to the ",(0,i.jsx)(t.code,{children:"values"})," and ",(0,i.jsx)(t.code,{children:"members"})," non-terminals to ensure the grammar is LL(1)."]}),"\n",(0,i.jsx)(t.h3,{id:"IterativeParserParsingTable",children:"Parsing Table"}),"\n",(0,i.jsx)(t.p,{children:"Based on this grammar, we can construct the FIRST and FOLLOW sets."}),"\n",(0,i.jsx)(t.p,{children:"The FIRST sets for non-terminals are shown below:"}),"\n",(0,i.jsxs)(t.table,{children:[(0,i.jsx)(t.thead,{children:(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.th,{style:{textAlign:"center"},children:"Non-terminal"}),(0,i.jsx)(t.th,{style:{textAlign:"center"},children:"FIRST"})]})}),(0,i.jsxs)(t.tbody,{children:[(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"array"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:(0,i.jsx)(t.code,{children:"["})})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"object"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:(0,i.jsx)(t.code,{children:"{"})})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"values"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:(0,i.jsx)(t.code,{children:"\u03b5 STRING NUMBER NULL BOOLEAN { ["})})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"addition-values"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:(0,i.jsx)(t.code,{children:"\u03b5 COMMA"})})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"members"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:(0,i.jsx)(t.code,{children:"\u03b5 STRING"})})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"addition-members"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:(0,i.jsx)(t.code,{children:"\u03b5 COMMA"})})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"member"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:(0,i.jsx)(t.code,{children:"STRING"})})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"value"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:(0,i.jsx)(t.code,{children:"STRING NUMBER NULL BOOLEAN { ["})})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"S"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:(0,i.jsx)(t.code,{children:" [ {"})})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"non-empty-members"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:(0,i.jsx)(t.code,{children:"STRING"})})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"non-empty-values"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:(0,i.jsx)(t.code,{children:"STRING NUMBER NULL BOOLEAN { ["})})]})]})]}),"\n",(0,i.jsx)(t.p,{children:"The FOLLOW sets for non-terminals are shown below:"}),"\n",(0,i.jsxs)(t.table,{children:[(0,i.jsx)(t.thead,{children:(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.th,{style:{textAlign:"center"},children:"Non-terminal"}),(0,i.jsx)(t.th,{style:{textAlign:"center"},children:"FOLLOW"})]})}),(0,i.jsxs)(t.tbody,{children:[(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"S"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:(0,i.jsx)(t.code,{children:"$ "})})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"array"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:(0,i.jsx)(t.code,{children:", $ } ] "})})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"object"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:(0,i.jsx)(t.code,{children:", $ } ]"})})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"values"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:(0,i.jsx)(t.code,{children:"  ]"})})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"non-empty-values"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:(0,i.jsx)(t.code,{children:"]"})})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"addition-values"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:(0,i.jsx)(t.code,{children:" ]"})})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"members"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:(0,i.jsx)(t.code,{children:"  }"})})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"non-empty-members"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:(0,i.jsx)(t.code,{children:" }"})})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"addition-members"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:(0,i.jsx)(t.code,{children:"} "})})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"member"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:(0,i.jsx)(t.code,{children:", } "})})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"value"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:(0,i.jsx)(t.code,{children:", } ] "})})]})]})]}),"\n",(0,i.jsx)(t.p,{children:"A parsing table can be generated from the FIRST and FOLLOW sets as follows:"}),"\n",(0,i.jsxs)(t.table,{children:[(0,i.jsx)(t.thead,{children:(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.th,{style:{textAlign:"center"},children:"Non-terminal"}),(0,i.jsx)(t.th,{style:{textAlign:"center"},children:(0,i.jsx)(t.code,{children:"["})}),(0,i.jsx)(t.th,{style:{textAlign:"center"},children:(0,i.jsx)(t.code,{children:"{ "})}),(0,i.jsx)(t.th,{style:{textAlign:"center"},children:(0,i.jsx)(t.code,{children:" ,"})}),(0,i.jsx)(t.th,{style:{textAlign:"center"},children:(0,i.jsx)(t.code,{children:":"})}),(0,i.jsx)(t.th,{style:{textAlign:"center"},children:(0,i.jsx)(t.code,{children:"]"})}),(0,i.jsx)(t.th,{style:{textAlign:"center"},children:(0,i.jsx)(t.code,{children:"}"})}),(0,i.jsx)(t.th,{style:{textAlign:"center"},children:"STRING"}),(0,i.jsx)(t.th,{style:{textAlign:"center"},children:"NUMBER"}),(0,i.jsx)(t.th,{style:{textAlign:"center"},children:"NULL"}),(0,i.jsx)(t.th,{style:{textAlign:"center"},children:"BOOLEAN"})]})}),(0,i.jsxs)(t.tbody,{children:[(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"S"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"array"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"object"}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"array"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:(0,i.jsx)(t.code,{children:"[ values ]"})}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"object"}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:(0,i.jsx)(t.code,{children:"{ members }"})}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"values"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"non-empty-values"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"non-empty-values"}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"\u03b5"}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"non-empty-values"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"non-empty-values"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"non-empty-values"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"non-empty-values"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"non-empty-values"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"value addition-values"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"value addition-values"}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"value addition-values"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"value addition-values"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"value addition-values"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"value addition-values"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"addition-values"}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:", non-empty-values"}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"\u03b5"}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"members"}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"\u03b5"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"non-empty-members"}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"non-empty-members"}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"member addition-members"}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"addition-members"}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:", non-empty-members"}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"\u03b5"}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"member"}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"STRING : value"}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"value"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"array"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"object"}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"}}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"STRING"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"NUMBER"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"NULL"}),(0,i.jsx)(t.td,{style:{textAlign:"center"},children:"BOOLEAN"})]})]})]}),"\n",(0,i.jsxs)(t.p,{children:["For the grammar analysis above, there is an excellent ",(0,i.jsx)(t.a,{href:"http://hackingoff.com/compilers/predict-first-follow-set",children:"tool"})," available."]}),"\n",(0,i.jsx)(t.h3,{id:"IterativeParserImplementation",children:"Implementation"}),"\n",(0,i.jsx)(t.p,{children:"Based on this parsing table, a straightforward (conventional) implementation that pushes rules onto the stack in reverse order works correctly."}),"\n",(0,i.jsx)(t.p,{children:"In Merak, several modifications are made to the straightforward implementation:"}),"\n",(0,i.jsxs)(t.p,{children:["First, in Merak, the parsing table is encoded as a state machine. Rules consist of a head and a body, and state transitions are constructed from the rules. Additionally, extra states are added to rules related to ",(0,i.jsx)(t.code,{children:"array"})," and ",(0,i.jsx)(t.code,{children:"object"}),". This allows generating array values or object members with a single state transition, instead of multiple stack push/pop operations in the straightforward implementation. It also makes it easier to estimate the stack size."]}),"\n",(0,i.jsx)(t.p,{children:"The state diagram is shown below:"}),"\n","\n",(0,i.jsx)("img",{src:c}),"\n",(0,i.jsx)(t.p,{children:"Second, unlike traditional implementations, the iterative parser also stores the number of array values and object members in its internal stack."})]})}function g(e={}){const{wrapper:t}={...(0,r.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(j,{...e})}):j(e)}}}]);