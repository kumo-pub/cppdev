"use strict";(globalThis.webpackChunkwebsite=globalThis.webpackChunkwebsite||[]).push([[4184],{8453:(e,n,r)=>{r.d(n,{R:()=>a,x:()=>t});var i=r(6540);const s={},c=i.createContext(s);function a(e){const n=i.useContext(c);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),i.createElement(c.Provider,{value:n},e.children)}},8642:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>o,contentTitle:()=>t,default:()=>d,frontMatter:()=>a,metadata:()=>i,toc:()=>h});const i=JSON.parse('{"id":"foundamentals/testing/benchmark/reducing_variance","title":"Reducing Variance","description":"Disabling CPU Frequency Scaling","source":"@site/i18n/zh-cn/docusaurus-plugin-content-docs/current/foundamentals/testing/benchmark/reducing_variance.md","sourceDirName":"foundamentals/testing/benchmark","slug":"/foundamentals/testing/benchmark/reducing_variance","permalink":"/cppdev/zh-cn/docs/foundamentals/testing/benchmark/reducing_variance","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Random Interleaving","permalink":"/cppdev/zh-cn/docs/foundamentals/testing/benchmark/random_interleaving"},"next":{"title":"How to release","permalink":"/cppdev/zh-cn/docs/foundamentals/testing/benchmark/releasing"}}');var s=r(4848),c=r(8453);const a={},t="Reducing Variance",o={},h=[{value:"Disabling CPU Frequency Scaling",id:"disabling-cpu-frequency-scaling",level:2},{value:"Disabling ASLR",id:"reducing-variance",level:2},{value:"Reducing Variance in Benchmarks",id:"reducing-variance-in-benchmarks",level:2}];function l(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",...(0,c.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"reducing-variance",children:"Reducing Variance"})}),"\n",(0,s.jsx)(n.h2,{id:"disabling-cpu-frequency-scaling",children:"Disabling CPU Frequency Scaling"}),"\n",(0,s.jsx)(n.p,{children:"If you see this error:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"***WARNING*** CPU scaling is enabled, the benchmark real time measurements may be noisy and will incur extra overhead.\n"})}),"\n",(0,s.jsx)(n.p,{children:"you might want to disable the CPU frequency scaling while running the\nbenchmark, as well as consider other ways to stabilize the performance of\nyour system while benchmarking."}),"\n",(0,s.jsx)(n.p,{children:"Exactly how to do this depends on the Linux distribution,\ndesktop environment, and installed programs.  Specific details are a moving\ntarget, so we will not attempt to exhaustively document them here."}),"\n",(0,s.jsxs)(n.p,{children:["One simple option is to use the ",(0,s.jsx)(n.code,{children:"cpupower"}),' program to change the\nperformance governor to "performance".  This tool is maintained along with\nthe Linux kernel and provided by your distribution.']}),"\n",(0,s.jsx)(n.p,{children:"It must be run as root, like this:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"sudo cpupower frequency-set --governor performance\n"})}),"\n",(0,s.jsx)(n.p,{children:"After this you can verify that all CPUs are using the performance governor\nby running this command:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"cpupower frequency-info -o proc\n"})}),"\n",(0,s.jsx)(n.p,{children:"The benchmarks you subsequently run will have less variance."}),"\n",(0,s.jsx)(n.h2,{id:"reducing-variance",children:"Disabling ASLR"}),"\n",(0,s.jsx)(n.p,{children:"If you see this error:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"***WARNING*** ASLR is enabled, the results may have unreproducible noise in them.\n"})}),"\n",(0,s.jsx)(n.p,{children:"you might want to disable the ASLR security hardening feature while running the\nbenchmark."}),"\n",(0,s.jsx)(n.p,{children:"The simplest way is to add"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"benchmark::MaybeReenterWithoutASLR(argc, argv);\n"})}),"\n",(0,s.jsxs)(n.p,{children:["as the first line of your ",(0,s.jsx)(n.code,{children:"main()"})," function. It will try to disable ASLR\nfor the current processor, and, if successful, re-execute the binary.\nNote that ",(0,s.jsx)(n.code,{children:"personality(2)"})," may be forbidden by e.g. seccomp (which happens\nby default if you are running in a Docker container)."]}),"\n",(0,s.jsxs)(n.p,{children:["Note that if you link to ",(0,s.jsx)(n.code,{children:"benchmark_main"})," already does that for you."]}),"\n",(0,s.jsx)(n.p,{children:"To globally disable ASLR on Linux, run"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"echo 0 > /proc/sys/kernel/randomize_va_space\n"})}),"\n",(0,s.jsx)(n.p,{children:"To run a single benchmark with ASLR disabled on Linux, do:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"setarch `uname -m` -R ./a_benchmark\n"})}),"\n",(0,s.jsx)(n.p,{children:"Note that for the information on how to disable ASLR on other operating systems,\nplease refer to their documentation."}),"\n",(0,s.jsx)(n.h2,{id:"reducing-variance-in-benchmarks",children:"Reducing Variance in Benchmarks"}),"\n",(0,s.jsxs)(n.p,{children:["The Linux CPU frequency governor ",(0,s.jsx)(n.a,{href:"user_guide#disabling-cpu-frequency-scaling",children:"discussed\nabove"})," is not the only source\nof noise in benchmarks.  Some, but not all, of the sources of variance\ninclude:"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"On multi-core machines not all CPUs/CPU cores/CPU threads run the same\nspeed, so running a benchmark one time and then again may give a\ndifferent result depending on which CPU it ran on."}),"\n",(0,s.jsx)(n.li,{children:'CPU scaling features that run on the CPU, like Intel\'s Turbo Boost and\nAMD Turbo Core and Precision Boost, can temporarily change the CPU\nfrequency even when the using the "performance" governor on Linux.'}),"\n",(0,s.jsx)(n.li,{children:"Context switching between CPUs, or scheduling competition on the CPU the\nbenchmark is running on."}),"\n",(0,s.jsx)(n.li,{children:"Intel Hyperthreading or AMD SMT causing the same issue as above."}),"\n",(0,s.jsx)(n.li,{children:"Cache effects caused by code running on other CPUs."}),"\n",(0,s.jsx)(n.li,{children:"Non-uniform memory architectures (NUMA)."}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["These can cause variance in benchmarks results within a single run\n(",(0,s.jsx)(n.code,{children:"--benchmark_repetitions=N"}),") or across multiple runs of the benchmark\nprogram."]}),"\n",(0,s.jsx)(n.p,{children:"Reducing sources of variance is OS and architecture dependent, which is one\nreason some companies maintain machines dedicated to performance testing."}),"\n",(0,s.jsx)(n.p,{children:"Some of the easier and effective ways of reducing variance on a typical\nLinux workstation are:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Use the performance governor as ",(0,s.jsx)(n.a,{href:"user_guide#disabling-cpu-frequency-scaling",children:"discussed\nabove"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["Disable processor boosting by:","\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"echo 0 | sudo tee /sys/devices/system/cpu/cpufreq/boost\n"})}),"\n","See the Linux kernel's\n",(0,s.jsx)(n.a,{href:"https://www.kernel.org/doc/Documentation/cpu-freq/boost.txt",children:"boost.txt"}),"\nfor more information."]}),"\n",(0,s.jsxs)(n.li,{children:["Set the benchmark program's task affinity to a fixed cpu.  For example:","\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"taskset -c 0 ./mybenchmark\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["Increase the program's scheduling priority to minimize context switches using ",(0,s.jsx)(n.code,{children:"nice"})," or ",(0,s.jsx)(n.code,{children:"chrt"}),":","\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sh",children:"sudo nice -n -20 ./mybenchmark\nsudo chrt -f 80 ./mybenchmark\n"})}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["Disabling Hyperthreading/SMT.  This can be done in the Bios or using the\n",(0,s.jsx)(n.code,{children:"/sys"})," file system (see the LLVM project's ",(0,s.jsx)(n.a,{href:"https://llvm.org/docs/Benchmarking.html",children:"Benchmarking\ntips"}),")."]}),"\n",(0,s.jsx)(n.li,{children:"Close other programs that do non-trivial things based on timers, such as\nyour web browser, desktop environment, etc."}),"\n",(0,s.jsx)(n.li,{children:"Reduce the working set of your benchmark to fit within the L1 cache, but\ndo be aware that this may lead you to optimize for an unrealistic\nsituation."}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Further resources on this topic:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["The LLVM project's ",(0,s.jsx)(n.a,{href:"https://llvm.org/docs/Benchmarking.html",children:"Benchmarking\ntips"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["The Arch Wiki ",(0,s.jsx)(n.a,{href:"https://wiki.archlinux.org/title/CPU_frequency_scaling",children:"Cpu frequency\nscaling"})," page."]}),"\n"]})]})}function d(e={}){const{wrapper:n}={...(0,c.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(l,{...e})}):l(e)}}}]);