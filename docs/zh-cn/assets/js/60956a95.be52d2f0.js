"use strict";(globalThis.webpackChunkwebsite=globalThis.webpackChunkwebsite||[]).push([[8450],{7369:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>r,contentTitle:()=>l,default:()=>h,frontMatter:()=>o,metadata:()=>c,toc:()=>a});const c=JSON.parse('{"id":"testing/gt/gmock_cheat_sheet","title":"gMock Cheat Sheet","description":"Defining a Mock Class","source":"@site/docs/testing/gt/gmock_cheat_sheet.md","sourceDirName":"testing/gt","slug":"/testing/gt/gmock_cheat_sheet","permalink":"/cppdev/zh-cn/docs/testing/gt/gmock_cheat_sheet","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/testing/gt/gmock_cheat_sheet.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"gMock Cookbook","permalink":"/cppdev/zh-cn/docs/testing/gt/gmock_cook_book"},"next":{"title":"Testing Reference","permalink":"/cppdev/zh-cn/docs/testing/gt/reference/testing"}}');var s=t(4848),i=t(8453);const o={},l="gMock Cheat Sheet",r={},a=[{value:"Defining a Mock Class",id:"defining-a-mock-class",level:2},{value:"Mocking a Normal Class",id:"MockClass",level:3},{value:"Mocking a Class Template",id:"MockTemplate",level:3},{value:"Specifying Calling Conventions for Mock Functions",id:"specifying-calling-conventions-for-mock-functions",level:3},{value:"Using Mocks in Tests",id:"UsingMocks",level:2},{value:"Setting Default Actions",id:"OnCall",level:2},{value:"Setting Expectations",id:"ExpectCall",level:2},{value:"Matchers",id:"MatcherList",level:2},{value:"Actions",id:"ActionList",level:2},{value:"Cardinalities",id:"CardinalityList",level:2},{value:"Expectation Order",id:"expectation-order",level:2},{value:"Verifying and Resetting a Mock",id:"verifying-and-resetting-a-mock",level:2},{value:"Mock Classes",id:"mock-classes",level:2},{value:"Flags",id:"flags",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"gmock-cheat-sheet",children:"gMock Cheat Sheet"})}),"\n",(0,s.jsx)(n.h2,{id:"defining-a-mock-class",children:"Defining a Mock Class"}),"\n",(0,s.jsx)(n.h3,{id:"MockClass",children:"Mocking a Normal Class"}),"\n",(0,s.jsx)(n.p,{children:"Given"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cpp",children:"class Foo {\n public:\n  virtual ~Foo();\n  virtual int GetSize() const = 0;\n  virtual string Describe(const char* name) = 0;\n  virtual string Describe(int type) = 0;\n  virtual bool Process(Bar elem, int count) = 0;\n};\n"})}),"\n",(0,s.jsxs)(n.p,{children:["(note that ",(0,s.jsx)(n.code,{children:"~Foo()"})," ",(0,s.jsx)(n.strong,{children:"must"})," be virtual) we can define its mock as"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cpp",children:"#include <gmock/gmock.h>\n\nclass MockFoo : public Foo {\n public:\n  MOCK_METHOD(int, GetSize, (), (const, override));\n  MOCK_METHOD(string, Describe, (const char* name), (override));\n  MOCK_METHOD(string, Describe, (int type), (override));\n  MOCK_METHOD(bool, Process, (Bar elem, int count), (override));\n};\n"})}),"\n",(0,s.jsx)(n.p,{children:'To create a "nice" mock, which ignores all uninteresting calls, a "naggy" mock,\nwhich warns on all uninteresting calls, or a "strict" mock, which treats them as\nfailures:'}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cpp",children:"using ::testing::NiceMock;\nusing ::testing::NaggyMock;\nusing ::testing::StrictMock;\n\nNiceMock<MockFoo> nice_foo;      // The type is a subclass of MockFoo.\nNaggyMock<MockFoo> naggy_foo;    // The type is a subclass of MockFoo.\nStrictMock<MockFoo> strict_foo;  // The type is a subclass of MockFoo.\n"})}),"\n",(0,s.jsx)(n.admonition,{type:"info",children:(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Note:"})," A mock object is currently naggy by default. We may make it nice by\ndefault in the future."]})}),"\n",(0,s.jsx)(n.h3,{id:"MockTemplate",children:"Mocking a Class Template"}),"\n",(0,s.jsx)(n.p,{children:"Class templates can be mocked just like any class."}),"\n",(0,s.jsx)(n.p,{children:"To mock"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cpp",children:"template <typename Elem>\nclass StackInterface {\n public:\n  virtual ~StackInterface();\n  virtual int GetSize() const = 0;\n  virtual void Push(const Elem& x) = 0;\n};\n"})}),"\n",(0,s.jsxs)(n.p,{children:["(note that all member functions that are mocked, including ",(0,s.jsx)(n.code,{children:"~StackInterface()"}),"\n",(0,s.jsx)(n.strong,{children:"must"})," be virtual)."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cpp",children:"template <typename Elem>\nclass MockStack : public StackInterface<Elem> {\n public:\n  MOCK_METHOD(int, GetSize, (), (const, override));\n  MOCK_METHOD(void, Push, (const Elem& x), (override));\n};\n"})}),"\n",(0,s.jsx)(n.h3,{id:"specifying-calling-conventions-for-mock-functions",children:"Specifying Calling Conventions for Mock Functions"}),"\n",(0,s.jsxs)(n.p,{children:["If your mock function doesn't use the default calling convention, you can\nspecify it by adding ",(0,s.jsx)(n.code,{children:"Calltype(convention)"})," to ",(0,s.jsx)(n.code,{children:"MOCK_METHOD"}),"'s 4th parameter.\nFor example,"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cpp",children:"  MOCK_METHOD(bool, Foo, (int n), (Calltype(STDMETHODCALLTYPE)));\n  MOCK_METHOD(int, Bar, (double x, double y),\n              (const, Calltype(STDMETHODCALLTYPE)));\n"})}),"\n",(0,s.jsxs)(n.p,{children:["where ",(0,s.jsx)(n.code,{children:"STDMETHODCALLTYPE"})," is defined by ",(0,s.jsx)(n.code,{children:"<objbase.h>"})," on Windows."]}),"\n",(0,s.jsx)(n.h2,{id:"UsingMocks",children:"Using Mocks in Tests"}),"\n",(0,s.jsx)(n.p,{children:"The typical work flow is:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Import the gMock names you need to use. All gMock symbols are in the\n",(0,s.jsx)(n.code,{children:"testing"})," namespace unless they are macros or otherwise noted."]}),"\n",(0,s.jsx)(n.li,{children:"Create the mock objects."}),"\n",(0,s.jsx)(n.li,{children:"Optionally, set the default actions of the mock objects."}),"\n",(0,s.jsx)(n.li,{children:"Set your expectations on the mock objects (How will they be called? What\nwill they do?)."}),"\n",(0,s.jsx)(n.li,{children:"Exercise code that uses the mock objects; if necessary, check the result\nusing googletest assertions."}),"\n",(0,s.jsx)(n.li,{children:"When a mock object is destructed, gMock automatically verifies that all\nexpectations on it have been satisfied."}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Here's an example:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cpp",children:'using ::testing::Return;                          // #1\n\nTEST(BarTest, DoesThis) {\n  MockFoo foo;                                    // #2\n\n  ON_CALL(foo, GetSize())                         // #3\n      .WillByDefault(Return(1));\n  // ... other default actions ...\n\n  EXPECT_CALL(foo, Describe(5))                   // #4\n      .Times(3)\n      .WillRepeatedly(Return("Category 5"));\n  // ... other expectations ...\n\n  EXPECT_EQ(MyProductionFunction(&foo), "good");  // #5\n}                                                 // #6\n'})}),"\n",(0,s.jsx)(n.h2,{id:"OnCall",children:"Setting Default Actions"}),"\n",(0,s.jsxs)(n.p,{children:["gMock has a ",(0,s.jsx)(n.strong,{children:"built-in default action"})," for any function that returns ",(0,s.jsx)(n.code,{children:"void"}),",\n",(0,s.jsx)(n.code,{children:"bool"}),", a numeric value, or a pointer. In C++11, it additionally returns\nthe default-constructed value, if one exists for the given type."]}),"\n",(0,s.jsxs)(n.p,{children:["To customize the default action for functions with return type ",(0,s.jsx)(n.code,{children:"T"}),", use\n",(0,s.jsx)(n.a,{href:"/cppdev/zh-cn/docs/testing/gt/reference/mocking#DefaultValue",children:(0,s.jsx)(n.code,{children:"DefaultValue<T>"})}),". For example:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cpp",children:'  // Sets the default action for return type std::unique_ptr<Buzz> to\n  // creating a new Buzz every time.\n  DefaultValue<std::unique_ptr<Buzz>>::SetFactory(\n      [] { return std::make_unique<Buzz>(AccessLevel::kInternal); });\n\n  // When this fires, the default action of MakeBuzz() will run, which\n  // will return a new Buzz object.\n  EXPECT_CALL(mock_buzzer_, MakeBuzz("hello")).Times(AnyNumber());\n\n  auto buzz1 = mock_buzzer_.MakeBuzz("hello");\n  auto buzz2 = mock_buzzer_.MakeBuzz("hello");\n  EXPECT_NE(buzz1, nullptr);\n  EXPECT_NE(buzz2, nullptr);\n  EXPECT_NE(buzz1, buzz2);\n\n  // Resets the default action for return type std::unique_ptr<Buzz>,\n  // to avoid interfere with other tests.\n  DefaultValue<std::unique_ptr<Buzz>>::Clear();\n'})}),"\n",(0,s.jsxs)(n.p,{children:["To customize the default action for a particular method of a specific mock\nobject, use ",(0,s.jsx)(n.a,{href:"/cppdev/zh-cn/docs/testing/gt/reference/mocking#ON_CALL",children:(0,s.jsx)(n.code,{children:"ON_CALL"})}),". ",(0,s.jsx)(n.code,{children:"ON_CALL"})," has a similar\nsyntax to ",(0,s.jsx)(n.code,{children:"EXPECT_CALL"}),", but it is used for setting default behaviors when you\ndo not require that the mock method is called. See\n",(0,s.jsx)(n.a,{href:"/cppdev/zh-cn/docs/testing/gt/gmock_cook_book#UseOnCall",children:"Knowing When to Expect"})," for a more detailed\ndiscussion."]}),"\n",(0,s.jsx)(n.h2,{id:"ExpectCall",children:"Setting Expectations"}),"\n",(0,s.jsxs)(n.p,{children:["See ",(0,s.jsx)(n.a,{href:"/cppdev/zh-cn/docs/testing/gt/reference/mocking#EXPECT_CALL",children:(0,s.jsx)(n.code,{children:"EXPECT_CALL"})})," in the Mocking Reference."]}),"\n",(0,s.jsx)(n.h2,{id:"MatcherList",children:"Matchers"}),"\n",(0,s.jsxs)(n.p,{children:["See the ",(0,s.jsx)(n.a,{href:"/cppdev/zh-cn/docs/testing/gt/reference/matchers",children:"Matchers Reference"}),"."]}),"\n",(0,s.jsx)(n.h2,{id:"ActionList",children:"Actions"}),"\n",(0,s.jsxs)(n.p,{children:["See the ",(0,s.jsx)(n.a,{href:"/cppdev/zh-cn/docs/testing/gt/reference/actions",children:"Actions Reference"}),"."]}),"\n",(0,s.jsx)(n.h2,{id:"CardinalityList",children:"Cardinalities"}),"\n",(0,s.jsxs)(n.p,{children:["See the ",(0,s.jsxs)(n.a,{href:"/cppdev/zh-cn/docs/testing/gt/reference/mocking#EXPECT_CALL.Times",children:[(0,s.jsx)(n.code,{children:"Times"})," clause"]})," of\n",(0,s.jsx)(n.code,{children:"EXPECT_CALL"})," in the Mocking Reference."]}),"\n",(0,s.jsx)(n.h2,{id:"expectation-order",children:"Expectation Order"}),"\n",(0,s.jsxs)(n.p,{children:["By default, expectations can be matched in ",(0,s.jsx)(n.em,{children:"any"})," order. If some or all\nexpectations must be matched in a given order, you can use the\n",(0,s.jsxs)(n.a,{href:"/cppdev/zh-cn/docs/testing/gt/reference/mocking#EXPECT_CALL.After",children:[(0,s.jsx)(n.code,{children:"After"})," clause"]})," or\n",(0,s.jsxs)(n.a,{href:"/cppdev/zh-cn/docs/testing/gt/reference/mocking#EXPECT_CALL.InSequence",children:[(0,s.jsx)(n.code,{children:"InSequence"})," clause"]})," of\n",(0,s.jsx)(n.code,{children:"EXPECT_CALL"}),", or use an ",(0,s.jsxs)(n.a,{href:"/cppdev/zh-cn/docs/testing/gt/reference/mocking#InSequence",children:[(0,s.jsx)(n.code,{children:"InSequence"})," object"]}),"."]}),"\n",(0,s.jsx)(n.h2,{id:"verifying-and-resetting-a-mock",children:"Verifying and Resetting a Mock"}),"\n",(0,s.jsx)(n.p,{children:"gMock will verify the expectations on a mock object when it is destructed, or\nyou can do it earlier:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cpp",children:"using ::testing::Mock;\n...\n// Verifies and removes the expectations on mock_obj;\n// returns true if and only if successful.\nMock::VerifyAndClearExpectations(&mock_obj);\n...\n// Verifies and removes the expectations on mock_obj;\n// also removes the default actions set by ON_CALL();\n// returns true if and only if successful.\nMock::VerifyAndClear(&mock_obj);\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Do not set new expectations after verifying and clearing a mock after its use.\nSetting expectations after code that exercises the mock has undefined behavior.\nSee ",(0,s.jsx)(n.a,{href:"/cppdev/zh-cn/docs/testing/gt/gmock_for_dummies#using-mocks-in-tests",children:"Using Mocks in Tests"})," for more\ninformation."]}),"\n",(0,s.jsx)(n.p,{children:"You can also tell gMock that a mock object can be leaked and doesn't need to be\nverified:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cpp",children:"Mock::AllowLeak(&mock_obj);\n"})}),"\n",(0,s.jsx)(n.h2,{id:"mock-classes",children:"Mock Classes"}),"\n",(0,s.jsx)(n.p,{children:"gMock defines a convenient mock class template"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cpp",children:"class MockFunction<R(A1, ..., An)> {\n public:\n  MOCK_METHOD(R, Call, (A1, ..., An));\n};\n"})}),"\n",(0,s.jsxs)(n.p,{children:["See this ",(0,s.jsx)(n.a,{href:"/cppdev/zh-cn/docs/testing/gt/gmock_cook_book#UsingCheckPoints",children:"recipe"})," for one application of\nit."]}),"\n",(0,s.jsx)(n.h2,{id:"flags",children:"Flags"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{style:{textAlign:"left"},children:"Flag"}),(0,s.jsx)(n.th,{style:{textAlign:"left"},children:"Description"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{style:{textAlign:"left"},children:(0,s.jsx)(n.code,{children:"--gmock_catch_leaked_mocks=0"})}),(0,s.jsx)(n.td,{style:{textAlign:"left"},children:"Don't report leaked mock objects as failures."})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{style:{textAlign:"left"},children:(0,s.jsx)(n.code,{children:"--gmock_verbose=LEVEL"})}),(0,s.jsxs)(n.td,{style:{textAlign:"left"},children:["Sets the default verbosity level (",(0,s.jsx)(n.code,{children:"info"}),", ",(0,s.jsx)(n.code,{children:"warning"}),", or ",(0,s.jsx)(n.code,{children:"error"}),") of Google Mock messages."]})]})]})]})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>l});var c=t(6540);const s={},i=c.createContext(s);function o(e){const n=c.useContext(i);return c.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),c.createElement(i.Provider,{value:n},e.children)}}}]);