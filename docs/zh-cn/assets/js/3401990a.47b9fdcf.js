"use strict";(globalThis.webpackChunkwebsite=globalThis.webpackChunkwebsite||[]).push([[4596],{3545:(e,n,l)=>{l.r(n),l.d(n,{assets:()=>r,contentTitle:()=>s,default:()=>u,frontMatter:()=>d,metadata:()=>a,toc:()=>c});const a=JSON.parse('{"id":"foundamentals/monitor/metrics","title":"\u6307\u6807\uff08Metrics\uff09","description":"\u672c\u8282\u4ecb\u7ecd\u53ef\u901a\u8fc7 Prometheus \u6536\u96c6\u7684\u76d1\u63a7\u6307\u6807\uff0c\u5305\u62ec Counter\u3001Gauge \u548c Histogram\u3002","source":"@site/i18n/zh-cn/docusaurus-plugin-content-docs/current/foundamentals/monitor/metrics.mdx","sourceDirName":"foundamentals/monitor","slug":"/foundamentals/monitor/metrics","permalink":"/cppdev/zh-cn/docs/foundamentals/monitor/metrics","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"\u53d8\u91cf\uff08Variables\uff09","permalink":"/cppdev/zh-cn/docs/foundamentals/monitor/var"},"next":{"title":"\u7cfb\u7edf\u76d1\u63a7\uff08System Monitoring\uff09","permalink":"/cppdev/zh-cn/docs/foundamentals/monitor/sys"}}');var t=l(4848),i=l(8453);const d={},s="\u6307\u6807\uff08Metrics\uff09",r={},c=[{value:"tally::Counter",id:"tallycounter",level:2},{value:"tally::MaxerGauge",id:"tallymaxergauge",level:2},{value:"tally::MinerGauge",id:"tallyminergauge",level:2},{value:"tally::AverageGauge",id:"tallyaveragegauge",level:2},{value:"tally::LatencyRecorder",id:"tallylatencyrecorder",level:2},{value:"tally::Window",id:"tallywindow",level:2},{value:"\u4f7f\u7528 tally::Window",id:"\u4f7f\u7528-tallywindow",level:3},{value:"tally::PerSecond",id:"tallypersecond",level:2},{value:"\u4e0e Window \u7684\u533a\u522b",id:"\u4e0e-window-\u7684\u533a\u522b",level:3},{value:"tally::WindowEx",id:"tallywindowex",level:2},{value:"\u4f7f\u7528 tally::WindowEx",id:"\u4f7f\u7528-tallywindowex",level:3},{value:"tally::WindowEx \u4e0e tally::Window \u7684\u533a\u522b",id:"tallywindowex-\u4e0e-tallywindow-\u7684\u533a\u522b",level:3},{value:"tally::PerSecondEx",id:"tallypersecondex",level:2},{value:"\u4f7f\u7528 tally::PerSecondEx",id:"\u4f7f\u7528-tallypersecondex",level:3},{value:"tally::PerSecondEx \u4e0e tally::WindowEx \u7684\u533a\u522b",id:"tallypersecondex-\u4e0e-tallywindowex-\u7684\u533a\u522b",level:3},{value:"tally::PerSecondEx \u4e0e tally::PerSecond \u7684\u533a\u522b",id:"tallypersecondex-\u4e0e-tallypersecond-\u7684\u533a\u522b",level:3},{value:"tally::Status",id:"tallystatus",level:2},{value:"tally::FuncGauge",id:"tallyfuncgauge",level:2}];function o(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"\u6307\u6807metrics",children:"\u6307\u6807\uff08Metrics\uff09"})}),"\n",(0,t.jsxs)(n.p,{children:["\u672c\u8282\u4ecb\u7ecd\u53ef\u901a\u8fc7 Prometheus \u6536\u96c6\u7684\u76d1\u63a7\u6307\u6807\uff0c\u5305\u62ec ",(0,t.jsx)(n.code,{children:"Counter"}),"\u3001",(0,t.jsx)(n.code,{children:"Gauge"})," \u548c ",(0,t.jsx)(n.code,{children:"Histogram"}),"\u3002"]}),"\n",(0,t.jsx)(n.h2,{id:"tallycounter",children:"tally::Counter"}),"\n",(0,t.jsxs)(n.p,{children:["\u987e\u540d\u601d\u4e49\uff0c\u7528\u4e8e\u7d2f\u52a0\uff0c\u8fd0\u7b97\u7b26\u4e3a ",(0,t.jsx)(n.code,{children:"+"}),"\u3002"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-c++",children:"tally::Counter<int> value;\nvalue << 1 << 2 << 3 << -4;\nCHECK_EQ(2, value.get_value());\n\ntally::Counter<double> fp_value;  // \u53ef\u80fd\u4f1a\u4ea7\u751f\u8b66\u544a\nfp_value << 1.0 << 2.0 << 3.0 << -4.0;\nCHECK_DOUBLE_EQ(2.0, fp_value.get_value());\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"Counter<>"})," \u53ef\u4ee5\u4e0e\u975e\u539f\u751f\u7c7b\u578b\u4e00\u8d77\u4f7f\u7528\uff0c\u524d\u63d0\u662f\u8be5\u7c7b\u578b\u81f3\u5c11\u91cd\u8f7d\u4e86 ",(0,t.jsx)(n.code,{children:"T operator+(T, T)"}),"\u3002\u73b0\u6709\u793a\u4f8b\u662f ",(0,t.jsx)(n.code,{children:"std::string"}),"\uff0c\u4e0b\u9762\u7684\u4ee3\u7801\u5b9e\u73b0\u5b57\u7b26\u4e32\u62fc\u63a5\uff1a"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-c++",children:'// \u4ec5\u7528\u4e8e\u6982\u5ff5\u9a8c\u8bc1\uff0c\u4e0d\u5efa\u8bae\u7528\u4e8e\u751f\u4ea7\u4ee3\u7801\uff0c\u56e0\u4e3a\u4f1a\u751f\u6210\u5927\u91cf\u4e34\u65f6\u5b57\u7b26\u4e32\uff0c\u6548\u7387\u4f4e\u4e0b\u3002\u751f\u4ea7\u4e2d\u5e94\u4f7f\u7528 std::ostringstream\u3002\ntally::Counter<std::string> concater;\nstd::string str1 = "world";\nconcater << "hello " << str1;\nCHECK_EQ("hello world", concater.get_value());\n'})}),"\n",(0,t.jsx)(n.h2,{id:"tallymaxergauge",children:"tally::MaxerGauge"}),"\n",(0,t.jsxs)(n.p,{children:["\u7528\u4e8e\u83b7\u53d6\u6700\u5927\u503c\uff0c\u8fd0\u7b97\u7b26\u4e3a ",(0,t.jsx)(n.code,{children:"std::max"}),"\u3002"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-c++",children:"tally::MaxerGauge<int> value;\nvalue << 1 << 2 << 3 << -4;\nCHECK_EQ(3, value.get_value());\n"})}),"\n",(0,t.jsxs)(n.p,{children:["\u7531\u4e8e ",(0,t.jsx)(n.code,{children:"MaxerGauge<>"})," \u4f7f\u7528 ",(0,t.jsx)(n.code,{children:"std::numeric_limits<T>::min()"})," \u4f5c\u4e3a\u521d\u59cb\u503c\uff0c\u56e0\u6b64\u4e0d\u80fd\u76f4\u63a5\u7528\u4e8e\u6cdb\u578b\u7c7b\u578b\uff0c\u9664\u975e\u5bf9 ",(0,t.jsx)(n.code,{children:"std::numeric_limits<>"})," \u8fdb\u884c\u7279\u5316\uff08\u5e76\u91cd\u8f7d ",(0,t.jsx)(n.code,{children:"operator<"}),"\uff0c\u6ce8\u610f\u4e0d\u662f ",(0,t.jsx)(n.code,{children:"operator>"}),"\uff09\u3002"]}),"\n",(0,t.jsx)(n.h2,{id:"tallyminergauge",children:"tally::MinerGauge"}),"\n",(0,t.jsxs)(n.p,{children:["\u7528\u4e8e\u83b7\u53d6\u6700\u5c0f\u503c\uff0c\u8fd0\u7b97\u7b26\u4e3a ",(0,t.jsx)(n.code,{children:"std::min"}),"\u3002"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-c++",children:"tally::MinerGauge<int> value;\nvalue << 1 << 2 << 3 << -4;\nCHECK_EQ(-4, value.get_value());\n"})}),"\n",(0,t.jsxs)(n.p,{children:["\u7531\u4e8e ",(0,t.jsx)(n.code,{children:"MinerGauge<>"})," \u4f7f\u7528 ",(0,t.jsx)(n.code,{children:"std::numeric_limits<T>::max()"})," \u4f5c\u4e3a\u521d\u59cb\u503c\uff0c\u56e0\u6b64\u4e0d\u80fd\u76f4\u63a5\u7528\u4e8e\u6cdb\u578b\u7c7b\u578b\uff0c\u9664\u975e\u5bf9 ",(0,t.jsx)(n.code,{children:"std::numeric_limits<>"})," \u8fdb\u884c\u7279\u5316\uff08\u5e76\u91cd\u8f7d ",(0,t.jsx)(n.code,{children:"operator<"}),"\uff09\u3002"]}),"\n",(0,t.jsx)(n.h2,{id:"tallyaveragegauge",children:"tally::AverageGauge"}),"\n",(0,t.jsx)(n.p,{children:"\u7528\u4e8e\u8ba1\u7b97\u5e73\u5747\u503c\u3002"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-c++",children:"// \u7528\u4e8e\u8ba1\u7b97\u6570\u5b57\u7684\u5e73\u5747\u503c\n// \u793a\u4f8b\uff1a\n//   AverageGauge latency;\n//   latency << 1 << 3 << 5;\n//   CHECK_EQ(3, latency.average());\nclass AverageGauge : public Variable;\n"})}),"\n",(0,t.jsx)(n.h2,{id:"tallylatencyrecorder",children:"tally::LatencyRecorder"}),"\n",(0,t.jsxs)(n.p,{children:["\u4e13\u7528\u4e8e\u8ba1\u7b97\u5ef6\u8fdf\u548c QPS\uff08\u6bcf\u79d2\u67e5\u8be2\u6570\uff09\u7684\u8ba1\u6570\u5668\u3002\u53ea\u9700\u8f93\u5165\u5ef6\u8fdf\u6570\u636e\u5373\u53ef\u5f97\u5230 latency / max_latency / QPS / count\u3002\u7edf\u8ba1\u7a97\u53e3\u7531\u6700\u540e\u4e00\u4e2a\u53c2\u6570\u6307\u5b9a\uff0c\u82e5\u7701\u7565\u5219\u9ed8\u8ba4\u4e3a ",(0,t.jsx)(n.code,{children:"tally_dump_interval"}),"\uff08\u6b64\u5904\u672a\u63d0\u4f9b\uff09\u3002"]}),"\n",(0,t.jsxs)(n.p,{children:["\u6ce8\u610f\uff1a",(0,t.jsx)(n.code,{children:"LatencyRecorder"})," \u4e0d\u7ee7\u627f\u81ea ",(0,t.jsx)(n.code,{children:"Variable"}),"\uff0c\u800c\u662f\u591a\u4e2a ",(0,t.jsx)(n.code,{children:"tally"})," \u7ec4\u4ef6\u7684\u7ec4\u5408\u3002"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-c++",children:'LatencyRecorder write_latency("table2_my_table_write");  // \u751f\u6210 4 \u4e2a\u53d8\u91cf\uff1a\n                                                         //   table2_my_table_write_latency\n                                                         //   table2_my_table_write_max_latency\n                                                         //   table2_my_table_write_qps\n                                                         //   table2_my_table_write_count\n// \u5728\u5199\u5165\u51fd\u6570\u4e2d\nwrite_latency << the_latency_of_write;\n'})}),"\n",(0,t.jsx)(n.h2,{id:"tallywindow",children:"tally::Window"}),"\n",(0,t.jsxs)(n.p,{children:["\u4ece\u6307\u5b9a\u8fc7\u53bb\u65f6\u95f4\u7a97\u53e3\u83b7\u53d6\u7edf\u8ba1\u503c\u3002",(0,t.jsx)(n.code,{children:"Window"})," \u4e0d\u80fd\u72ec\u7acb\u5b58\u5728\uff0c\u5fc5\u987b\u4f9d\u8d56\u5df2\u6709\u8ba1\u6570\u5668\u3002",(0,t.jsx)(n.code,{children:"Window"})," \u4f1a\u81ea\u52a8\u66f4\u65b0\uff0c\u65e0\u9700\u663e\u5f0f\u8f93\u5165\u6570\u636e\u3002\u4e3a\u6027\u80fd\u8003\u8651\uff0c",(0,t.jsx)(n.code,{children:"Window"})," \u7684\u6570\u636e\u6bcf\u79d2\u4ece\u539f\u59cb\u8ba1\u6570\u5668\u91c7\u6837\u4e00\u6b21\uff0c\u6700\u574f\u60c5\u51b5\u4e0b\u8fd4\u56de\u503c\u7684\u6700\u5927\u5ef6\u8fdf\u4e3a 1 \u79d2\u3002"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-c++",children:"// \u83b7\u53d6\u65f6\u95f4\u7a97\u53e3\u5185\u7684\u6570\u636e\uff0c\u65f6\u95f4\u5355\u4f4d\u56fa\u5b9a\u4e3a 1 \u79d2\n// Window \u4f9d\u8d56\u4e8e\u53e6\u4e00\u4e2a tally\uff0c\u8be5 tally \u5fc5\u987b\u5728 window \u6784\u9020\u4e4b\u524d\u521b\u5efa\uff0c\u5e76\u5728 window \u9500\u6bc1\u4e4b\u540e\u9500\u6bc1\u3002\n// R \u5fc5\u987b\uff1a\n// - \u63d0\u4f9b get_sampler()\uff08\u7ebf\u7a0b\u5b89\u5168\u4e0d\u8981\u6c42\uff09\n// - \u5b9a\u4e49 value_type \u548c sampler_type\ntemplate <typename R>\nclass Window : public Variable;\n"})}),"\n",(0,t.jsx)(n.h3,{id:"\u4f7f\u7528-tallywindow",children:"\u4f7f\u7528 tally::Window"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-c++",children:"tally::Counter<int> sum;\ntally::MaxerGauge<int> max_value;\ntally::IntRecorder avg_value;\n\n// sum_minute.get_value() \u8fd4\u56de\u8fc7\u53bb 60 \u79d2\u5185 sum \u7684\u7d2f\u79ef\u503c\ntally::Window<tally::Counter<int> > sum_minute(&sum, 60);\n\n// max_value_minute.get_value() \u8fd4\u56de\u8fc7\u53bb 60 \u79d2\u5185 max_value \u7684\u6700\u5927\u503c\ntally::Window<tally::MaxerGauge<int> > max_value_minute(&max_value, 60);\n\n// avg_value_minute.get_value() \u8fd4\u56de\u8fc7\u53bb 60 \u79d2\u5185 avg_value \u7684\u5e73\u5747\u503c\ntally::Window<IntRecorder> avg_value_minute(&avg_value, 60);\n"})}),"\n",(0,t.jsx)(n.h2,{id:"tallypersecond",children:"tally::PerSecond"}),"\n",(0,t.jsxs)(n.p,{children:["\u4ece\u6307\u5b9a\u8fc7\u53bb\u65f6\u95f4\u7a97\u53e3\u83b7\u53d6\u6bcf\u79d2\u5e73\u5747\u7edf\u8ba1\u503c\u3002\u5176\u672c\u8d28\u4e0e ",(0,t.jsx)(n.code,{children:"Window"})," \u76f8\u540c\uff0c\u4f46\u8fd4\u56de\u503c\u4f1a\u9664\u4ee5\u65f6\u95f4\u7a97\u53e3\u957f\u5ea6\u3002"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-c++",children:"tally::Counter<int> sum;\n\n// sum_per_second.get_value() \u8fd4\u56de\u8fc7\u53bb 60 \u79d2\u5185 sum \u7684\u6bcf\u79d2\u5e73\u5747\u7d2f\u79ef\u503c\ntally::PerSecond<tally::Counter<int> > sum_per_second(&sum, 60);\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"PerSecond \u5e76\u975e\u603b\u662f\u6709\u610f\u4e49"})}),"\n",(0,t.jsxs)(n.p,{children:["\u4e0a\u4f8b\u672a\u5305\u542b ",(0,t.jsx)(n.code,{children:"MaxerGauge"}),"\uff0c\u56e0\u4e3a\u5c06\u65f6\u95f4\u7a97\u53e3\u5185\u7684\u6700\u5927\u503c\u9664\u4ee5\u65f6\u95f4\u6ca1\u6709\u610f\u4e49\u3002"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-c++",children:"tally::MaxerGauge<int> max_value;\n\n// \u9519\u8bef\u793a\u4f8b\uff1a\u5c06\u6700\u5927\u503c\u9664\u4ee5\u65f6\u95f4\u6ca1\u6709\u610f\u4e49\ntally::PerSecond<tally::MaxerGauge<int> > max_value_per_second_wrong(&max_value);\n\n// \u6b63\u786e\u505a\u6cd5\uff1a\u5c06 Window \u7684\u65f6\u95f4\u7a97\u53e3\u8bbe\u7f6e\u4e3a 1 \u79d2\ntally::Window<tally::MaxerGauge<int> > max_value_per_second(&max_value, 1);\n"})}),"\n",(0,t.jsx)(n.h3,{id:"\u4e0e-window-\u7684\u533a\u522b",children:"\u4e0e Window \u7684\u533a\u522b"}),"\n",(0,t.jsx)(n.p,{children:"\u4f8b\u5982\uff0c\u7edf\u8ba1\u8fc7\u53bb\u4e00\u5206\u949f\u5185\u5185\u5b58\u53d8\u5316\uff1a"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\u4f7f\u7528 ",(0,t.jsx)(n.code,{children:"Window<>"}),"\uff0c\u8fd4\u56de\u503c\u8868\u793a\u201c\u8fc7\u53bb\u4e00\u5206\u949f\u5185\u5185\u5b58\u589e\u52a0\u4e86 18MB\u201d"]}),"\n",(0,t.jsxs)(n.li,{children:["\u4f7f\u7528 ",(0,t.jsx)(n.code,{children:"PerSecond<>"}),"\uff0c\u8fd4\u56de\u503c\u8868\u793a\u201c\u8fc7\u53bb\u4e00\u5206\u949f\u5185\u5e73\u5747\u6bcf\u79d2\u589e\u52a0 0.3MB\u201d"]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"Window"})," \u7684\u4f18\u52bf\u662f\u63d0\u4f9b\u7cbe\u786e\u503c\uff0c\u9002\u5408\u5c0f\u91cf\u7edf\u8ba1\uff08\u5982\u201c\u8fc7\u53bb\u4e00\u5206\u949f\u7684\u9519\u8bef\u6570\u201d\uff09\u3002\u7528 ",(0,t.jsx)(n.code,{children:"PerSecond"})," \u4f1a\u5f97\u5230\u201c\u8fc7\u53bb\u4e00\u5206\u949f\u6bcf\u79d2 0.0167 \u4e2a\u9519\u8bef\u201d\uff0c\u663e\u7136\u4e0d\u5982\u201c\u8fc7\u53bb\u4e00\u5206\u949f 1 \u4e2a\u9519\u8bef\u201d\u76f4\u89c2\u3002\u6b64\u5916\uff0c\u65f6\u95f4\u65e0\u5173\u7684\u6307\u6807\u5e94\u4f7f\u7528 ",(0,t.jsx)(n.code,{children:"Window"}),"\u3002\u4f8b\u5982\u8ba1\u7b97\u8fc7\u53bb\u4e00\u5206\u949f CPU \u5229\u7528\u7387\uff1a\u4f7f\u7528 ",(0,t.jsx)(n.code,{children:"Counter"})," \u7d2f\u79ef CPU \u65f6\u95f4\u548c\u771f\u5b9e\u65f6\u95f4\uff0c\u7136\u540e\u7528 ",(0,t.jsx)(n.code,{children:"Window"})," \u83b7\u53d6\u8fc7\u53bb\u4e00\u5206\u949f\u7684 CPU \u65f6\u95f4\u4e0e\u771f\u5b9e\u65f6\u95f4\uff0c\u518d\u76f8\u9664\u5f97\u5230 CPU \u5229\u7528\u7387\u2014\u2014\u8fd9\u662f\u65f6\u95f4\u65e0\u5173\u7684\uff0c\u7528 ",(0,t.jsx)(n.code,{children:"PerSecond"})," \u4f1a\u5f97\u5230\u9519\u8bef\u7ed3\u679c\u3002"]}),"\n",(0,t.jsx)(n.h2,{id:"tallywindowex",children:"tally::WindowEx"}),"\n",(0,t.jsxs)(n.p,{children:["\u4ece\u6307\u5b9a\u8fc7\u53bb\u65f6\u95f4\u7a97\u53e3\u83b7\u53d6\u7edf\u8ba1\u503c\u3002",(0,t.jsx)(n.code,{children:"WindowEx"})," \u72ec\u7acb\u5b58\u5728\uff0c\u4e0d\u4f9d\u8d56\u5176\u4ed6\u8ba1\u6570\u5668\uff0c\u9700\u8981\u663e\u5f0f\u8f93\u5165\u6570\u636e\u3002\u4e3a\u6027\u80fd\u8003\u8651\uff0c",(0,t.jsx)(n.code,{children:"WindowEx"})," \u6bcf\u79d2\u6c47\u603b\u4e00\u6b21\u6570\u636e\uff0c\u6700\u574f\u60c5\u51b5\u4e0b\u8fd4\u56de\u503c\u5ef6\u8fdf\u6700\u5927\u4e3a 1 \u79d2\u3002"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-c++",children:"// \u83b7\u53d6\u65f6\u95f4\u7a97\u53e3\u5185\u7684\u6570\u636e\uff0c\u65f6\u95f4\u5355\u4f4d\u56fa\u5b9a\u4e3a 1 \u79d2\n// WindowEx \u4e0d\u4f9d\u8d56\u5176\u4ed6 tally \u7ec4\u4ef6\n\n// R \u5fc5\u987b\uff1a\n// - window_size \u5fc5\u987b\u662f\u5e38\u91cf\ntemplate <typename R, time_t window_size = 0>\nclass WindowEx : public adapter::WindowExAdapter<R, adapter::WindowExType<R> > {\npublic:\n    typedef adapter::WindowExAdapter<R, adapter::WindowExType<R> > Base;\n\n    WindowEx() : Base(window_size) {}\n\n    WindowEx(const base::StringPiece& name) : Base(window_size) {\n        this->expose(name);\n    }\n\n    WindowEx(const base::StringPiece& prefix,\n             const base::StringPiece& name)\n        : Base(window_size) {\n        this->expose_as(prefix, name);\n    }\n};\n"})}),"\n",(0,t.jsx)(n.h3,{id:"\u4f7f\u7528-tallywindowex",children:"\u4f7f\u7528 tally::WindowEx"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-c++",children:'const int window_size = 60;\n\n// sum_minute.get_value() \u8fd4\u56de 60 \u79d2\u5185\u7d2f\u79ef\u503c\ntally::WindowEx<tally::Counter<int>, window_size> sum_minute("sum_minute");\nsum_minute << 1 << 2 << 3;\n\n// max_minute.get_value() \u8fd4\u56de 60 \u79d2\u5185\u6700\u5927\u503c\ntally::WindowEx<tally::MaxerGauge<int>, window_size> max_minute("max_minute");\nmax_minute << 1 << 2 << 3;\n\n// min_minute.get_value() \u8fd4\u56de 60 \u79d2\u5185\u6700\u5c0f\u503c\ntally::WindowEx<tally::MinerGauge<int>, window_size> min_minute("min_minute");\nmin_minute << 1 << 2 << 3;\n\n// avg_minute.get_value() \u8fd4\u56de 60 \u79d2\u5185\u5e73\u5747\u503c\uff08\u8fd4\u56de tally::Stat\uff09\n// window_size \u53c2\u6570\u7701\u7565\u65f6\uff0c\u9ed8\u8ba4\u4e3a tally_dump_interval\ntally::WindowEx<tally::IntRecorder, window_size> avg_minute("avg_minute");\navg_minute << 1 << 2 << 3;\n\n// \u83b7\u53d6 avg_minute 60 \u79d2\u5e73\u5747\u7edf\u8ba1\ntally::Stat avg_stat = avg_minute.get_value();\n// \u83b7\u53d6\u6574\u6570\u5e73\u5747\u503c\nint64_t avg_int = avg_stat.get_average_int();\n// \u83b7\u53d6\u53cc\u7cbe\u5ea6\u5e73\u5747\u503c\ndouble avg_double = avg_stat.get_average_double();\n'})}),"\n",(0,t.jsx)(n.h3,{id:"tallywindowex-\u4e0e-tallywindow-\u7684\u533a\u522b",children:"tally::WindowEx \u4e0e tally::Window \u7684\u533a\u522b"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"tally::Window"})," \u4e0d\u80fd\u72ec\u7acb\u5b58\u5728\uff0c\u5fc5\u987b\u4f9d\u8d56\u5df2\u6709\u8ba1\u6570\u5668\u3002\u5b83\u81ea\u52a8\u66f4\u65b0\uff0c\u65e0\u9700\u663e\u5f0f\u8f93\u5165\u6570\u636e\uff1b",(0,t.jsx)(n.code,{children:"window_size"})," \u901a\u8fc7\u6784\u9020\u51fd\u6570\u4f20\u5165"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"tally::WindowEx"})," \u72ec\u7acb\u5b58\u5728\uff0c\u4e0d\u4f9d\u8d56\u5176\u4ed6\u8ba1\u6570\u5668\uff0c\u9700\u8981\u663e\u5f0f\u8f93\u5165\u6570\u636e\uff08\u4f7f\u7528\u66f4\u65b9\u4fbf\uff09\uff1b",(0,t.jsx)(n.code,{children:"window_size"})," \u901a\u8fc7\u6a21\u677f\u53c2\u6570\u4f20\u5165\uff0c\u7701\u7565\u65f6\u9ed8\u8ba4\u4e3a ",(0,t.jsx)(n.code,{children:"tally_dump_interval"})]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"tallypersecondex",children:"tally::PerSecondEx"}),"\n",(0,t.jsxs)(n.p,{children:["\u4ece\u6307\u5b9a\u8fc7\u53bb\u65f6\u95f4\u7a97\u53e3\u83b7\u53d6\u6bcf\u79d2\u5e73\u5747\u7edf\u8ba1\u503c\uff0c\u672c\u8d28\u4e0e ",(0,t.jsx)(n.code,{children:"WindowEx"})," \u76f8\u540c\uff0c\u4f46\u8fd4\u56de\u503c\u9664\u4ee5\u65f6\u95f4\u7a97\u53e3\u957f\u5ea6\u3002"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-c++",children:"// \u83b7\u53d6\u65f6\u95f4\u7a97\u53e3\u5185\u6bcf\u79d2\u7684\u6570\u636e\n// PerSecondEx \u4e0e WindowEx \u7684\u552f\u4e00\u533a\u522b\uff1aPerSecondEx \u5c06\u6c47\u603b\u6570\u636e\u9664\u4ee5\u65f6\u95f4\u7a97\u53e3\u957f\u5ea6\n\n// R \u5fc5\u987b\uff1a\n// - window_size \u5fc5\u987b\u662f\u5e38\u91cf\ntemplate <typename R, time_t window_size = 0>\nclass PerSecondEx : public adapter::WindowExAdapter<R, adapter::PerSecondExType<R> > {\npublic:\n    typedef adapter::WindowExAdapter<R, adapter::PerSecondExType<R> > Base;\n\n    PerSecondEx() : Base(window_size) {}\n\n    PerSecondEx(const base::StringPiece& name) : Base(window_size) {\n        this->expose(name);\n    }\n\n    PerSecondEx(const base::StringPiece& prefix,\n                const base::StringPiece& name)\n        : Base(window_size) {\n        this->expose_as(prefix, name);\n    }\n};\n"})}),"\n",(0,t.jsx)(n.h3,{id:"\u4f7f\u7528-tallypersecondex",children:"\u4f7f\u7528 tally::PerSecondEx"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-c++",children:'const int window_size = 60;\n\n// sum_per_second.get_value() \u8fd4\u56de\u8fc7\u53bb 60 \u79d2\u6bcf\u79d2\u5e73\u5747\u7d2f\u79ef\u503c\ntally::PerSecondEx<tally::Counter<int>, window_size> sum_per_second("sum_per_second");\nsum_per_second << 1 << 2 << 3;\n'})}),"\n",(0,t.jsx)(n.h3,{id:"tallypersecondex-\u4e0e-tallywindowex-\u7684\u533a\u522b",children:"tally::PerSecondEx \u4e0e tally::WindowEx \u7684\u533a\u522b"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"tally::PerSecondEx"})," \u83b7\u53d6\u6307\u5b9a\u65f6\u95f4\u7a97\u53e3\u5185\u7684\u6bcf\u79d2\u5e73\u5747\u503c\uff0c\u672c\u8d28\u4e0e ",(0,t.jsx)(n.code,{children:"WindowEx"})," \u76f8\u540c\uff0c\u4f46\u8fd4\u56de\u503c\u9664\u4ee5\u65f6\u95f4\u7a97\u53e3\u957f\u5ea6"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"tallypersecondex-\u4e0e-tallypersecond-\u7684\u533a\u522b",children:"tally::PerSecondEx \u4e0e tally::PerSecond \u7684\u533a\u522b"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"tally::PerSecond"})," \u4e0d\u80fd\u72ec\u7acb\u5b58\u5728\uff0c\u5fc5\u987b\u4f9d\u8d56\u5df2\u6709\u8ba1\u6570\u5668\uff0c\u81ea\u52a8\u66f4\u65b0\uff0c\u65e0\u9700\u663e\u5f0f\u8f93\u5165\u6570\u636e\uff1b",(0,t.jsx)(n.code,{children:"window_size"})," \u901a\u8fc7\u6784\u9020\u51fd\u6570\u4f20\u5165"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"tally::PerSecondEx"})," \u72ec\u7acb\u5b58\u5728\uff0c\u4e0d\u4f9d\u8d56\u5176\u4ed6\u8ba1\u6570\u5668\uff0c\u9700\u8981\u663e\u5f0f\u8f93\u5165\u6570\u636e\uff0c\u4f7f\u7528\u66f4\u65b9\u4fbf\uff1b",(0,t.jsx)(n.code,{children:"window_size"})," \u901a\u8fc7\u6a21\u677f\u53c2\u6570\u4f20\u5165\uff0c\u7701\u7565\u65f6\u9ed8\u8ba4\u4e3a ",(0,t.jsx)(n.code,{children:"tally_dump_interval"})]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"tallystatus",children:"tally::Status"}),"\n",(0,t.jsxs)(n.p,{children:["\u8bb0\u5f55\u5e76\u5c55\u793a\u503c\uff0c\u5e76\u9644\u52a0 ",(0,t.jsx)(n.code,{children:"set_value"})," \u65b9\u6cd5\u3002"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-c++",children:'// \u663e\u793a\u8f83\u5c11\u6216\u5468\u671f\u6027\u66f4\u65b0\u7684\u503c\n// \u7528\u6cd5\uff1a\n//   tally::Status<int> foo_count1(17);\n//   foo_count1.expose("my_value");\n//\n//   tally::Status<int> foo_count2;\n//   foo_count2.set_value(17);\n//\n//   tally::Status<int> foo_count3("my_value", 17);\n//\n// \u6ce8\u610f Tp \u5fc5\u987b\u662f std::string \u6216\u53ef\u517c\u5bb9 boost::atomic<Tp>\ntemplate <typename Tp>\nclass Status : public Variable;\n'})}),"\n",(0,t.jsx)(n.h2,{id:"tallyfuncgauge",children:"tally::FuncGauge"}),"\n",(0,t.jsxs)(n.p,{children:["\u6309\u9700\u5c55\u793a\u503c\u3002\u5728\u67d0\u4e9b\u573a\u666f\u4e0b\uff0c\u65e0\u6cd5\u8c03\u7528 ",(0,t.jsx)(n.code,{children:"set_value"})," \u6216\u4e0d\u786e\u5b9a\u8c03\u7528\u9891\u7387\uff0c\u6b64\u65f6\u66f4\u9002\u5408\u4ec5\u5728\u9700\u8981\u65f6\u83b7\u53d6\u5e76\u5c55\u793a\u503c\u3002\u7528\u6237\u901a\u8fc7\u4f20\u5165\u56de\u8c03\u51fd\u6570\u5b9e\u73b0\u3002"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-c++",children:'// \u6309\u9700\u5c55\u793a\u503c\uff0c\u901a\u8fc7\u7528\u6237\u5b9a\u4e49\u7684\u56de\u8c03\u51fd\u6570\u751f\u6210\u503c\n// \u793a\u4f8b\uff1a\n//   int print_number(void* arg) {\n//      ...\n//      return 5;\n//   }\n//\n//   // number1 : 5\n//   tally::FuncGauge status1("number1", print_number, arg);\n//\n//   // foo_number2 : 5\n//   tally::FuncGauge status2(typeid(Foo), "number2", print_number, arg);\ntemplate <typename Tp>\nclass FuncGauge : public Variable;\n'})}),"\n",(0,t.jsxs)(n.p,{children:["\u5c3d\u7ba1\u7b80\u5355\uff0c",(0,t.jsx)(n.code,{children:"FuncGauge"})," \u662f ",(0,t.jsx)(n.code,{children:"tally"})," \u4e2d\u6700\u6709\u7528\u7684\u7ec4\u4ef6\u4e4b\u4e00\u3002\u8fd9\u662f\u56e0\u4e3a\u5f88\u591a\u7edf\u8ba1\u503c\u5df2\u7ecf\u5b58\u5728\uff0c\u65e0\u9700\u518d\u6b21\u5b58\u50a8\uff0c\u53ea\u9700\u6309\u9700\u83b7\u53d6\u3002\u4f8b\u5982\uff0c\u4e0b\u9762\u7684\u4ee3\u7801\u58f0\u660e\u4e86\u4e00\u4e2a ",(0,t.jsx)(n.code,{children:"tally"}),"\uff0c\u7528\u4e8e\u663e\u793a Linux \u4e0a\u8fdb\u7a0b\u7528\u6237\u540d\uff1a"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-c++",children:'static void get_username(std::ostream& os, void*) {\n    char buf[32];\n    if (getlogin_r(buf, sizeof(buf)) == 0) {\n        buf[sizeof(buf)-1] = \'\\0\';\n        os << buf;\n    } else {\n        os << "unknown";\n    }\n}\nPassiveStatus<std::string> g_username("process_username", get_username, NULL);\n'})})]})}function u(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(o,{...e})}):o(e)}},8453:(e,n,l)=>{l.d(n,{R:()=>d,x:()=>s});var a=l(6540);const t={},i=a.createContext(t);function d(e){const n=a.useContext(i);return a.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:d(e.components),a.createElement(i.Provider,{value:n},e.children)}}}]);