<!doctype html>
<html lang="zh-cn" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-foundamentals/json/protobuf" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Protobuf-JSON 转换 | Kumo Search</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://your-docusaurus-site.example.com/cppdev/zh-cn/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://your-docusaurus-site.example.com/cppdev/zh-cn/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://your-docusaurus-site.example.com/cppdev/zh-cn/docs/foundamentals/json/protobuf"><meta data-rh="true" property="og:locale" content="zh_cn"><meta data-rh="true" property="og:locale:alternate" content="en_GB"><meta data-rh="true" name="docusaurus_locale" content="zh-cn"><meta data-rh="true" name="docsearch:language" content="zh-cn"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Protobuf-JSON 转换 | Kumo Search"><meta data-rh="true" name="description" content="基于 jsontopb.h 和 pbtojson.h 头文件，本篇文档详细说明了 Merak 中 Protobuf（PB）与 JSON 之间的双向转换功能，包括使用方法、高级配置和注意事项——保持与 Merak 官方文档相同的结构和风格。"><meta data-rh="true" property="og:description" content="基于 jsontopb.h 和 pbtojson.h 头文件，本篇文档详细说明了 Merak 中 Protobuf（PB）与 JSON 之间的双向转换功能，包括使用方法、高级配置和注意事项——保持与 Merak 官方文档相同的结构和风格。"><link data-rh="true" rel="icon" href="/cppdev/zh-cn/img/favicon.svg"><link data-rh="true" rel="canonical" href="https://your-docusaurus-site.example.com/cppdev/zh-cn/docs/foundamentals/json/protobuf"><link data-rh="true" rel="alternate" href="https://your-docusaurus-site.example.com/cppdev/docs/foundamentals/json/protobuf" hreflang="en-GB"><link data-rh="true" rel="alternate" href="https://your-docusaurus-site.example.com/cppdev/zh-cn/docs/foundamentals/json/protobuf" hreflang="zh-cn"><link data-rh="true" rel="alternate" href="https://your-docusaurus-site.example.com/cppdev/docs/foundamentals/json/protobuf" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"基础开发","item":"https://your-docusaurus-site.example.com/cppdev/zh-cn/docs/category/foundamentals"},{"@type":"ListItem","position":2,"name":"json","item":"https://your-docusaurus-site.example.com/cppdev/zh-cn/docs/foundamentals/json/"},{"@type":"ListItem","position":3,"name":"Protobuf-JSON 转换","item":"https://your-docusaurus-site.example.com/cppdev/zh-cn/docs/foundamentals/json/protobuf"}]}</script><link rel="alternate" type="application/rss+xml" href="/cppdev/zh-cn/blog/rss.xml" title="Kumo Search RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/cppdev/zh-cn/blog/atom.xml" title="Kumo Search Atom Feed"><link rel="stylesheet" href="/cppdev/zh-cn/assets/css/styles.582e0043.css">
<script src="/cppdev/zh-cn/assets/js/runtime~main.ab755061.js" defer="defer"></script>
<script src="/cppdev/zh-cn/assets/js/main.0dd454fe.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/cppdev/zh-cn/img/kumo-logo.svg"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/cppdev/zh-cn/"><div class="navbar__logo"><img src="/cppdev/zh-cn/img/kumo-logo.svg" alt="Kumo logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/cppdev/zh-cn/img/kumo-logo.svg" alt="Kumo logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">开发导论</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/cppdev/zh-cn/docs/intro">教程</a><a class="navbar__item navbar__link" href="/cppdev/zh-cn/docs/integration/overview">集成</a><a class="navbar__item navbar__link" href="/cppdev/zh-cn/blog">博客</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/kumose" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>中文（中国）</a><ul class="dropdown__menu"><li><a href="/cppdev/docs/foundamentals/json/protobuf" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="en-GB">English</a></li><li><a href="/cppdev/zh-cn/docs/foundamentals/json/protobuf" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh-cn">中文（中国）</a></li></ul></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="切换浅色/暗黑模式（当前为system mode）"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/cppdev/zh-cn/docs/intro"><span title="概览" class="linkLabel_WmDU">概览</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--active" href="/cppdev/zh-cn/docs/category/foundamentals"><span title="基础开发" class="categoryLinkLabel_W154">基础开发</span></a><button aria-label="折叠侧边栏分类 &#x27;基础开发&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" tabindex="0" href="/cppdev/zh-cn/docs/foundamentals/testing/"><span title="性能测试与单元测试" class="categoryLinkLabel_W154">性能测试与单元测试</span></a><button aria-label="展开侧边栏分类 &#x27;性能测试与单元测试&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" tabindex="0" href="/cppdev/zh-cn/docs/foundamentals/log/"><span title="日志" class="categoryLinkLabel_W154">日志</span></a><button aria-label="展开侧边栏分类 &#x27;日志&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cppdev/zh-cn/docs/foundamentals/time"><span title="时间与日历" class="linkLabel_WmDU">时间与日历</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" tabindex="0" href="/cppdev/zh-cn/docs/category/standardized-errors-and-error-return-values"><span title="标准化错误与错误返回值" class="categoryLinkLabel_W154">标准化错误与错误返回值</span></a><button aria-label="展开侧边栏分类 &#x27;标准化错误与错误返回值&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" tabindex="0" href="/cppdev/zh-cn/docs/foundamentals/strings/"><span title="strings 操作" class="categoryLinkLabel_W154">strings 操作</span></a><button aria-label="展开侧边栏分类 &#x27;strings 操作&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cppdev/zh-cn/docs/foundamentals/flags"><span title="Turbo 命令行标志（Turbo Flags）" class="linkLabel_WmDU">Turbo 命令行标志（Turbo Flags）</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" tabindex="0" href="/cppdev/zh-cn/docs/foundamentals/codec/"><span title="编码与解码" class="categoryLinkLabel_W154">编码与解码</span></a><button aria-label="展开侧边栏分类 &#x27;编码与解码&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cppdev/zh-cn/docs/foundamentals/format/"><span title="格式化与输出（字符串格式化和输出）" class="linkLabel_WmDU">格式化与输出（字符串格式化和输出）</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" tabindex="0" href="/cppdev/zh-cn/docs/foundamentals/map/"><span title="map容器" class="categoryLinkLabel_W154">map容器</span></a><button aria-label="展开侧边栏分类 &#x27;map容器&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" tabindex="0" href="/cppdev/zh-cn/docs/foundamentals/compress/"><span title="压缩与解压缩" class="categoryLinkLabel_W154">压缩与解压缩</span></a><button aria-label="展开侧边栏分类 &#x27;压缩与解压缩&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" tabindex="0" href="/cppdev/zh-cn/docs/foundamentals/fibers/"><span title="Fiber And Future" class="categoryLinkLabel_W154">Fiber And Future</span></a><button aria-label="展开侧边栏分类 &#x27;Fiber And Future&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" tabindex="0" href="/cppdev/zh-cn/docs/foundamentals/monitor/"><span title="监控" class="categoryLinkLabel_W154">监控</span></a><button aria-label="展开侧边栏分类 &#x27;监控&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" tabindex="0" href="/cppdev/zh-cn/docs/foundamentals/filesystem/"><span title="文件系统" class="categoryLinkLabel_W154">文件系统</span></a><button aria-label="展开侧边栏分类 &#x27;文件系统&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--active" tabindex="0" href="/cppdev/zh-cn/docs/foundamentals/json/"><span title="json" class="categoryLinkLabel_W154">json</span></a><button aria-label="折叠侧边栏分类 &#x27;json&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/cppdev/zh-cn/docs/foundamentals/json/overview"><span title="merak json — 概览总结" class="linkLabel_WmDU">merak json — 概览总结</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/cppdev/zh-cn/docs/foundamentals/json/features"><span title="功能特性" class="linkLabel_WmDU">功能特性</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/cppdev/zh-cn/docs/foundamentals/json/tutorial"><span title="教程" class="linkLabel_WmDU">教程</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/cppdev/zh-cn/docs/foundamentals/json/pointer"><span title="指针" class="linkLabel_WmDU">指针</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/cppdev/zh-cn/docs/foundamentals/json/stream"><span title="流（Streams）" class="linkLabel_WmDU">流（Streams）</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/cppdev/zh-cn/docs/foundamentals/json/encoding"><span title="编码" class="linkLabel_WmDU">编码</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/cppdev/zh-cn/docs/foundamentals/json/dom"><span title="DOM" class="linkLabel_WmDU">DOM</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/cppdev/zh-cn/docs/foundamentals/json/sax"><span title="SAX" class="linkLabel_WmDU">SAX</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/cppdev/zh-cn/docs/foundamentals/json/schema"><span title="Schema（模式）" class="linkLabel_WmDU">Schema（模式）</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/cppdev/zh-cn/docs/foundamentals/json/internals"><span title="Architecture" class="linkLabel_WmDU">Architecture</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/cppdev/zh-cn/docs/foundamentals/json/performance"><span title="性能" class="linkLabel_WmDU">性能</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/cppdev/zh-cn/docs/foundamentals/json/protobuf"><span title="Protobuf-JSON 转换" class="linkLabel_WmDU">Protobuf-JSON 转换</span></a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/cppdev/zh-cn/docs/rpc/"><span title="rpc远程调用" class="categoryLinkLabel_W154">rpc远程调用</span></a><button aria-label="展开侧边栏分类 &#x27;rpc远程调用&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/cppdev/zh-cn/docs/retrieve/"><span title="检索开发" class="categoryLinkLabel_W154">检索开发</span></a><button aria-label="展开侧边栏分类 &#x27;检索开发&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/cppdev/zh-cn/docs/store/"><span title="存储" class="categoryLinkLabel_W154">存储</span></a><button aria-label="展开侧边栏分类 &#x27;存储&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/cppdev/zh-cn/docs/ir/"><span title="IR" class="categoryLinkLabel_W154">IR</span></a><button aria-label="展开侧边栏分类 &#x27;IR&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/cppdev/zh-cn/docs/advance/"><span title="进阶开发" class="categoryLinkLabel_W154">进阶开发</span></a><button aria-label="展开侧边栏分类 &#x27;进阶开发&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/cppdev/zh-cn/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/cppdev/zh-cn/docs/category/foundamentals"><span>基础开发</span></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/cppdev/zh-cn/docs/foundamentals/json/"><span>json</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Protobuf-JSON 转换</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>Protobuf-JSON 转换</h1></header>
<p>基于 <code>json_to_pb.h</code> 和 <code>pb_to_json.h</code> 头文件，本篇文档详细说明了 Merak 中 Protobuf（PB）与 JSON 之间的双向转换功能，包括使用方法、高级配置和注意事项——保持与 Merak 官方文档相同的结构和风格。</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Overview的直接链接" title="Overview的直接链接" translate="no">​</a></h2>
<p><code>json_to_pb.h</code> 和 <code>pb_to_json.h</code> 提供了在 Protobuf 消息与 Merak JSON DOM (<code>Document</code>/<code>Value</code>) 或 JSON 字符串之间高效转换的能力。它们支持 Protobuf 核心特性（嵌套消息、重复字段、枚举、oneof、map 字段等），并兼容 Merak 的高性能设计理念。</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="core-features">Core Features<a href="#core-features" class="hash-link" aria-label="Core Features的直接链接" title="Core Features的直接链接" translate="no">​</a></h3>
<ul>
<li class=""><strong>完整类型映射</strong>：准确映射所有 Protobuf 基本类型（<code>int32</code>/<code>int64</code>/<code>uint32</code>/<code>uint64</code>/<code>double</code>/<code>float</code>/<code>bool</code>/<code>string</code>/<code>bytes</code>）到 JSON 类型。</li>
<li class=""><strong>Protobuf 特性支持</strong>：无缝处理嵌套消息、重复字段（<code>repeated</code>）、枚举、oneof、map 字段（<code>map&lt;&gt;</code>）、必需字段和可选字段。</li>
<li class=""><strong>灵活配置</strong>：提供转换选项（如忽略未知字段、控制默认值输出、枚举转换模式）。</li>
<li class=""><strong>错误处理</strong>：返回清晰的转换状态，并支持详细错误信息（如字段不匹配、类型错误、缺少必需字段）。</li>
<li class=""><strong>高性能</strong>：复用 Merak DOM 的内存优化设计，实现低开销转换，适用于大规模数据场景。</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="dependencies">Dependencies<a href="#dependencies" class="hash-link" aria-label="Dependencies的直接链接" title="Dependencies的直接链接" translate="no">​</a></h3>
<ul>
<li class="">依赖 Merak 核心库（<code>document.h</code>/<code>value.h</code>/<code>stringbuffer.h</code> 等）。</li>
<li class="">依赖 Protobuf 库（推荐 3.0+ 版本）；需链接 Protobuf 编译产物（<code>libprotobuf</code>）。</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="1-json-到-protobuf-json_to_pbh">1. JSON 到 Protobuf (<code>json_to_pb.h</code>)<a href="#1-json-到-protobuf-json_to_pbh" class="hash-link" aria-label="1-json-到-protobuf-json_to_pbh的直接链接" title="1-json-到-protobuf-json_to_pbh的直接链接" translate="no">​</a></h2>
<p><code>json_to_pb.h</code> 提供将 Merak JSON DOM 或 JSON 字符串转换为 Protobuf 消息的接口，核心功能是将 JSON 结构和数值映射到对应的 Protobuf 字段。</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="11-基本使用">1.1 基本使用<a href="#11-基本使用" class="hash-link" aria-label="1.1 基本使用的直接链接" title="1.1 基本使用的直接链接" translate="no">​</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="step-1-定义-protobuf-消息">Step 1: 定义 Protobuf 消息<a href="#step-1-定义-protobuf-消息" class="hash-link" aria-label="Step 1: 定义 Protobuf 消息的直接链接" title="Step 1: 定义 Protobuf 消息的直接链接" translate="no">​</a></h4>
<p>首先，编写 <code>.proto</code> 文件（示例：<code>user.proto</code>）以定义目标 Protobuf 消息结构：</p>
<div class="language-proto codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-proto codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">syntax = &quot;proto3&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">package example;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 嵌套消息：地址信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">message Address {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  string street = 1;    // 街道</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  string city = 2;      // 城市</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  uint32 zip_code = 3;  // 邮编（可选）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 枚举：用户状态</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">enum UserStatus {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  STATUS_UNKNOWN = 0;  // 默认枚举值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  STATUS_ACTIVE = 1;   // 激活</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  STATUS_INACTIVE = 2; // 未激活</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 核心消息：用户信息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">message User {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  string id = 1;                  // 用户 ID（必填）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  string name = 2;                // 用户名（必填）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  uint32 age = 3;                 // 年龄（可选）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  bool is_vip = 4;                // 是否 VIP（默认: false）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  repeated string tags = 5;        // 标签（重复字段）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  repeated Address addresses = 6;  // 地址列表（嵌套重复消息）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  UserStatus status = 7;           // 用户状态（枚举）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  map&lt;string, string&gt; ext_info = 8;// 扩展信息（map 字段）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // oneof 字段：联系方式（互斥）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  oneof contact {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    string phone = 9;  // 电话</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    string email = 10; // 邮箱</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>编译 <code>.proto</code> 文件生成 C++ 头文件和源文件（需 Protobuf 编译器 <code>protoc</code>）：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">protoc --cpp_out=./ user.proto</span><br></span></code></pre></div></div>
<p>生成 <code>user.pb.h</code> 和 <code>user.pb.cc</code>，在项目中引入并链接编译产物。</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="step-2-将-json-转换为-protobuf-消息">Step 2: 将 JSON 转换为 Protobuf 消息<a href="#step-2-将-json-转换为-protobuf-消息" class="hash-link" aria-label="Step 2: 将 JSON 转换为 Protobuf 消息的直接链接" title="Step 2: 将 JSON 转换为 Protobuf 消息的直接链接" translate="no">​</a></h4>
<p>使用 <code>JsonToPb</code> 系列接口进行转换，可支持 JSON 字符串或 Merak DOM 输入：</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&quot;merak/proto/json_to_pb.h&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&quot;merak/json/document.h&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&quot;user.pb.h&quot;</span><span class="token macro property" style="color:#36acaa">  </span><span class="token macro property comment" style="color:#999988;font-style:italic">// 编译生成的 Protobuf 头文件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;iostream&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">namespace</span><span class="token plain"> merak</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">json</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">namespace</span><span class="token plain"> example</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 1. 待转换 JSON 字符串</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> json_str </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token raw-string string" style="color:#e3116c">R&quot;(</span><br></span><span class="token-line" style="color:#393A34"><span class="token raw-string string" style="color:#e3116c">  {</span><br></span><span class="token-line" style="color:#393A34"><span class="token raw-string string" style="color:#e3116c">    &quot;id&quot;: &quot;user_123&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token raw-string string" style="color:#e3116c">    &quot;name&quot;: &quot;Alice&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token raw-string string" style="color:#e3116c">    &quot;age&quot;: 28,</span><br></span><span class="token-line" style="color:#393A34"><span class="token raw-string string" style="color:#e3116c">    &quot;is_vip&quot;: true,</span><br></span><span class="token-line" style="color:#393A34"><span class="token raw-string string" style="color:#e3116c">    &quot;tags&quot;: [&quot;student&quot;, &quot;tech&quot;],</span><br></span><span class="token-line" style="color:#393A34"><span class="token raw-string string" style="color:#e3116c">    &quot;addresses&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token raw-string string" style="color:#e3116c">      {</span><br></span><span class="token-line" style="color:#393A34"><span class="token raw-string string" style="color:#e3116c">        &quot;street&quot;: &quot;123 Main St&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token raw-string string" style="color:#e3116c">        &quot;city&quot;: &quot;New York&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token raw-string string" style="color:#e3116c">        &quot;zip_code&quot;: 10001</span><br></span><span class="token-line" style="color:#393A34"><span class="token raw-string string" style="color:#e3116c">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token raw-string string" style="color:#e3116c">    ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token raw-string string" style="color:#e3116c">    &quot;status&quot;: &quot;STATUS_ACTIVE&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token raw-string string" style="color:#e3116c">    &quot;ext_info&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token raw-string string" style="color:#e3116c">      &quot;school&quot;: &quot;NYU&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token raw-string string" style="color:#e3116c">      &quot;major&quot;: &quot;CS&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token raw-string string" style="color:#e3116c">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token raw-string string" style="color:#e3116c">    &quot;email&quot;: &quot;alice@example.com&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token raw-string string" style="color:#e3116c">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token raw-string string" style="color:#e3116c">  )&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 2. 解析 JSON 字符串为 Merak DOM（可选；直接字符串转换更简单）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Document json_doc</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">json_doc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Parse</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">json_str</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">HasParseError</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">cerr </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;JSON 解析错误: &quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">GetParseError_En</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">json_doc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetParseErrorCode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">endl</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 3. 初始化 Protobuf 消息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  User user_pb</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 4. 配置转换选项（可省略使用默认值）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  merak</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">proto</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">JsonToPbOptions options</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  options</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ignore_unknown_fields </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 忽略 JSON 中 Protobuf 未定义字段</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  options</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">strict_required_fields </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 严格检查必填字段（默认: true）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  options</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">enum_parse_mode </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> merak</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">proto</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">EnumParseMode</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">kEnumParseName</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 按枚举名解析（默认）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 5. 执行转换（两种输入模式：DOM 或 JSON 字符串）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 模式 1：从 Merak DOM 转换</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">bool</span><span class="token plain"> success </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> merak</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">proto</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">JsonToPb</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">json_doc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">user_pb</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> options</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 模式 2：直接从 JSON 字符串转换（内部解析 DOM）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// bool success = merak::proto::JsonToPb(json_str, &amp;user_pb, options);</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">success</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">cerr </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;JSON 转 Protobuf 失败: &quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> merak</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">proto</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">GetJsonToPbError</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">endl</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 6. 验证转换结果</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">cout </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;转换成功. 用户 ID: &quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> user_pb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">id</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">endl</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">cout </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;用户状态: &quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> user_pb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">status</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">endl</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">cout </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;邮箱: &quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> user_pb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">email</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">endl</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="12-核心配置jsontopboptions">1.2 核心配置：<code>JsonToPbOptions</code><a href="#12-核心配置jsontopboptions" class="hash-link" aria-label="12-核心配置jsontopboptions的直接链接" title="12-核心配置jsontopboptions的直接链接" translate="no">​</a></h3>
<p>该配置结构控制 JSON → PB 的行为。字段说明：</p>
<table><thead><tr><th>字段名</th><th>类型</th><th>默认值</th><th>描述</th></tr></thead><tbody><tr><td><code>ignore_unknown_fields</code></td><td><code>bool</code></td><td><code>false</code></td><td>是否忽略 JSON 中未定义在 Protobuf 的字段（true: 忽略；false: 转换失败）</td></tr><tr><td><code>strict_required_fields</code></td><td><code>bool</code></td><td><code>true</code></td><td>是否严格检查 Protobuf 必填字段（true: 缺失则失败；false: 允许缺失）</td></tr><tr><td><code>enum_parse_mode</code></td><td><code>EnumParseMode</code>（枚举）</td><td><code>kEnumParseName</code></td><td>枚举解析模式：<br>- <code>kEnumParseName</code>：按枚举名解析（如 &quot;STATUS_ACTIVE&quot;）<br>- <code>kEnumParseNumber</code>：按枚举数字解析（如 1）</td></tr><tr><td><code>allow_hex_numbers</code></td><td><code>bool</code></td><td><code>false</code></td><td>是否允许 JSON 中使用十六进制数（true: 支持 <code>0x123</code>; false: 仅支持十进制）</td></tr><tr><td><code>bytes_parse_mode</code></td><td><code>BytesParseMode</code>（枚举）</td><td><code>kBytesParseBase64</code></td><td>Protobuf <code>bytes</code> 字段解析模式：<br>- <code>kBytesParseBase64</code>：将 JSON 字符串解码为 Base64<br>- <code>kBytesParseRaw</code>：将 JSON 字符串作为原始字节处理</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="13-字段映射规则">1.3 字段映射规则<a href="#13-字段映射规则" class="hash-link" aria-label="1.3 字段映射规则的直接链接" title="1.3 字段映射规则的直接链接" translate="no">​</a></h3>
<p>JSON 与 Protobuf 的类型映射遵循官方 Protobuf JSON 规范。核心映射如下：</p>
<table><thead><tr><th>Protobuf 字段类型</th><th>JSON 类型</th><th>描述</th></tr></thead><tbody><tr><td><code>int32</code>/<code>int64</code>/<code>uint32</code>/<code>uint64</code></td><td>数字或字符串</td><td>支持 JSON 数字（如 123）或字符串（如 &quot;123&quot;）；超出范围转换失败</td></tr><tr><td><code>double</code>/<code>float</code></td><td>数字或字符串</td><td>支持 JSON 数字（如 3.14）或字符串（如 &quot;3.14&quot;）；不支持 NaN/Inf</td></tr><tr><td><code>bool</code></td><td>布尔或字符串</td><td>支持 JSON <code>true</code>/<code>false</code> 或字符串 &quot;true&quot;/&quot;false&quot;（不区分大小写）</td></tr><tr><td><code>string</code></td><td>字符串</td><td>支持带空字符 (<code>\u0000</code>) 的 JSON 字符串（符合 Merak 特性）</td></tr><tr><td><code>bytes</code></td><td>字符串</td><td>默认 Base64 编码字符串；可通过 <code>bytes_parse_mode</code> 配置为原始字节</td></tr><tr><td><code>enum</code></td><td>字符串或数字</td><td>根据 <code>enum_parse_mode</code> 映射为枚举名（如 &quot;STATUS_ACTIVE&quot;）或数字（如 1）</td></tr><tr><td><code>repeated T</code></td><td>数组</td><td>JSON 数组的每个元素遵循类型 T 的映射规则</td></tr><tr><td>嵌套 <code>message</code></td><td>对象</td><td>JSON 对象中的字段一一映射到嵌套消息的字段</td></tr><tr><td><code>map&lt;K, V&gt;</code></td><td>对象</td><td>键类型为 K（支持 <code>string</code>/<code>int32</code>/<code>int64</code>/<code>uint32</code>/<code>uint64</code>）；值类型为 V</td></tr><tr><td><code>oneof</code></td><td>单字段</td><td>JSON 中只能包含 oneof 的一个字段；若存在多个或没有字段，则转换失败</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="14-错误处理">1.4 错误处理<a href="#14-错误处理" class="hash-link" aria-label="1.4 错误处理的直接链接" title="1.4 错误处理的直接链接" translate="no">​</a></h3>
<p>转换失败时，可通过以下接口获取详细错误信息：</p>
<ul>
<li class=""><code>const char* GetJsonToPbError()</code>：返回可读错误描述（如 &quot;required field &#x27;id&#x27; not found&quot;）。</li>
<li class=""><code>int GetJsonToPbErrorCode()</code>：返回错误码（对应 <code>JsonToPbErrorCode</code> 枚举，如 <code>kJsonToPbErrorMissingRequiredField</code>）。</li>
</ul>
<p>常见错误类型：</p>
<ul>
<li class="">缺少必填 Protobuf 字段。</li>
<li class="">字段类型不匹配（如 JSON 字符串赋值给 PB <code>int32</code> 字段）。</li>
<li class="">无效枚举值（如未知枚举名或数字）。</li>
<li class="">oneof 字段冲突（JSON 中出现多个 oneof 字段）。</li>
<li class="">JSON 数组类型不一致（如 <code>repeated int32</code> 对应的 JSON 数组中含字符串）。</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="2-protobuf-到-json-pb_to_jsonh">2. Protobuf 到 JSON (<code>pb_to_json.h</code>)<a href="#2-protobuf-到-json-pb_to_jsonh" class="hash-link" aria-label="2-protobuf-到-json-pb_to_jsonh的直接链接" title="2-protobuf-到-json-pb_to_jsonh的直接链接" translate="no">​</a></h2>
<p><code>pb_to_json.h</code> 提供将 Protobuf 消息转换为 Merak JSON DOM 或 JSON 字符串的接口，支持输出格式控制和默认值处理等高级功能。</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="21-基本使用">2.1 基本使用<a href="#21-基本使用" class="hash-link" aria-label="2.1 基本使用的直接链接" title="2.1 基本使用的直接链接" translate="no">​</a></h3>
<p>使用第 1.1 节定义的 Protobuf 消息，将 PB 消息转换为 JSON：</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&quot;merak/proto/pb_to_json.h&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&quot;merak/json/document.h&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&quot;merak/json/stringbuffer.h&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&quot;merak/json/writer.h&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&quot;user.pb.h&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;iostream&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">namespace</span><span class="token plain"> merak</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">json</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">namespace</span><span class="token plain"> example</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 1. 构造 Protobuf 消息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  User user_pb</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  user_pb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">set_id</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;user_456&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  user_pb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">set_name</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Bob&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  user_pb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">set_age</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">30</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  user_pb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">set_is_vip</span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  user_pb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">add_tags</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;engineer&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  user_pb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">add_tags</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;golang&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 添加嵌套地址消息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Address</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> addr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> user_pb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">add_addresses</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  addr</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">set_street</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;456 Oak Ave&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  addr</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">set_city</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;London&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  addr</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">set_zip_code</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">234567890</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  user_pb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">set_status</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">UserStatus</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">STATUS_ACTIVE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  user_pb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">mutable_ext_info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">insert</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;company&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ABC Corp&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  user_pb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">set_phone</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;+44 1234567890&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 设置 oneof 字段</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 2. 配置转换选项</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  merak</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">proto</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">PbToJsonOptions options</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  options</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">output_default_values </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 不输出默认值字段（默认: false）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  options</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">enum_output_mode </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> merak</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">proto</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">EnumOutputMode</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">kEnumOutputName</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 输出枚举名（默认）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  options</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">use_proto_field_name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">// 使用 JSON 字段名（默认: false；使用 proto 定义的名称）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  options</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pretty_print </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// 格式化 JSON 输出（默认: false）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  options</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bytes_output_mode </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> merak</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">proto</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">BytesOutputMode</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">kBytesOutputBase64</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 输出 bytes 为 Base64（默认）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 3. 执行转换（两种输出模式：Merak DOM 或 JSON 字符串）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 模式 1：转换为 Merak DOM（可修改）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Document json_doc</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">bool</span><span class="token plain"> success </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> merak</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">proto</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">PbToJson</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">user_pb</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">json_doc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> options</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">success</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">cerr </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Protobuf 转 JSON 失败: &quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> merak</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">proto</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">GetPbToJsonError</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">endl</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 模式 2：直接转换为 JSON 字符串（更简单）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// std::string json_str;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// bool success = merak::proto::PbToJson(user_pb, &amp;json_str, options);</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 4. 输出 JSON 结果（格式化）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  StringBuffer buffer</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  PrettyWriter</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">StringBuffer</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">writer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">buffer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 格式化写入器</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  json_doc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Accept</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">writer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">cout </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Protobuf 转 JSON 结果:&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">endl</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">cout </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> buffer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetString</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">endl</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p>输出（格式化）：</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;id&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;user_456&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Bob&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;age&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;is_vip&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;tags&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;engineer&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;golang&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;addresses&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;street&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;456 Oak Ave&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;city&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;London&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token property" style="color:#36acaa">&quot;zip_code&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">234567890</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;status&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;STATUS_ACTIVE&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;ext_info&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;company&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ABC Corp&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;phone&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;+44 1234567890&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="22-核心配置pbtojsonoptions">2.2 核心配置：<code>PbToJsonOptions</code><a href="#22-核心配置pbtojsonoptions" class="hash-link" aria-label="22-核心配置pbtojsonoptions的直接链接" title="22-核心配置pbtojsonoptions的直接链接" translate="no">​</a></h3>
<p>控制 PB → JSON 输出行为。字段说明：</p>
<table><thead><tr><th>字段名</th><th>类型</th><th>默认值</th><th>描述</th></tr></thead><tbody><tr><td><code>output_default_values</code></td><td><code>bool</code></td><td><code>false</code></td><td>是否输出 Protobuf 默认值字段（true: 输出；false: 忽略默认值字段）</td></tr><tr><td><code>enum_output_mode</code></td><td><code>EnumOutputMode</code>（枚举）</td><td><code>kEnumOutputName</code></td><td>枚举输出模式：<br>- <code>kEnumOutputName</code>：输出枚举名（如 &quot;STATUS_ACTIVE&quot;）<br>- <code>kEnumOutputNumber</code>：输出枚举数字（如 1）</td></tr><tr><td><code>use_proto_field_name</code></td><td><code>bool</code></td><td><code>false</code></td><td>是否使用 Protobuf 定义字段名（true: 使用 proto 名称；false: 使用 JSON 规范名，例如 proto <code>user_name</code> → JSON <code>userName</code>）</td></tr><tr><td><code>pretty_print</code></td><td><code>bool</code></td><td><code>false</code></td><td>是否格式化 JSON（true: 格式化；false: 紧凑）</td></tr><tr><td><code>bytes_output_mode</code></td><td><code>BytesOutputMode</code>（枚举）</td><td><code>kBytesOutputBase64</code></td><td>Protobuf <code>bytes</code> 输出模式：<br>- <code>kBytesOutputBase64</code>：输出 Base64 字符串<br>- <code>kBytesOutputRaw</code>：输出原始字节（可能包含不可打印字符）</td></tr><tr><td><code>ignore_empty_repeated</code></td><td><code>bool</code></td><td><code>false</code></td><td>是否忽略空的 <code>repeated</code> 字段（true: 忽略空数组；false: 输出空数组）</td></tr><tr><td><code>ignore_empty_map</code></td><td><code>bool</code></td><td><code>false</code></td><td>是否忽略空的 <code>map</code> 字段（true: 忽略空对象；false: 输出空对象）</td></tr><tr><td><code>max_depth</code></td><td><code>int</code></td><td><code>100</code></td><td>嵌套消息的最大深度（防止递归溢出；超过则转换失败）</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="23-字段映射规则">2.3 字段映射规则<a href="#23-字段映射规则" class="hash-link" aria-label="2.3 字段映射规则的直接链接" title="2.3 字段映射规则的直接链接" translate="no">​</a></h3>
<p>Protobuf → JSON 映射遵循与 JSON→PB 对称的规则。关键补充说明：</p>
<ul>
<li class=""><strong>默认值处理</strong>：默认值字段（如 <code>int32</code> = 0、<code>bool</code> = false、<code>string</code> = &quot;&quot;）默认被忽略；可通过 <code>output_default_values</code> 输出。</li>
<li class=""><strong>重复字段</strong>：Protobuf <code>repeated</code> 字段始终映射为 JSON 数组（空数组可根据 <code>ignore_empty_repeated</code> 忽略或保留）。</li>
<li class=""><strong>oneof 字段</strong>：仅输出 oneof 中已设置的字段（未设置则忽略）。</li>
<li class=""><strong>Map 字段</strong>：Protobuf <code>map&lt;K, V&gt;</code> 映射为 JSON 对象，键为 K 的字符串表示（例如 <code>int32</code> 键 123 → &quot;123&quot;）。</li>
<li class=""><strong>枚举字段</strong>：默认输出枚举名（如 &quot;STATUS_ACTIVE&quot;）；可通过 <code>enum_output_mode</code> 输出数字。</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="24-错误处理">2.4 错误处理<a href="#24-错误处理" class="hash-link" aria-label="2.4 错误处理的直接链接" title="2.4 错误处理的直接链接" translate="no">​</a></h3>
<p>转换失败时，可通过以下接口获取错误信息：</p>
<ul>
<li class=""><code>const char* GetPbToJsonError()</code>：返回错误描述（如 &quot;nested message depth exceeds max_depth&quot;）。</li>
<li class=""><code>int GetPbToJsonErrorCode()</code>：返回错误码（对应 <code>PbToJsonErrorCode</code> 枚举，如 <code>kPbToJsonErrorMaxDepthExceeded</code>）。</li>
</ul>
<p>常见错误类型：</p>
<ul>
<li class="">嵌套消息深度超过 <code>max_depth</code> 限制。</li>
<li class="">Protobuf 消息包含未初始化的必填字段（仅在调试模式下检查）。</li>
<li class=""><code>bytes</code> 字段包含无效 Base64 字符（当 <code>bytes_output_mode</code> = <code>kBytesOutputBase64</code> 时）。</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="3-高级功能">3. 高级功能<a href="#3-高级功能" class="hash-link" aria-label="3. 高级功能的直接链接" title="3. 高级功能的直接链接" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="31-动态-protobuf-消息处理">3.1 动态 Protobuf 消息处理<a href="#31-动态-protobuf-消息处理" class="hash-link" aria-label="3.1 动态 Protobuf 消息处理的直接链接" title="3.1 动态 Protobuf 消息处理的直接链接" translate="no">​</a></h3>
<p>支持通过 Protobuf 的 <code>Descriptor</code> 和 <code>Reflection</code> 接口处理动态消息（无需编译 <code>.proto</code> 文件）：</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&quot;merak/proto/json_to_pb.h&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&quot;google/protobuf/descriptor.h&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&quot;google/protobuf/message.h&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 动态 JSON → Protobuf 转换（已知 Descriptor）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">bool</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">DynamicJsonToPb</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> Document</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> json</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> google</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">protobuf</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">Descriptor</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> desc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> google</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">protobuf</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">Message</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> pb</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> merak</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">proto</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">JsonToPb</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">json</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> desc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pb</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> merak</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">proto</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">JsonToPbOptions</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="32-自定义字段映射">3.2 自定义字段映射<a href="#32-自定义字段映射" class="hash-link" aria-label="3.2 自定义字段映射的直接链接" title="3.2 自定义字段映射的直接链接" translate="no">​</a></h3>
<p>注册回调函数以自定义特定字段的转换逻辑（如特殊日期格式、自定义枚举映射）：</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 注册字段转换回调（示例：将 JSON 日期字符串转换为 Protobuf int64 时间戳）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">merak</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">proto</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">RegisterJsonToPbFieldCallback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;example.User&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 消息全名</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">&quot;create_time&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">// 字段名</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> Value</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> json_val</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> google</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">protobuf</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">Message</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> pb</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> google</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">protobuf</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">FieldDescriptor</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> field</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">bool</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">json_val</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">IsString</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 自定义逻辑：将 &quot;2024-01-01&quot; 转为时间戳</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">int64_t</span><span class="token plain"> timestamp </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ParseDateToTimestamp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">json_val</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetString</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pb</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">GetReflection</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token function" style="color:#d73a49">SetInt64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pb</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> field</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> timestamp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="33-性能优化建议">3.3 性能优化建议<a href="#33-性能优化建议" class="hash-link" aria-label="3.3 性能优化建议的直接链接" title="3.3 性能优化建议的直接链接" translate="no">​</a></h3>
<ul>
<li class=""><strong>复用 DOM 对象</strong>：频繁转换时复用 Merak <code>Document</code> 对象（通过 <code>SetObject()</code> / <code>SetArray()</code> 清空），减少内存分配开销。</li>
<li class=""><strong>批量转换</strong>：大量小消息转换时批量处理，并复用 <code>StringBuffer</code>，避免重复创建缓冲区。</li>
<li class=""><strong>关闭不必要检查</strong>：生产环境可设置 <code>ignore_unknown_fields = true</code> 减少字段校验开销。</li>
<li class=""><strong>使用紧凑 JSON</strong>：非人类可读场景禁用 <code>pretty_print</code>，降低字符串拼接开销。</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="4-api-参考">4. API 参考<a href="#4-api-参考" class="hash-link" aria-label="4. API 参考的直接链接" title="4. API 参考的直接链接" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="41-json_to_pbh-核心-api">4.1 <code>json_to_pb.h</code> 核心 API<a href="#41-json_to_pbh-核心-api" class="hash-link" aria-label="41-json_to_pbh-核心-api的直接链接" title="41-json_to_pbh-核心-api的直接链接" translate="no">​</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="1-json-字符串--protobuf-消息">1. JSON 字符串 → Protobuf 消息<a href="#1-json-字符串--protobuf-消息" class="hash-link" aria-label="1. JSON 字符串 → Protobuf 消息的直接链接" title="1. JSON 字符串 → Protobuf 消息的直接链接" translate="no">​</a></h4>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">bool</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">JsonToPb</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> json_str</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">                  </span><span class="token comment" style="color:#999988;font-style:italic">// 输入: JSON 字符串</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  google</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">protobuf</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">Message</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> pb_msg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic">// 输出: Protobuf 消息（已初始化）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> JsonToPbOptions</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> options </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">JsonToPbOptions</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 转换选项</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="2-merak-dom--protobuf-消息">2. Merak DOM → Protobuf 消息<a href="#2-merak-dom--protobuf-消息" class="hash-link" aria-label="2. Merak DOM → Protobuf 消息的直接链接" title="2. Merak DOM → Protobuf 消息的直接链接" translate="no">​</a></h4>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">bool</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">JsonToPb</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> Value</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> json_val</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">                 </span><span class="token comment" style="color:#999988;font-style:italic">// 输入: Merak JSON Value（对象类型）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  google</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">protobuf</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">Message</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> pb_msg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic">// 输出: Protobuf 消息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> JsonToPbOptions</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> options </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">JsonToPbOptions</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 转换选项</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="3-动态消息转换通过-descriptor">3. 动态消息转换（通过 Descriptor）<a href="#3-动态消息转换通过-descriptor" class="hash-link" aria-label="3. 动态消息转换（通过 Descriptor）的直接链接" title="3. 动态消息转换（通过 Descriptor）的直接链接" translate="no">​</a></h4>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">bool</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">JsonToPb</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> Value</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> json_val</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> google</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">protobuf</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">Descriptor</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> pb_desc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Protobuf 消息描述符</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  google</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">protobuf</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">Message</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> pb_msg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> JsonToPbOptions</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> options </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">JsonToPbOptions</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="4-错误信息接口">4. 错误信息接口<a href="#4-错误信息接口" class="hash-link" aria-label="4. 错误信息接口的直接链接" title="4. 错误信息接口的直接链接" translate="no">​</a></h4>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">GetJsonToPbError</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic">// 获取上次转换错误描述</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">GetJsonToPbErrorCode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">              </span><span class="token comment" style="color:#999988;font-style:italic">// 获取上次转换错误码 (JsonToPbErrorCode)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="42-pb_to_jsonh-核心-api">4.2 <code>pb_to_json.h</code> 核心 API<a href="#42-pb_to_jsonh-核心-api" class="hash-link" aria-label="42-pb_to_jsonh-核心-api的直接链接" title="42-pb_to_jsonh-核心-api的直接链接" translate="no">​</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="1-protobuf-消息--json-字符串">1. Protobuf 消息 → JSON 字符串<a href="#1-protobuf-消息--json-字符串" class="hash-link" aria-label="1. Protobuf 消息 → JSON 字符串的直接链接" title="1. Protobuf 消息 → JSON 字符串的直接链接" translate="no">​</a></h4>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">bool</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">PbToJson</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> google</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">protobuf</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">Message</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> pb_msg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 输入: Protobuf 消息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">string</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> json_str</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">                    </span><span class="token comment" style="color:#999988;font-style:italic">// 输出: JSON 字符串</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> PbToJsonOptions</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> options </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">PbToJsonOptions</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 转换选项</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="2-protobuf-消息--merak-dom">2. Protobuf 消息 → Merak DOM<a href="#2-protobuf-消息--merak-dom" class="hash-link" aria-label="2. Protobuf 消息 → Merak DOM的直接链接" title="2. Protobuf 消息 → Merak DOM的直接链接" translate="no">​</a></h4>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">bool</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">PbToJson</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> google</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">protobuf</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">Message</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> pb_msg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 输入: Protobuf 消息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Value</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> json_val</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">                          </span><span class="token comment" style="color:#999988;font-style:italic">// 输出: Merak JSON Value（对象类型）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> PbToJsonOptions</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> options </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">PbToJsonOptions</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 转换选项</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="3-错误信息接口">3. 错误信息接口<a href="#3-错误信息接口" class="hash-link" aria-label="3. 错误信息接口的直接链接" title="3. 错误信息接口的直接链接" translate="no">​</a></h4>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">GetPbToJsonError</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic">// 获取上次转换错误描述</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">GetPbToJsonErrorCode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">              </span><span class="token comment" style="color:#999988;font-style:italic">// 获取上次转换错误码 (PbToJsonErrorCode)</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="5-注意事项">5. 注意事项<a href="#5-注意事项" class="hash-link" aria-label="5. 注意事项的直接链接" title="5. 注意事项的直接链接" translate="no">​</a></h2>
<ol>
<li class=""><strong>Protobuf 版本兼容性</strong>：仅支持 Protobuf 3.0+。Protobuf 2.x 中 <code>required</code>/<code>optional</code> 的行为可能不一致。</li>
<li class=""><strong>JSON 字段名匹配</strong>：默认情况下，Protobuf 字段名 <code>user_name</code> 映射到 JSON <code>userName</code>（camelCase）。若需使用原始字段名，请设置 <code>use_proto_field_name = true</code>。</li>
<li class=""><strong>枚举兼容性</strong>：默认枚举值（数字 0）必须存在（如 <code>STATUS_UNKNOWN = 0</code>），否则转换可能失败。</li>
<li class=""><strong>大数据处理</strong>：对于超大 Protobuf 消息（如 100MB+），可使用 Merak <code>FileReadStream</code> / <code>FileWriteStream</code> 分块处理，避免内存溢出。</li>
<li class=""><strong>线程安全</strong>：转换接口非线程安全。多线程环境中请为每个线程单独调用或添加锁保护。</li>
<li class=""><strong>默认值行为</strong>：Protobuf 3 中所有字段默认可选。默认值字段（如 0、false、空字符串）在 <code>output_default_values = false</code> 时不会包含在 JSON 中。</li>
</ol>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="6-常见问题-faqs">6. 常见问题 (FAQs)<a href="#6-常见问题-faqs" class="hash-link" aria-label="6. 常见问题 (FAQs)的直接链接" title="6. 常见问题 (FAQs)的直接链接" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="q1-json-中缺少必填-protobuf-字段会怎样">Q1: JSON 中缺少必填 Protobuf 字段会怎样？<a href="#q1-json-中缺少必填-protobuf-字段会怎样" class="hash-link" aria-label="Q1: JSON 中缺少必填 Protobuf 字段会怎样？的直接链接" title="Q1: JSON 中缺少必填 Protobuf 字段会怎样？的直接链接" translate="no">​</a></h3>
<p>A1: 默认 (<code>strict_required_fields = true</code>) 下，转换失败，报错 &quot;required field &#x27;xxx&#x27; not found&quot;。设置 <code>strict_required_fields = false</code> 可允许缺失字段（PB 消息使用默认值）。</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="q2-protobuf-oneof-字段在-json-中如何表示">Q2: Protobuf <code>oneof</code> 字段在 JSON 中如何表示？<a href="#q2-protobuf-oneof-字段在-json-中如何表示" class="hash-link" aria-label="q2-protobuf-oneof-字段在-json-中如何表示的直接链接" title="q2-protobuf-oneof-字段在-json-中如何表示的直接链接" translate="no">​</a></h3>
<p>A2: JSON 中只允许出现 oneof 的一个字段；若多个或无字段，转换失败（JSON → PB）。PB → JSON 时仅输出已设置的 oneof 字段。</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="q3-protobuf-bytes-字段如何处理">Q3: Protobuf <code>bytes</code> 字段如何处理？<a href="#q3-protobuf-bytes-字段如何处理" class="hash-link" aria-label="q3-protobuf-bytes-字段如何处理的直接链接" title="q3-protobuf-bytes-字段如何处理的直接链接" translate="no">​</a></h3>
<p>A3: 默认情况下，<code>bytes</code> 字段在 JSON 中表示为 Base64 字符串。可通过 <code>bytes_parse_mode</code>（JSON → PB）和 <code>bytes_output_mode</code>（PB → JSON）切换为原始字节。</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="q4-merak-的原地解析是否支持-json--pb-转换">Q4: Merak 的原地解析是否支持 JSON → PB 转换？<a href="#q4-merak-的原地解析是否支持-json--pb-转换" class="hash-link" aria-label="Q4: Merak 的原地解析是否支持 JSON → PB 转换？的直接链接" title="Q4: Merak 的原地解析是否支持 JSON → PB 转换？的直接链接" translate="no">​</a></h3>
<p>A4: 支持。若 JSON 字符串通过原地解析（in situ parsing）转换为 Merak DOM，则转换为 PB 时无需额外字符串复制，提高性能。</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="q5-如何格式化转换后的-json-输出">Q5: 如何格式化转换后的 JSON 输出？<a href="#q5-如何格式化转换后的-json-输出" class="hash-link" aria-label="Q5: 如何格式化转换后的 JSON 输出？的直接链接" title="Q5: 如何格式化转换后的 JSON 输出？的直接链接" translate="no">​</a></h3>
<p>A5: 可使用 Merak <code>PrettyWriter</code> 序列化 DOM，或直接设置 <code>PbToJsonOptions::pretty_print = true</code> 生成格式化 JSON 字符串。</p></div></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/cppdev/zh-cn/docs/foundamentals/json/performance"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">性能</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/cppdev/zh-cn/docs/rpc/"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">RPC 概览</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a><ul><li><a href="#core-features" class="table-of-contents__link toc-highlight">Core Features</a></li><li><a href="#dependencies" class="table-of-contents__link toc-highlight">Dependencies</a></li></ul></li><li><a href="#1-json-到-protobuf-json_to_pbh" class="table-of-contents__link toc-highlight">1. JSON 到 Protobuf (<code>json_to_pb.h</code>)</a><ul><li><a href="#11-基本使用" class="table-of-contents__link toc-highlight">1.1 基本使用</a></li><li><a href="#12-核心配置jsontopboptions" class="table-of-contents__link toc-highlight">1.2 核心配置：<code>JsonToPbOptions</code></a></li><li><a href="#13-字段映射规则" class="table-of-contents__link toc-highlight">1.3 字段映射规则</a></li><li><a href="#14-错误处理" class="table-of-contents__link toc-highlight">1.4 错误处理</a></li></ul></li><li><a href="#2-protobuf-到-json-pb_to_jsonh" class="table-of-contents__link toc-highlight">2. Protobuf 到 JSON (<code>pb_to_json.h</code>)</a><ul><li><a href="#21-基本使用" class="table-of-contents__link toc-highlight">2.1 基本使用</a></li><li><a href="#22-核心配置pbtojsonoptions" class="table-of-contents__link toc-highlight">2.2 核心配置：<code>PbToJsonOptions</code></a></li><li><a href="#23-字段映射规则" class="table-of-contents__link toc-highlight">2.3 字段映射规则</a></li><li><a href="#24-错误处理" class="table-of-contents__link toc-highlight">2.4 错误处理</a></li></ul></li><li><a href="#3-高级功能" class="table-of-contents__link toc-highlight">3. 高级功能</a><ul><li><a href="#31-动态-protobuf-消息处理" class="table-of-contents__link toc-highlight">3.1 动态 Protobuf 消息处理</a></li><li><a href="#32-自定义字段映射" class="table-of-contents__link toc-highlight">3.2 自定义字段映射</a></li><li><a href="#33-性能优化建议" class="table-of-contents__link toc-highlight">3.3 性能优化建议</a></li></ul></li><li><a href="#4-api-参考" class="table-of-contents__link toc-highlight">4. API 参考</a><ul><li><a href="#41-json_to_pbh-核心-api" class="table-of-contents__link toc-highlight">4.1 <code>json_to_pb.h</code> 核心 API</a></li><li><a href="#42-pb_to_jsonh-核心-api" class="table-of-contents__link toc-highlight">4.2 <code>pb_to_json.h</code> 核心 API</a></li></ul></li><li><a href="#5-注意事项" class="table-of-contents__link toc-highlight">5. 注意事项</a></li><li><a href="#6-常见问题-faqs" class="table-of-contents__link toc-highlight">6. 常见问题 (FAQs)</a><ul><li><a href="#q1-json-中缺少必填-protobuf-字段会怎样" class="table-of-contents__link toc-highlight">Q1: JSON 中缺少必填 Protobuf 字段会怎样？</a></li><li><a href="#q2-protobuf-oneof-字段在-json-中如何表示" class="table-of-contents__link toc-highlight">Q2: Protobuf <code>oneof</code> 字段在 JSON 中如何表示？</a></li><li><a href="#q3-protobuf-bytes-字段如何处理" class="table-of-contents__link toc-highlight">Q3: Protobuf <code>bytes</code> 字段如何处理？</a></li><li><a href="#q4-merak-的原地解析是否支持-json--pb-转换" class="table-of-contents__link toc-highlight">Q4: Merak 的原地解析是否支持 JSON → PB 转换？</a></li><li><a href="#q5-如何格式化转换后的-json-输出" class="table-of-contents__link toc-highlight">Q5: 如何格式化转换后的 JSON 输出？</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/cppdev/zh-cn/docs/intro">Tutorial</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://x.com/jefflothar" target="_blank" rel="noopener noreferrer" class="footer__link-item">X<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/cppdev/zh-cn/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/kumo-pub" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2026 Kumo, Inc.</div></div></div></footer></div>
</body>
</html>