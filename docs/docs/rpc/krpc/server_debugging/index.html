<!doctype html>
<html lang="en-GB" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-rpc/krpc/server_debugging" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">rpc调试 | Kumo Foundamental</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://your-docusaurus-site.example.com/cppdev/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://your-docusaurus-site.example.com/cppdev/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://your-docusaurus-site.example.com/cppdev/docs/rpc/krpc/server_debugging"><meta data-rh="true" property="og:locale" content="en_GB"><meta data-rh="true" property="og:locale:alternate" content="zh_cn"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="rpc调试 | Kumo Foundamental"><meta data-rh="true" name="description" content="1.检查工作线程的数量"><meta data-rh="true" property="og:description" content="1.检查工作线程的数量"><link data-rh="true" rel="icon" href="/cppdev/img/favicon.svg"><link data-rh="true" rel="canonical" href="https://your-docusaurus-site.example.com/cppdev/docs/rpc/krpc/server_debugging"><link data-rh="true" rel="alternate" href="https://your-docusaurus-site.example.com/cppdev/docs/rpc/krpc/server_debugging" hreflang="en-GB"><link data-rh="true" rel="alternate" href="https://your-docusaurus-site.example.com/cppdev/zh-cn/docs/rpc/krpc/server_debugging" hreflang="zh-cn"><link data-rh="true" rel="alternate" href="https://your-docusaurus-site.example.com/cppdev/docs/rpc/krpc/server_debugging" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"rpc","item":"https://your-docusaurus-site.example.com/cppdev/docs/rpc/"},{"@type":"ListItem","position":2,"name":"krpc","item":"https://your-docusaurus-site.example.com/cppdev/docs/rpc/krpc/"},{"@type":"ListItem","position":3,"name":"rpc调试","item":"https://your-docusaurus-site.example.com/cppdev/docs/rpc/krpc/server_debugging"}]}</script><link rel="alternate" type="application/rss+xml" href="/cppdev/blog/rss.xml" title="Kumo Foundamental RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/cppdev/blog/atom.xml" title="Kumo Foundamental Atom Feed"><link rel="stylesheet" href="/cppdev/assets/css/styles.a7490ef4.css">
<script src="/cppdev/assets/js/runtime~main.49afcf3f.js" defer="defer"></script>
<script src="/cppdev/assets/js/main.abbd5e2e.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/cppdev/img/kumo-logo.svg"><link rel="preload" as="image" href="/cppdev/assets/images/full_worker_usage-981258013b676899e0ec14a666369dd9.png"><link rel="preload" as="image" href="/cppdev/assets/images/normal_worker_usage-51473c9e6007877be4acb32a3eabad84.png"><link rel="preload" as="image" href="/cppdev/assets/images/high_cpu_usage-0807ef3845ef0ba6f85e8a6cb5786981.png"><link rel="preload" as="image" href="/cppdev/assets/images/normal_cpu_usage-6a0a8d80cecc30468e647de6fe150cf8.png"><link rel="preload" as="image" href="/cppdev/assets/images/kthread_creation_qps-71b321d33dd0e5054868d17ddb05120d.png"><link rel="preload" as="image" href="/cppdev/assets/images/kthread_concurrency_1-bb77917c691ba1b384425563753a68da.png"><link rel="preload" as="image" href="/cppdev/assets/images/kthread_concurrency_2-79ef37d84103e8c0ad7f42e4e6c3f812.png"><link rel="preload" as="image" href="/cppdev/assets/images/full_worker_usage_2-f2e4a502002a704b3701a75393be1d55.png"><link rel="preload" as="image" href="/cppdev/assets/images/rpcz-01a1a8b9b8f24259eedc4a0437703774.png"><link rel="preload" as="image" href="/cppdev/assets/images/rpcz_2-c18aaad8db4cfdb00806b74f527a9465.png"><link rel="preload" as="image" href="/cppdev/assets/images/rpcz_3-a6528d4c935db9db15479b2666ebde47.png"><link rel="preload" as="image" href="/cppdev/assets/images/foobar_kvar-1a9a79bd60ffc2c2a6c2e4570cb84e13.png"><link rel="preload" as="image" href="/cppdev/assets/images/foobar_latency_cdf-04f429a69ca646f351950b5f6b5559ea.png"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/cppdev/"><div class="navbar__logo"><img src="/cppdev/img/kumo-logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/cppdev/img/kumo-logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Foundamental</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/cppdev/docs/intro">Tutorial</a><a class="navbar__item navbar__link" href="/cppdev/docs/integration/overview">Integration</a><a class="navbar__item navbar__link" href="/cppdev/blog">Blog</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English</a><ul class="dropdown__menu"><li><a href="/cppdev/docs/rpc/krpc/server_debugging" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en-GB">English</a></li><li><a href="/cppdev/zh-cn/docs/rpc/krpc/server_debugging" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="zh-cn">中文（中国）</a></li></ul></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/cppdev/docs/intro"><span title="Overview" class="linkLabel_WmDU">Overview</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/cppdev/docs/category/foundamentals"><span title="Foundamentals" class="categoryLinkLabel_W154">Foundamentals</span></a><button aria-label="Expand sidebar category &#x27;Foundamentals&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--active" href="/cppdev/docs/rpc/"><span title="rpc" class="categoryLinkLabel_W154">rpc</span></a><button aria-label="Collapse sidebar category &#x27;rpc&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cppdev/docs/rpc/grpc"><span title="grpc" class="linkLabel_WmDU">grpc</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cppdev/docs/rpc/brpc"><span title="brpc" class="linkLabel_WmDU">brpc</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cppdev/docs/rpc/acl"><span title="acl" class="linkLabel_WmDU">acl</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cppdev/docs/rpc/httplib"><span title="httplib" class="linkLabel_WmDU">httplib</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cppdev/docs/rpc/protobuf"><span title="protobuf" class="linkLabel_WmDU">protobuf</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cppdev/docs/rpc/flatbuffers"><span title="flatbuffers" class="linkLabel_WmDU">flatbuffers</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cppdev/docs/rpc/shark"><span title="shark" class="linkLabel_WmDU">shark</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--active" tabindex="0" href="/cppdev/docs/rpc/krpc/"><span title="krpc" class="categoryLinkLabel_W154">krpc</span></a><button aria-label="Collapse sidebar category &#x27;krpc&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/cppdev/docs/rpc/krpc/getting_started"><span title="使用krpc" class="linkLabel_WmDU">使用krpc</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/cppdev/docs/rpc/krpc/server"><span title="服务开发" class="linkLabel_WmDU">服务开发</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/cppdev/docs/rpc/krpc/http_service"><span title="http服务" class="linkLabel_WmDU">http服务</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/cppdev/docs/rpc/krpc/thrift"><span title="Thrift服务" class="linkLabel_WmDU">Thrift服务</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/cppdev/docs/rpc/krpc/cpu_profiler"><span title="CPU使用分析" class="linkLabel_WmDU">CPU使用分析</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/cppdev/docs/rpc/krpc/heap_profiler"><span title="堆栈分析" class="linkLabel_WmDU">堆栈分析</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/cppdev/docs/rpc/krpc/contention_profiler"><span title="竞态分析" class="linkLabel_WmDU">竞态分析</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/cppdev/docs/rpc/krpc/dummy_server"><span title="server dummy" class="linkLabel_WmDU">server dummy</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/cppdev/docs/rpc/krpc/rpcz"><span title="rpc追踪" class="linkLabel_WmDU">rpc追踪</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/cppdev/docs/rpc/krpc/thread_local"><span title="thread local" class="linkLabel_WmDU">thread local</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/cppdev/docs/rpc/krpc/json2pb"><span title="json和protobuf转换" class="linkLabel_WmDU">json和protobuf转换</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/cppdev/docs/rpc/krpc/threading_overview"><span title="常见线程模型" class="linkLabel_WmDU">常见线程模型</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/cppdev/docs/rpc/krpc/atomic_instructions"><span title="atomic使用" class="linkLabel_WmDU">atomic使用</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/cppdev/docs/rpc/krpc/flags"><span title="flags使用" class="linkLabel_WmDU">flags使用</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/cppdev/docs/rpc/krpc/io"><span title="IO详解" class="linkLabel_WmDU">IO详解</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/cppdev/docs/rpc/krpc/streaming_rpc"><span title="流式rpc" class="linkLabel_WmDU">流式rpc</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/cppdev/docs/rpc/krpc/endpoint"><span title="EndPoint工具类" class="linkLabel_WmDU">EndPoint工具类</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/cppdev/docs/rpc/krpc/kumo_std"><span title="kumo标准协议" class="linkLabel_WmDU">kumo标准协议</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/cppdev/docs/rpc/krpc/client"><span title="客户端服务" class="linkLabel_WmDU">客户端服务</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/cppdev/docs/rpc/krpc/circuit_breaker"><span title="熔断功能" class="linkLabel_WmDU">熔断功能</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/cppdev/docs/rpc/krpc/connections"><span title="connections服务" class="linkLabel_WmDU">connections服务</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/cppdev/docs/rpc/krpc/lalb"><span title="lalb调度" class="linkLabel_WmDU">lalb调度</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/cppdev/docs/rpc/krpc/consistent_hashing"><span title="一致性hash" class="linkLabel_WmDU">一致性hash</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/cppdev/docs/rpc/krpc/http_client"><span title="http客户端" class="linkLabel_WmDU">http客户端</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/cppdev/docs/rpc/krpc/http_derivatives"><span title="http延展阅读" class="linkLabel_WmDU">http延展阅读</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/cppdev/docs/rpc/krpc/combo_channel"><span title="服务治理" class="linkLabel_WmDU">服务治理</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/cppdev/docs/rpc/krpc/memcache_client"><span title="memcached客户端" class="linkLabel_WmDU">memcached客户端</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/cppdev/docs/rpc/krpc/redis_client"><span title="redis支持" class="linkLabel_WmDU">redis支持</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/cppdev/docs/rpc/krpc/auto_concurrency_limiter"><span title="自适应限流" class="linkLabel_WmDU">自适应限流</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/cppdev/docs/rpc/krpc/server_debugging"><span title="rpc调试" class="linkLabel_WmDU">rpc调试</span></a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/cppdev/docs/retrieve/"><span title="Retrieve" class="categoryLinkLabel_W154">Retrieve</span></a><button aria-label="Expand sidebar category &#x27;Retrieve&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/cppdev/docs/store/"><span title="store" class="categoryLinkLabel_W154">store</span></a><button aria-label="Expand sidebar category &#x27;store&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/cppdev/docs/ir/"><span title="IR" class="categoryLinkLabel_W154">IR</span></a><button aria-label="Expand sidebar category &#x27;IR&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/cppdev/docs/advance/"><span title="advance" class="categoryLinkLabel_W154">advance</span></a><button aria-label="Expand sidebar category &#x27;advance&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/cppdev/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/cppdev/docs/rpc/"><span>rpc</span></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/cppdev/docs/rpc/krpc/"><span>krpc</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">rpc调试</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>rpc调试</h1></header>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="1检查工作线程的数量">1.检查工作线程的数量<a href="#1检查工作线程的数量" class="hash-link" aria-label="Direct link to 1.检查工作线程的数量" title="Direct link to 1.检查工作线程的数量" translate="no">​</a></h2>
<p>查看 /vars/kthread_worker_<strong>count</strong> 和 /vars/kthread_worker_<strong>usage</strong>。分别是工作线程的个数，和正在被使用的工作线程个数。</p>
<blockquote>
<p>如果usage和count接近，说明线程不够用了。</p>
</blockquote>
<p>比如，下图中有24个工作线程，正在使用的是23.93个，说明所有的工作线程都被打满了，不够用了。</p>
<!-- -->
<img src="/cppdev/assets/images/full_worker_usage-981258013b676899e0ec14a666369dd9.png">
<p>下图中正在使用的只有2.36个，工作线程明显是足够的。</p>
<!-- -->
<img src="/cppdev/assets/images/normal_worker_usage-51473c9e6007877be4acb32a3eabad84.png">
<p>把 /vars/kthread_worker_count;kthread_worker_usage?expand 拼在服务url后直接看到这两幅图，就像<a href="http://krpc.baidu.com:8765/vars/kthread_worker_count;kthread_worker_usage?expand" target="_blank" rel="noopener noreferrer" class="">这样</a>。</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="2检查cpu的使用程度">2.检查CPU的使用程度<a href="#2检查cpu的使用程度" class="hash-link" aria-label="Direct link to 2.检查CPU的使用程度" title="Direct link to 2.检查CPU的使用程度" translate="no">​</a></h2>
<p>查看 /vars/system_core_<strong>count</strong> 和 /vars/process_cpu_<strong>usage</strong>。分别是cpu核心的个数，和正在使用的cpu核数。</p>
<blockquote>
<p>如果usage和count接近，说明CPU不够用了。</p>
</blockquote>
<p>下图中cpu核数为24，正在使用的核心数是20.9个，CPU是瓶颈了。</p>
<!-- -->
<img src="/cppdev/assets/images/high_cpu_usage-0807ef3845ef0ba6f85e8a6cb5786981.png">
<p>下图中正在使用的核心数是2.06，CPU是够用的。</p>
<!-- -->
<img src="/cppdev/assets/images/normal_cpu_usage-6a0a8d80cecc30468e647de6fe150cf8.png">
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="3定位问题">3.定位问题<a href="#3定位问题" class="hash-link" aria-label="Direct link to 3.定位问题" title="Direct link to 3.定位问题" translate="no">​</a></h2>
<p>如果process_cpu_usage和kthread_worker_usage接近，说明是cpu-bound，工作线程大部分时间在做计算。</p>
<p>如果process_cpu_usage明显小于kthread_worker_usage，说明是io-bound，工作线程大部分时间在阻塞。</p>
<p>1 - process_cpu_usage / kthread_worker_usage就是大约在阻塞上花费的时间比例，比如process_cpu_usage = 2.4，kthread_worker_usage = 18.5，那么工作线程大约花费了87.1% 的时间在阻塞上。</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="31-定位cpu-bound问题">3.1 定位cpu-bound问题<a href="#31-定位cpu-bound问题" class="hash-link" aria-label="Direct link to 3.1 定位cpu-bound问题" title="Direct link to 3.1 定位cpu-bound问题" translate="no">​</a></h3>
<p>原因可能是单机性能不足，或上游分流不均。</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="排除上游分流不均的嫌疑">排除上游分流不均的嫌疑<a href="#排除上游分流不均的嫌疑" class="hash-link" aria-label="Direct link to 排除上游分流不均的嫌疑" title="Direct link to 排除上游分流不均的嫌疑" translate="no">​</a></h4>
<p>在不同服务的<a href="http://krpc.baidu.com:8765/vars" target="_blank" rel="noopener noreferrer" class="">vars界面</a>输入qps，查看不同的qps是否符合预期，就像这样：</p>
<!-- -->
<img src="/cppdev/assets/images/kthread_creation_qps-71b321d33dd0e5054868d17ddb05120d.png">
<p>或者在命令行中用curl直接访问，像这样：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ curl krpc.baidu.com:8765/vars/*qps*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kthread_creation_qps : 95</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rpc_server_8765_example_echo_service_echo_qps : 57</span><br></span></code></pre></div></div>
<p>如果不同机器的分流确实不均，且难以解决，可以考虑<a class="" href="/cppdev/docs/rpc/krpc/server#limiting-maximum-concurrency">限制最大并发</a>。</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="优化单机性能">优化单机性能<a href="#优化单机性能" class="hash-link" aria-label="Direct link to 优化单机性能" title="Direct link to 优化单机性能" translate="no">​</a></h4>
<p>请使用<a class="" href="/cppdev/docs/rpc/krpc/cpu_profiler">CPU profiler</a>分析程序的热点，用数据驱动优化。一般来说一个卡顿的cpu-bound程序一般能看到显著的热点。</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="32-定位io-bound问题">3.2 定位io-bound问题<a href="#32-定位io-bound问题" class="hash-link" aria-label="Direct link to 3.2 定位io-bound问题" title="Direct link to 3.2 定位io-bound问题" translate="no">​</a></h3>
<p>原因可能有：</p>
<ul>
<li class="">线程确实配少了</li>
<li class="">访问下游服务的client不支持kthread，且延时过长</li>
<li class="">阻塞来自程序内部的锁，IO等等。</li>
</ul>
<p>如果阻塞无法避免，考虑用异步。</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="排除工作线程数不够的嫌疑">排除工作线程数不够的嫌疑<a href="#排除工作线程数不够的嫌疑" class="hash-link" aria-label="Direct link to 排除工作线程数不够的嫌疑" title="Direct link to 排除工作线程数不够的嫌疑" translate="no">​</a></h4>
<p>如果线程数不够，你可以尝试动态调大工作线程数，切换到/flags页面，点击kthread_concurrency右边的(R):</p>
<!-- -->
<img src="/cppdev/assets/images/kthread_concurrency_1-bb77917c691ba1b384425563753a68da.png">
<p>进入后填入新的线程数确认即可：</p>
<!-- -->
<img src="/cppdev/assets/images/kthread_concurrency_2-79ef37d84103e8c0ad7f42e4e6c3f812.png">
<p>回到/flags界面可以看到kthread_concurrency已变成了新值。</p>
<!-- -->
<img src="data:image/png;base64,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">
<p>不过，调大线程数未必有用。如果工作线程是由于访问下游而大量阻塞，调大工作线程数是没有用的。因为真正的瓶颈在于后端的，调大线程后只是让每个线程的阻塞时间变得更长。</p>
<p>比如在我们这的例子中，调大线程后新增的工作线程仍然被打满了。</p>
<!-- -->
<img src="/cppdev/assets/images/full_worker_usage_2-f2e4a502002a704b3701a75393be1d55.png">
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="排除锁的嫌疑">排除锁的嫌疑<a href="#排除锁的嫌疑" class="hash-link" aria-label="Direct link to 排除锁的嫌疑" title="Direct link to 排除锁的嫌疑" translate="no">​</a></h4>
<p>如果程序被某把锁挡住了，也可能呈现出“io-bound”的特征。先用<a class="" href="/cppdev/docs/rpc/krpc/contention_profiler">contention profiler</a>排查锁的竞争状况。</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="使用rpcz">使用rpcz<a href="#使用rpcz" class="hash-link" aria-label="Direct link to 使用rpcz" title="Direct link to 使用rpcz" translate="no">​</a></h4>
<p>rpcz可以帮助你看到最近的所有请求，和处理它们时在每个阶段花费的时间（单位都是微秒）。</p>
<!-- -->
<img src="/cppdev/assets/images/rpcz-01a1a8b9b8f24259eedc4a0437703774.png">
<p>点击一个span链接后看到该次RPC何时开始，每个阶段花费的时间，何时结束。</p>
<!-- -->
<img src="/cppdev/assets/images/rpcz_2-c18aaad8db4cfdb00806b74f527a9465.png">
<p>这是一个典型的server在严重阻塞的例子。从接收到请求到开始运行花费了20ms，说明server已经没有足够的工作线程来及时完成工作了。</p>
<p>现在这个span的信息比较少，我们去程序里加一些。你可以使用TRACEPRINTF向rpcz打印日志。打印内容会嵌入在rpcz的时间流中。</p>
<!-- -->
<img src="data:image/png;base64,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">
<p>重新运行后，查看一个span，里面的打印内容果然包含了我们增加的TRACEPRINTF。</p>
<!-- -->
<img src="/cppdev/assets/images/rpcz_3-a6528d4c935db9db15479b2666ebde47.png">
<p>在运行到第一条TRACEPRINTF前，用户回调已运行了2051微秒（假设这符合我们的预期），紧接着foobar()却花费了8036微秒，我们本来以为这个函数会很快返回的。范围进一步缩小了。</p>
<p>重复这个过程，直到找到那个造成问题的函数。</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="使用kvar">使用kvar<a href="#使用kvar" class="hash-link" aria-label="Direct link to 使用kvar" title="Direct link to 使用kvar" translate="no">​</a></h4>
<p>TRACEPRINTF主要适合若干次的函数调用，如果一个函数调用了很多次，或者函数本身开销很小，每次都往rpcz打印日志是不合适的。这时候你可以使用kvar。</p>
<p><a class="" href="/cppdev/docs/rpc/krpc/kvar">kvar</a>是一个多线程下的计数库，可以以极低的开销统计用户递来的数值，相比“打日志大法”几乎不影响程序行为。你不用完全了解kvar的完整用法，只要使用kvar::LatencyRecorder即可。</p>
<p>仿照如下代码对foobar的运行时间进行监控。</p>
<div class="language-c++ codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-c++ codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;kutil/time.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#include &lt;kvar/kvar.h&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kvar::LatencyRecorder g_foobar_latency(&quot;foobar&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void search() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    kutil::Timer tm;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tm.start();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    foobar();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tm.stop();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    g_foobar_latency &lt;&lt; tm.u_elapsed();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>重新运行程序后，在vars的搜索框中键入foobar，显示如下：</p>
<!-- -->
<img src="/cppdev/assets/images/foobar_kvar-1a9a79bd60ffc2c2a6c2e4570cb84e13.png">
<p>点击一个kvar可以看到动态图，比如点击cdf后看到</p>
<!-- -->
<img src="/cppdev/assets/images/foobar_latency_cdf-04f429a69ca646f351950b5f6b5559ea.png">
<p>根据延时的分布，你可以推测出这个函数的整体行为，对大多数请求表现如何，对长尾表现如何。</p>
<p>你可以在子函数中继续这个过程，增加更多kvar，并比对不同的分布，最后定位来源。</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="只使用了krpc-client">只使用了krpc client<a href="#只使用了krpc-client" class="hash-link" aria-label="Direct link to 只使用了krpc client" title="Direct link to 只使用了krpc client" translate="no">​</a></h4>
<p>得打开dummy server提供内置服务，方法见<a class="" href="/cppdev/docs/rpc/krpc/dummy_server">这里</a>。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_WFHX"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/rpc/krpc/server_debugging.mdx" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/cppdev/docs/rpc/krpc/auto_concurrency_limiter"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">自适应限流</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/cppdev/docs/retrieve/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">retrieve</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1检查工作线程的数量" class="table-of-contents__link toc-highlight">1.检查工作线程的数量</a></li><li><a href="#2检查cpu的使用程度" class="table-of-contents__link toc-highlight">2.检查CPU的使用程度</a></li><li><a href="#3定位问题" class="table-of-contents__link toc-highlight">3.定位问题</a><ul><li><a href="#31-定位cpu-bound问题" class="table-of-contents__link toc-highlight">3.1 定位cpu-bound问题</a></li><li><a href="#32-定位io-bound问题" class="table-of-contents__link toc-highlight">3.2 定位io-bound问题</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/cppdev/docs/intro">Tutorial</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://x.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">X<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/cppdev/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/kumo-pub" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Kumo, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>