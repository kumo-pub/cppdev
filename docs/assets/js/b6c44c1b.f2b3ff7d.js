"use strict";(globalThis.webpackChunkwebsite=globalThis.webpackChunkwebsite||[]).push([[160],{7867:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>l,contentTitle:()=>d,default:()=>h,frontMatter:()=>i,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"store/kv/lmdb","title":"LMDB","description":"LMDB (Lightning Memory-Mapped Database) is an embedded key\u2013value store used by Kumo","source":"@site/docs/store/kv/lmdb.mdx","sourceDirName":"store/kv","slug":"/store/kv/lmdb","permalink":"/cppdev/docs/store/kv/lmdb","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"title":"LMDB"},"sidebar":"tutorialSidebar","previous":{"title":"LevelDB","permalink":"/cppdev/docs/store/kv/leveldb"},"next":{"title":"Cloud Storage Overview","permalink":"/cppdev/docs/store/cloud/"}}');var s=r(4848),a=r(8453);const i={title:"LMDB"},d=void 0,l={},c=[{value:"1. Performance characteristics",id:"performance-characteristics",level:2},{value:"2. C++ API usage",id:"api",level:2},{value:"Open an environment",id:"open-an-environment",level:3},{value:"Begin a transaction",id:"begin-a-transaction",level:3},{value:"Open a database",id:"open-a-database",level:3},{value:"Put (Set)",id:"put-set",level:3},{value:"Get",id:"get",level:3},{value:"Commit transaction",id:"commit-transaction",level:3},{value:"Abort transaction",id:"abort-transaction",level:3},{value:"Close database and environment",id:"close-database-and-environment",level:3},{value:"3. On-disk directory structure",id:"3-on-disk-directory-structure",level:2},{value:"Summary",id:"summary",level:2}];function o(e){const n={admonition:"admonition",code:"code",h2:"h2",h3:"h3",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,a.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.p,{children:"LMDB (Lightning Memory-Mapped Database) is an embedded key\u2013value store used by Kumo\nfor transactional, high-performance local metadata and small control-plane data."}),"\n",(0,s.jsxs)(n.p,{children:["This page documents its ",(0,s.jsx)(n.strong,{children:"performance characteristics"}),", ",(0,s.jsx)(n.strong,{children:"C++ API usage"}),",\nand ",(0,s.jsx)(n.strong,{children:"on-disk layout"})," as they relate to Kumo."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"performance-characteristics",children:"1. Performance characteristics"}),"\n",(0,s.jsx)(n.p,{children:"LMDB is optimized for:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Fully ACID transactions"}),"\n",(0,s.jsx)(n.li,{children:"Memory-mapped I/O"}),"\n",(0,s.jsx)(n.li,{children:"Single-writer, multiple-reader concurrency"}),"\n",(0,s.jsx)(n.li,{children:"Ordered iteration by key"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Typical characteristics (single node, SSD/NVMe storage):"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Metric"}),(0,s.jsx)(n.th,{children:"Typical range"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Point lookup (Get)"}),(0,s.jsx)(n.td,{children:"~1\u201320 \xb5s"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Sequential scan"}),(0,s.jsx)(n.td,{children:"Memory bandwidth bound"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Write throughput"}),(0,s.jsx)(n.td,{children:"50\u2013300 MB/s (single writer)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Read concurrency"}),(0,s.jsx)(n.td,{children:"Unlimited (multi-reader)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Memory usage"}),(0,s.jsx)(n.td,{children:"Mostly mapped file size + page cache"})]})]})]}),"\n",(0,s.jsx)(n.admonition,{title:"TIPS",type:"warning",children:(0,s.jsxs)(n.p,{children:["LMDB maps the entire database into memory.\nFor Kumo control-plane usage, the total dataset ",(0,s.jsx)(n.strong,{children:"should typically not exceed 1\u20132 GB per node"}),".\nExceeding this may lead to memory pressure and slower writes."]})}),"\n",(0,s.jsxs)(n.p,{children:["LMDB is best suited for ",(0,s.jsx)(n.strong,{children:"embedded workloads"})," where:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Transactional guarantees are required"}),"\n",(0,s.jsx)(n.li,{children:"Reads dominate writes"}),"\n",(0,s.jsx)(n.li,{children:"Dataset fits comfortably in virtual memory"}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"api",children:"2. C++ API usage"}),"\n",(0,s.jsx)(n.p,{children:"Kumo uses the native LMDB C API via C++ wrappers."}),"\n",(0,s.jsx)(n.h3,{id:"open-an-environment",children:"Open an environment"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cpp",children:'#include <lmdb.h>\n\nMDB_env* env;\nint rc = mdb_env_create(&env);\nmdb_env_set_maxdbs(env, 16);\nmdb_env_set_mapsize(env, 1UL * 1024 * 1024 * 1024); // 1 GB\nrc = mdb_env_open(env, "/data/kumo/lmdb", 0, 0664);\n'})}),"\n",(0,s.jsx)(n.h3,{id:"begin-a-transaction",children:"Begin a transaction"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cpp",children:"MDB_txn* txn;\nrc = mdb_txn_begin(env, nullptr, 0, &txn); // 0 = read-write\n"})}),"\n",(0,s.jsx)(n.h3,{id:"open-a-database",children:"Open a database"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cpp",children:"MDB_dbi dbi;\nrc = mdb_dbi_open(txn, nullptr, 0, &dbi); // nullptr = default DB\n"})}),"\n",(0,s.jsx)(n.h3,{id:"put-set",children:"Put (Set)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cpp",children:'MDB_val key, data;\nkey.mv_size = strlen("key1");\nkey.mv_data = (void*)"key1";\ndata.mv_size = strlen("value1");\ndata.mv_data = (void*)"value1";\n\nrc = mdb_put(txn, dbi, &key, &data, 0);\n'})}),"\n",(0,s.jsx)(n.h3,{id:"get",children:"Get"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cpp",children:"MDB_val val;\nrc = mdb_get(txn, dbi, &key, &val);\nif (rc == 0) {\n    std::string value((char*)val.mv_data, val.mv_size);\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"commit-transaction",children:"Commit transaction"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cpp",children:"rc = mdb_txn_commit(txn);\n"})}),"\n",(0,s.jsx)(n.h3,{id:"abort-transaction",children:"Abort transaction"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cpp",children:"mdb_txn_abort(txn); // undo changes\n"})}),"\n",(0,s.jsx)(n.h3,{id:"close-database-and-environment",children:"Close database and environment"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-cpp",children:"mdb_dbi_close(env, dbi);\nmdb_env_close(env);\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"3-on-disk-directory-structure",children:"3. On-disk directory structure"}),"\n",(0,s.jsx)(n.p,{children:"A typical LMDB environment directory looks like:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"/data/kumo/lmdb/\n\u251c\u2500\u2500 data.mdb\n\u251c\u2500\u2500 lock.mdb\n"})}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"File"}),(0,s.jsx)(n.th,{children:"Purpose"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"data.mdb"})}),(0,s.jsx)(n.td,{children:"Memory-mapped database file"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"lock.mdb"})}),(0,s.jsx)(n.td,{children:"Lock file for single-writer concurrency"})]})]})]}),"\n",(0,s.jsxs)(n.p,{children:["LMDB uses a ",(0,s.jsx)(n.strong,{children:"memory-mapped file"})," and keeps all B+ tree pages in memory.\nNo background compaction is required. The database grows automatically but\nrequires ",(0,s.jsx)(n.strong,{children:"predefined map size"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["Applications should treat the environment as ",(0,s.jsx)(n.strong,{children:"opaque"})," and avoid manual edits."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"summary",children:"Summary"}),"\n",(0,s.jsx)(n.p,{children:"LMDB provides:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Embedded, memory-mapped KV interface"}),"\n",(0,s.jsx)(n.li,{children:"Full ACID transactions"}),"\n",(0,s.jsx)(n.li,{children:"Very low read latency and multi-reader concurrency"}),"\n",(0,s.jsx)(n.li,{children:"Simple, compact on-disk format"}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["It is well suited for Kumo\u2019s ",(0,s.jsx)(n.strong,{children:"transactional local metadata"})," and small control-plane datasets."]})]})}function h(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(o,{...e})}):o(e)}},8453:(e,n,r)=>{r.d(n,{R:()=>i,x:()=>d});var t=r(6540);const s={},a=t.createContext(s);function i(e){const n=t.useContext(a);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),t.createElement(a.Provider,{value:n},e.children)}}}]);