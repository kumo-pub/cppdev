"use strict";(globalThis.webpackChunkwebsite=globalThis.webpackChunkwebsite||[]).push([[8911],{4868:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>a,contentTitle:()=>l,default:()=>h,frontMatter:()=>r,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"store/kv/rocksdb/config","title":"RocksDB Configuration and Initialization","description":"RocksDB is a high-performance key-value store widely used in Kumo for local metadata, control-plane state, and small structured data.","source":"@site/docs/store/kv/rocksdb/config.mdx","sourceDirName":"store/kv/rocksdb","slug":"/store/kv/rocksdb/config","permalink":"/cppdev/docs/store/kv/rocksdb/config","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"title":"RocksDB Configuration and Initialization"},"sidebar":"tutorialSidebar","previous":{"title":"RocksDB Types","permalink":"/cppdev/docs/store/kv/rocksdb/types"},"next":{"title":"RocksDB Snapshot and SST Loading","permalink":"/cppdev/docs/store/kv/rocksdb/snapshot"}}');var o=s(4848),t=s(8453);const r={title:"RocksDB Configuration and Initialization"},l=void 0,a={},c=[{value:"1. Configuration Overview",id:"config-overview",level:2},{value:"2. Native RocksDB Initialization",id:"native-init",level:2},{value:"2.1 Prepare DB Options",id:"21-prepare-db-options",level:3},{value:"2.2 Prepare Column Family Options",id:"22-prepare-column-family-options",level:3},{value:"2.3 Prepare Table Options",id:"23-prepare-table-options",level:3},{value:"2.4 Open the Database",id:"24-open-the-database",level:3},{value:"2.5 Write and Read Options",id:"25-write-and-read-options",level:3},{value:"2.6 TransactionDB Initialization (Optional)",id:"26-transactiondb-initialization-optional",level:3},{value:"3. Column Family Considerations",id:"column-family",level:2},{value:"4. Configuration Impact and Best Practices",id:"config-impact",level:2},{value:"5. Summary",id:"summary",level:2}];function d(e){const n={blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)(n.p,{children:["RocksDB is a high-performance key-value store widely used in Kumo for ",(0,o.jsx)(n.strong,{children:"local metadata, control-plane state, and small structured data"}),".\nThis document describes the ",(0,o.jsx)(n.strong,{children:"configuration modules"}),", ",(0,o.jsx)(n.strong,{children:"native initialization workflow"}),", ",(0,o.jsx)(n.strong,{children:"column family considerations"}),", and the ",(0,o.jsx)(n.strong,{children:"impact of key configuration options"}),"."]}),"\n",(0,o.jsx)(n.hr,{}),"\n",(0,o.jsx)(n.h2,{id:"config-overview",children:"1. Configuration Overview"}),"\n",(0,o.jsx)(n.p,{children:"RocksDB exposes several layers of configuration. Understanding them is crucial for predictable performance:"}),"\n",(0,o.jsxs)(n.table,{children:[(0,o.jsx)(n.thead,{children:(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.th,{children:"Layer"}),(0,o.jsx)(n.th,{children:"Scope"}),(0,o.jsx)(n.th,{children:"Description"})]})}),(0,o.jsxs)(n.tbody,{children:[(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.td,{children:(0,o.jsx)(n.strong,{children:"DB Options"})}),(0,o.jsx)(n.td,{children:"Entire database"}),(0,o.jsx)(n.td,{children:"Global settings: parallelism, background jobs, WAL behavior, direct I/O, statistics."})]}),(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.td,{children:(0,o.jsx)(n.strong,{children:"ColumnFamilyOptions (CF Options)"})}),(0,o.jsx)(n.td,{children:"Per column family"}),(0,o.jsx)(n.td,{children:"Compaction style, write buffer size, merge operators, compression, Bloom filters, Blob files."})]}),(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.td,{children:(0,o.jsx)(n.strong,{children:"TableOptions / BlockBasedTableOptions"})}),(0,o.jsx)(n.td,{children:"Per CF, per table"}),(0,o.jsx)(n.td,{children:"SSTable layout: block size, cache policy, index/filter type, partitioned index filters."})]}),(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.td,{children:(0,o.jsx)(n.strong,{children:"WriteOptions"})}),(0,o.jsx)(n.td,{children:"Per-write"}),(0,o.jsx)(n.td,{children:"WAL sync, asynchronous flush, durability guarantees."})]}),(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.td,{children:(0,o.jsx)(n.strong,{children:"ReadOptions"})}),(0,o.jsx)(n.td,{children:"Per-read"}),(0,o.jsx)(n.td,{children:"Snapshots, cache usage, prefix seeks."})]}),(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.td,{children:(0,o.jsx)(n.strong,{children:"TransactionDBOptions"})}),(0,o.jsx)(n.td,{children:"Transaction-enabled DB"}),(0,o.jsx)(n.td,{children:"Lock timeouts, custom mutex factories."})]})]})]}),"\n",(0,o.jsx)(n.p,{children:"Typical tuning targets:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Write throughput"})," \u2192 ",(0,o.jsx)(n.code,{children:"WriteBufferSize"}),", ",(0,o.jsx)(n.code,{children:"MaxWriteBufferNumber"}),", ",(0,o.jsx)(n.code,{children:"Level0FileNumCompactionTrigger"})]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Read latency"})," \u2192 ",(0,o.jsx)(n.code,{children:"BlockCache"}),", ",(0,o.jsx)(n.code,{children:"FilterPolicy"}),", ",(0,o.jsx)(n.code,{children:"BloomFilter"}),", ",(0,o.jsx)(n.code,{children:"PartitionedIndexFilters"})]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Disk usage"})," \u2192 ",(0,o.jsx)(n.code,{children:"Compression"}),", ",(0,o.jsx)(n.code,{children:"TargetFileSizeBase"}),", ",(0,o.jsx)(n.code,{children:"MaxBytesForLevelBase"})]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Transactional guarantees"})," \u2192 ",(0,o.jsx)(n.code,{children:"TransactionDBOptions"}),", lock timeout"]}),"\n"]}),"\n",(0,o.jsx)(n.hr,{}),"\n",(0,o.jsx)(n.h2,{id:"native-init",children:"2. Native RocksDB Initialization"}),"\n",(0,o.jsx)(n.p,{children:"The standard sequence to initialize a RocksDB instance is:"}),"\n",(0,o.jsx)(n.h3,{id:"21-prepare-db-options",children:"2.1 Prepare DB Options"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-cpp",children:"#include <rocksdb/db.h>\n#include <rocksdb/options.h>\n\nrocksdb::Options db_options;\ndb_options.create_if_missing = true;\ndb_options.IncreaseParallelism(8);          // background threads\ndb_options.max_background_compactions = 8;  // compaction threads\ndb_options.use_direct_reads = false;\ndb_options.use_direct_io_for_flush_and_compaction = false;\ndb_options.statistics = rocksdb::CreateDBStatistics();\n"})}),"\n",(0,o.jsx)(n.h3,{id:"22-prepare-column-family-options",children:"2.2 Prepare Column Family Options"}),"\n",(0,o.jsx)(n.p,{children:"Each column family may have specific options:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-cpp",children:"rocksdb::ColumnFamilyOptions cf_options;\ncf_options.OptimizeLevelStyleCompaction();\ncf_options.write_buffer_size = 128 * 1024 * 1024;  // 128MB\ncf_options.max_write_buffer_number = 4;\ncf_options.min_write_buffer_number_to_merge = 2;\ncf_options.level0_file_num_compaction_trigger = 4;\ncf_options.compression = rocksdb::kLZ4Compression;\n"})}),"\n",(0,o.jsx)(n.h3,{id:"23-prepare-table-options",children:"2.3 Prepare Table Options"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-cpp",children:"rocksdb::BlockBasedTableOptions table_options;\ntable_options.block_size = 64 * 1024; // 64 KB\ntable_options.block_cache = rocksdb::NewLRUCache(8 * 1024 * 1024 * 1024ULL); // 8GB\ntable_options.filter_policy.reset(rocksdb::NewBloomFilterPolicy(10, false));\n"})}),"\n",(0,o.jsx)(n.p,{children:"Assign table options to CF:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-cpp",children:"cf_options.table_factory.reset(\n    rocksdb::NewBlockBasedTableFactory(table_options)\n);\n"})}),"\n",(0,o.jsx)(n.h3,{id:"24-open-the-database",children:"2.4 Open the Database"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-cpp",children:'rocksdb::DB* db;\nstd::vector<std::string> cf_names = {"default", "meta", "data"};\nstd::vector<rocksdb::ColumnFamilyDescriptor> cf_descs;\n\nfor (const auto& name : cf_names) {\n    cf_descs.emplace_back(name, cf_options);\n}\n\nstd::vector<rocksdb::ColumnFamilyHandle*> cf_handles;\nrocksdb::Status s = rocksdb::DB::Open(db_options, "/data/kumo/rocksdb", cf_descs, &cf_handles, &db);\nif (!s.ok()) {\n    // handle error\n}\n'})}),"\n",(0,o.jsx)(n.h3,{id:"25-write-and-read-options",children:"2.5 Write and Read Options"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-cpp",children:"rocksdb::WriteOptions write_options;\nwrite_options.sync = true; // ensures WAL durability\n\nrocksdb::ReadOptions read_options;\nread_options.fill_cache = true; // utilize block cache\n"})}),"\n",(0,o.jsx)(n.h3,{id:"26-transactiondb-initialization-optional",children:"2.6 TransactionDB Initialization (Optional)"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-cpp",children:'#include <rocksdb/utilities/transaction_db.h>\n\nrocksdb::TransactionDBOptions txn_options;\ntxn_options.transaction_lock_timeout = 20000; // ms\ntxn_options.default_lock_timeout = 30000;     // ms\n\nrocksdb::TransactionDB* txn_db;\nrocksdb::Status s_txn = rocksdb::TransactionDB::Open(\n    db_options, txn_options, "/data/kumo/rocksdb_txn", &txn_db\n);\n'})}),"\n",(0,o.jsx)(n.hr,{}),"\n",(0,o.jsx)(n.h2,{id:"column-family",children:"3. Column Family Considerations"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Default CF"}),": Always required. Do not delete or rename."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Multiple CFs"}),": Useful to separate ",(0,o.jsx)(n.strong,{children:"metadata"}),", ",(0,o.jsx)(n.strong,{children:"OLAP data"}),", and ",(0,o.jsx)(n.strong,{children:"write-heavy data"}),"."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Option isolation"}),": Each CF can have distinct compaction, compression, and table options."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"CF handles"}),": Must be properly closed to avoid memory leaks."]}),"\n"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-cpp",children:"for (auto handle : cf_handles) {\n    db->DestroyColumnFamilyHandle(handle);\n}\ndelete db;\n"})}),"\n",(0,o.jsxs)(n.blockquote,{children:["\n",(0,o.jsxs)(n.p,{children:["Tip: Initialize all column families ",(0,o.jsx)(n.strong,{children:"before any writes"})," to avoid runtime errors or inconsistent options."]}),"\n"]}),"\n",(0,o.jsx)(n.hr,{}),"\n",(0,o.jsx)(n.h2,{id:"config-impact",children:"4. Configuration Impact and Best Practices"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"WriteOptions.sync = true"})," ensures durability but slows down throughput."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Block cache size"})," balances memory usage vs read latency."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Write buffer size and number"})," control memtable flush frequency and compaction load."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Compression per level"})," affects disk space and read amplification."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"Level0 compaction triggers"})," prevent stalls during burst writes."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"TransactionDB lock timeouts"})," must be tuned based on workload concurrency."]}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"Guidelines:"})}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["Avoid excessive small SST files \u2192 tune ",(0,o.jsx)(n.code,{children:"Level0FileNumCompactionTrigger"})," and ",(0,o.jsx)(n.code,{children:"TargetFileSizeBase"}),"."]}),"\n",(0,o.jsxs)(n.li,{children:["Use ",(0,o.jsx)(n.strong,{children:"column-family separation"})," to isolate workloads."]}),"\n",(0,o.jsxs)(n.li,{children:["For ",(0,o.jsx)(n.strong,{children:"OLAP-heavy workloads"}),", consider disabling Bloom filters to reduce CPU overhead."]}),"\n",(0,o.jsxs)(n.li,{children:["Monitor ",(0,o.jsx)(n.strong,{children:"pending compaction bytes"})," to prevent write stalls."]}),"\n"]}),"\n",(0,o.jsx)(n.hr,{}),"\n",(0,o.jsx)(n.h2,{id:"summary",children:"5. Summary"}),"\n",(0,o.jsx)(n.p,{children:"RocksDB initialization involves:"}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["Configuring ",(0,o.jsx)(n.strong,{children:"DB-level options"})," (parallelism, WAL, direct I/O)."]}),"\n",(0,o.jsxs)(n.li,{children:["Configuring ",(0,o.jsx)(n.strong,{children:"Column Family options"})," (compaction, write buffers, compression)."]}),"\n",(0,o.jsxs)(n.li,{children:["Configuring ",(0,o.jsx)(n.strong,{children:"Table options"})," (block size, cache, Bloom filters)."]}),"\n",(0,o.jsxs)(n.li,{children:["Opening the database and all required ",(0,o.jsx)(n.strong,{children:"column families"}),"."]}),"\n",(0,o.jsxs)(n.li,{children:["Optionally enabling ",(0,o.jsx)(n.strong,{children:"TransactionDB"})," for multi-key transactional semantics."]}),"\n"]}),"\n",(0,o.jsxs)(n.p,{children:["Careful tuning of these options is essential for achieving ",(0,o.jsx)(n.strong,{children:"high throughput, predictable latency, and efficient resource usage"})," in Kumo's key-value storage scenarios."]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>r,x:()=>l});var i=s(6540);const o={},t=i.createContext(o);function r(e){const n=i.useContext(t);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:r(e.components),i.createElement(t.Provider,{value:n},e.children)}}}]);