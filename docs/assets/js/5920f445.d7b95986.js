"use strict";(globalThis.webpackChunkwebsite=globalThis.webpackChunkwebsite||[]).push([[1904],{6054:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>h,contentTitle:()=>d,default:()=>x,frontMatter:()=>a,metadata:()=>p,toc:()=>f});const p=JSON.parse('{"id":"rpc/krpc/heap_profiler","title":"\u5806\u6808\u5206\u6790","description":"krpc\u53ef\u4ee5\u5206\u6790\u5185\u5b58\u662f\u88ab\u54ea\u4e9b\u51fd\u6570\u5360\u636e\u7684\u3002heap profiler\u7684\u539f\u7406\u662f\u6bcf\u5206\u914d\u6ee1\u4e00\u4e9b\u5185\u5b58\u5c31\u91c7\u6837\u8c03\u7528\u5904\u7684\u6808\uff0c\u201c\u4e00\u4e9b\u201d\u7531\u73af\u5883\u53d8\u91cfTCMALLOCSAMPLEPARAMETER\u63a7\u5236\uff0c\u9ed8\u8ba4524288\uff0c\u5373512K\u5b57\u8282\u3002\u6839\u636e\u6808\u8868\u73b0\u51fa\u7684\u51fd\u6570\u8c03\u7528\u5173\u7cfb\u6c47\u603b\u4e3a\u6211\u4eec\u770b\u5230\u7684\u7ed3\u679c\u56fe\u3002\u5728\u5b9e\u8df5\u4e2dheap profiler\u5bf9\u539f\u7a0b\u5e8f\u7684\u5f71\u54cd\u4e0d\u660e\u663e\u3002","source":"@site/docs/rpc/krpc/heap_profiler.mdx","sourceDirName":"rpc/krpc","slug":"/rpc/krpc/heap_profiler","permalink":"/cppdev/docs/rpc/krpc/heap_profiler","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"CPU\u4f7f\u7528\u5206\u6790","permalink":"/cppdev/docs/rpc/krpc/cpu_profiler"},"next":{"title":"\u7ade\u6001\u5206\u6790","permalink":"/cppdev/docs/rpc/krpc/contention_profiler"}}');var o=n(4848),l=n(8453);const i=n.p+"assets/images/heap_profiler_1-58b5efbe3873563ff4bc3c7474589559.png",c=n.p+"assets/images/heap_profiler_2-7f9bac6c33692ecb58ade2508593e215.png",t=n.p+"assets/images/heap_profiler_3-d2e90c405944ac26ed03d9c97397c792.gif",s=n.p+"assets/images/growth_profiler-3662bd0bf4b03c20e3b5ce02d0df82ac.png",a={},d="\u5806\u6808\u5206\u6790",h={},f=[{value:"\u5f00\u542f\u65b9\u6cd5",id:"\u5f00\u542f\u65b9\u6cd5",level:2},{value:"\u56fe\u793a",id:"\u56fe\u793a",level:2},{value:"MacOS\u7684\u989d\u5916\u914d\u7f6e",id:"macos\u7684\u989d\u5916\u914d\u7f6e",level:2}];function u(e){const r={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,l.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(r.header,{children:(0,o.jsx)(r.h1,{id:"\u5806\u6808\u5206\u6790",children:"\u5806\u6808\u5206\u6790"})}),"\n",(0,o.jsx)(r.p,{children:"krpc\u53ef\u4ee5\u5206\u6790\u5185\u5b58\u662f\u88ab\u54ea\u4e9b\u51fd\u6570\u5360\u636e\u7684\u3002heap profiler\u7684\u539f\u7406\u662f\u6bcf\u5206\u914d\u6ee1\u4e00\u4e9b\u5185\u5b58\u5c31\u91c7\u6837\u8c03\u7528\u5904\u7684\u6808\uff0c\u201c\u4e00\u4e9b\u201d\u7531\u73af\u5883\u53d8\u91cfTCMALLOC_SAMPLE_PARAMETER\u63a7\u5236\uff0c\u9ed8\u8ba4524288\uff0c\u5373512K\u5b57\u8282\u3002\u6839\u636e\u6808\u8868\u73b0\u51fa\u7684\u51fd\u6570\u8c03\u7528\u5173\u7cfb\u6c47\u603b\u4e3a\u6211\u4eec\u770b\u5230\u7684\u7ed3\u679c\u56fe\u3002\u5728\u5b9e\u8df5\u4e2dheap profiler\u5bf9\u539f\u7a0b\u5e8f\u7684\u5f71\u54cd\u4e0d\u660e\u663e\u3002"}),"\n",(0,o.jsx)(r.h2,{id:"\u5f00\u542f\u65b9\u6cd5",children:"\u5f00\u542f\u65b9\u6cd5"}),"\n",(0,o.jsxs)(r.ol,{children:["\n",(0,o.jsxs)(r.li,{children:["\n",(0,o.jsxs)(r.p,{children:["\u94fe\u63a5",(0,o.jsx)(r.code,{children:"libtcmalloc_and_profiler.a"})]}),"\n",(0,o.jsxs)(r.ol,{children:["\n",(0,o.jsxs)(r.li,{children:["\u5982\u679ctcmalloc\u4f7f\u7528frame pointer\u800c\u4e0d\u662flibunwind\u56de\u6eaf\u6808\uff0c\u8bf7\u786e\u4fdd\u5728CXXFLAGS\u6216CFLAGS\u4e2d\u52a0\u4e0a",(0,o.jsx)(r.code,{children:"-fno-omit-frame-pointer"}),"\uff0c\u5426\u5219\u51fd\u6570\u95f4\u7684\u8c03\u7528\u5173\u7cfb\u4f1a\u4e22\u5931\uff0c\u6700\u540e\u4ea7\u751f\u7684\u56fe\u7247\u4e2d\u90fd\u662f\u5f7c\u6b64\u72ec\u7acb\u7684\u51fd\u6570\u65b9\u6846\u3002"]}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(r.li,{children:["\n",(0,o.jsxs)(r.p,{children:["\u5728shell\u4e2d",(0,o.jsx)(r.code,{children:"export TCMALLOC_SAMPLE_PARAMETER=524288"}),"\u3002\u8be5\u53d8\u91cf\u6307\u6bcf\u5206\u914d\u8fd9\u4e48\u591a\u5b57\u8282\u5185\u5b58\u65f6\u505a\u4e00\u6b21\u7edf\u8ba1\uff0c\u9ed8\u8ba4\u4e3a0\uff0c\u4ee3\u8868\u4e0d\u5f00\u542f\u5185\u5b58\u7edf\u8ba1\u3002",(0,o.jsx)(r.a,{href:"http://goog-perftools.sourceforge.net/doc/tcmalloc.html",children:"\u5b98\u65b9\u6587\u6863"}),"\u5efa\u8bae\u8bbe\u7f6e\u4e3a524288\u3002\u8fd9\u4e2a\u53d8\u91cf\u4e5f\u53ef\u5728\u8fd0\u884c\u524d\u4e34\u65f6\u8bbe\u7f6e\uff0c\u5982",(0,o.jsx)(r.code,{children:"TCMALLOC_SAMPLE_PARAMETER=524288 ./server"}),"\u3002\u5982\u679c\u6ca1\u6709\u8fd9\u4e2a\u73af\u5883\u53d8\u91cf\uff0c\u53ef\u80fd\u4f1a\u770b\u5230\u8fd9\u6837\u7684\u7ed3\u679c\uff1a"]}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{children:"$ tools/pprof --text localhost:9002/pprof/heap           \nFetching /pprof/heap profile from http://localhost:9002/pprof/heap to\n  /home/gejun/pprof/echo_server.1419559063.localhost.pprof.heap\nWrote profile to /home/gejun/pprof/echo_server.1419559063.localhost.pprof.heap\n/home/gejun/pprof/echo_server.1419559063.localhost.pprof.heap: header size >= 2**16\n"})}),"\n"]}),"\n",(0,o.jsxs)(r.li,{children:["\n",(0,o.jsxs)(r.p,{children:["\u5982\u679c\u53ea\u662fkrpc client\u6216\u6ca1\u6709\u4f7f\u7528krpc\uff0c\u770b",(0,o.jsx)(r.a,{href:"/cppdev/docs/rpc/krpc/dummy_server",children:"\u8fd9\u91cc"}),"\u3002"]}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(r.p,{children:"\u6ce8\u610f\u8981\u5173\u95edServer\u7aef\u7684\u8ba4\u8bc1\uff0c\u5426\u5219\u53ef\u80fd\u4f1a\u770b\u5230\u8fd9\u4e2a\uff1a"}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{children:"$ tools/pprof --text localhost:9002/pprof/heap\nUse of uninitialized value in substitution (s///) at tools/pprof line 2703.\nhttp://localhost:9002/pprof/symbol doesn't exist\n"})}),"\n",(0,o.jsx)(r.p,{children:"server\u7aef\u53ef\u80fd\u4f1a\u6709\u8fd9\u6837\u7684\u65e5\u5fd7\uff1a"}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{children:"FATAL: 12-26 10:01:25:   * 0 [src/krpc/policy/giano_authenticator.cpp:65][4294969345] Giano fails to verify credentical, 70003\nWARNING: 12-26 10:01:25:   * 0 [src/krpc/input_messenger.cpp:132][4294969345] Authentication failed, remote side(127.0.0.1:22989) of sockfd=5, close it\n"})}),"\n",(0,o.jsx)(r.h2,{id:"\u56fe\u793a",children:"\u56fe\u793a"}),"\n","\n",(0,o.jsx)("img",{src:i}),"\n",(0,o.jsx)(r.p,{children:"\u5de6\u4e0a\u89d2\u662f\u5f53\u524d\u7a0b\u5e8f\u901a\u8fc7malloc\u5206\u914d\u7684\u5185\u5b58\u603b\u91cf\uff0c\u987a\u7740\u7bad\u5934\u4e0a\u7684\u6570\u5b57\u53ef\u4ee5\u770b\u5230\u5185\u5b58\u6765\u81ea\u54ea\u4e9b\u51fd\u6570\u3002\u65b9\u6846\u5185\u7b2c\u4e00\u4e2a\u767e\u5206\u6bd4\u662f\u672c\u51fd\u6570\u7684\u5185\u5b58\u5360\u7528\u6bd4\u4f8b, \u7b2c\u4e8c\u4e2a\u767e\u5206\u6bd4\u662f\u672c\u51fd\u6570\u53ca\u5176\u5b50\u51fd\u6570\u7684\u5185\u5b58\u5360\u7528\u6bd4\u4f8b"}),"\n",(0,o.jsx)(r.p,{children:"\u70b9\u51fb\u5de6\u4e0a\u89d2\u7684text\u9009\u62e9\u6846\u53ef\u4ee5\u67e5\u770b\u6587\u672c\u683c\u5f0f\u7684\u7ed3\u679c\uff0c\u6709\u65f6\u5019\u8fd9\u79cd\u6309\u5206\u914d\u91cf\u6392\u5e8f\u7684\u5f62\u5f0f\u66f4\u65b9\u4fbf\u3002"}),"\n",(0,o.jsx)("img",{src:c}),"\n",(0,o.jsx)(r.p,{children:"\u5de6\u4e0a\u89d2\u7684\u4e24\u4e2a\u9009\u62e9\u6846\u4f5c\u7528\u5206\u522b\u662f\uff1a"}),"\n",(0,o.jsxs)(r.ul,{children:["\n",(0,o.jsxs)(r.li,{children:["View\uff1a\u5f53\u524d\u6b63\u5728\u770b\u7684profile\u3002\u9009\u62e9<new profile>\u8868\u793a\u65b0\u5efa\u4e00\u4e2a\u3002\u65b0\u5efa\u5b8c\u6bd5\u540e\uff0cView\u9009\u62e9\u6846\u4e2d\u4f1a\u51fa\u73b0\u65b0profile\uff0cURL\u4e5f\u4f1a\u88ab\u4fee\u6539\u4e3a\u5bf9\u5e94\u7684\u5730\u5740\u3002\u8fd9\u610f\u5473\u7740\u4f60\u53ef\u4ee5\u901a\u8fc7\u7c98\u8d34URL\u5206\u4eab\u7ed3\u679c\uff0c\u70b9\u51fb\u94fe\u63a5\u7684\u4eba\u5c06\u770b\u5230\u548c\u4f60\u4e00\u6a21\u4e00\u6837\u7684\u7ed3\u679c\uff0c\u800c\u4e0d\u662f\u91cd\u505aprofiling\u7684\u7ed3\u679c\u3002\u4f60\u53ef\u4ee5\u5728\u6846\u4e2d\u9009\u62e9\u4e4b\u524d\u7684profile\u67e5\u770b\u3002\u5386\u53f2profiie\u4fdd\u7559\u6700\u8fd1\u768432\u4e2a\uff0c\u53ef\u901a\u8fc7",(0,o.jsx)(r.a,{href:"http://krpc.baidu.com:8765/flags/max_profiles_kept",children:"--max_profiles_kept"}),"\u8c03\u6574\u3002"]}),"\n",(0,o.jsxs)(r.li,{children:["Diff\uff1a\u548c\u9009\u62e9\u7684profile\u505a\u5bf9\u6bd4\u3002",(0,o.jsx)(r.code,{children:"<none>"}),"\u8868\u793a\u4ec0\u4e48\u90fd\u4e0d\u9009\u3002\u5982\u679c\u4f60\u9009\u62e9\u4e86\u4e4b\u524d\u7684\u67d0\u4e2aprofile\uff0c\u90a3\u4e48\u5c06\u770b\u5230View\u6846\u4e2d\u7684profile\u76f8\u6bd4Diff\u6846\u4e2dprofile\u7684\u53d8\u5316\u91cf\u3002"]}),"\n"]}),"\n",(0,o.jsx)(r.p,{children:"\u4e0b\u56fe\u6f14\u793a\u4e86\u52fe\u9009Diff\u548cText\u7684\u6548\u679c\u3002"}),"\n",(0,o.jsx)("img",{src:t}),"\n",(0,o.jsx)(r.p,{children:"\u5728Linux\u4e0b\uff0c\u4f60\u4e5f\u53ef\u4ee5\u4f7f\u7528pprof\u811a\u672c\uff08tools/pprof\uff09\u5728\u547d\u4ee4\u884c\u4e2d\u67e5\u770b\u6587\u672c\u683c\u5f0f\u7ed3\u679c\uff1a"}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{children:"$ tools/pprof --text db-rpc-dev00.db01:8765/pprof/heap    \nFetching /pprof/heap profile from http://db-rpc-dev00.db01:8765/pprof/heap to\n  /home/gejun/pprof/play_server.1453216025.db-rpc-dev00.db01.pprof.heap\nWrote profile to /home/gejun/pprof/play_server.1453216025.db-rpc-dev00.db01.pprof.heap\nAdjusting heap profiles for 1-in-524288 sampling rate\nHeap version 2\nTotal: 38.9 MB\n    35.8  92.0%  92.0%     35.8  92.0% ::cpp_alloc\n     2.1   5.4%  97.4%      2.1   5.4% kutil::FlatMap\n     0.5   1.3%  98.7%      0.5   1.3% kutil::IOBuf::append\n     0.5   1.3% 100.0%      0.5   1.3% kutil::IOBufAsZeroCopyOutputStream::Next\n     0.0   0.0% 100.0%      0.6   1.5% MallocExtension::GetHeapSample\n     0.0   0.0% 100.0%      0.5   1.3% ProfileHandler::Init\n     0.0   0.0% 100.0%      0.5   1.3% ProfileHandlerRegisterCallback\n     0.0   0.0% 100.0%      0.5   1.3% __do_global_ctors_aux\n     0.0   0.0% 100.0%      1.6   4.2% _end\n     0.0   0.0% 100.0%      0.5   1.3% _init\n     0.0   0.0% 100.0%      0.6   1.5% krpc::CloseIdleConnections\n     0.0   0.0% 100.0%      1.1   2.9% krpc::GlobalUpdate\n     0.0   0.0% 100.0%      0.6   1.5% krpc::PProfService::heap\n     0.0   0.0% 100.0%      1.9   4.9% krpc::Socket::Create\n     0.0   0.0% 100.0%      2.9   7.4% krpc::Socket::Write\n     0.0   0.0% 100.0%      3.8   9.7% krpc::Span::CreateServerSpan\n     0.0   0.0% 100.0%      1.4   3.5% krpc::SpanQueue::Push\n     0.0   0.0% 100.0%      1.9   4.8% kutil::ObjectPool\n     0.0   0.0% 100.0%      0.8   2.0% kutil::ResourcePool\n     0.0   0.0% 100.0%      1.0   2.6% kutil::iobuf::tls_block\n     0.0   0.0% 100.0%      1.0   2.6% kthread::TimerThread::Bucket::schedule\n     0.0   0.0% 100.0%      1.6   4.1% kthread::get_stack\n     0.0   0.0% 100.0%      4.2  10.8% kthread_id_create\n     0.0   0.0% 100.0%      1.1   2.9% kvar::Variable::describe_series_exposed\n     0.0   0.0% 100.0%      1.0   2.6% kvar::detail::AgentGroup\n     0.0   0.0% 100.0%      0.5   1.3% kvar::detail::Percentile::operator\n     0.0   0.0% 100.0%      0.5   1.3% kvar::detail::PercentileSamples\n     0.0   0.0% 100.0%      0.5   1.3% kvar::detail::Sampler::schedule\n     0.0   0.0% 100.0%      6.5  16.8% leveldb::Arena::AllocateNewBlock\n     0.0   0.0% 100.0%      0.5   1.3% leveldb::VersionSet::LogAndApply\n     0.0   0.0% 100.0%      4.2  10.8% pthread_mutex_unlock\n     0.0   0.0% 100.0%      0.5   1.3% pthread_once\n     0.0   0.0% 100.0%      0.5   1.3% std::_Rb_tree\n     0.0   0.0% 100.0%      1.5   3.9% std::basic_string\n     0.0   0.0% 100.0%      3.5   9.0% std::string::_Rep::_S_create\n"})}),"\n",(0,o.jsx)(r.p,{children:"krpc\u8fd8\u63d0\u4f9b\u4e00\u4e2a\u7c7b\u4f3c\u7684growth profiler\u5206\u6790\u5185\u5b58\u7684\u5206\u914d\u53bb\u5411\uff08\u4e0d\u8003\u8651\u91ca\u653e\uff09\u3002"}),"\n","\n",(0,o.jsx)("img",{src:s}),"\n",(0,o.jsx)(r.h2,{id:"macos\u7684\u989d\u5916\u914d\u7f6e",children:"MacOS\u7684\u989d\u5916\u914d\u7f6e"}),"\n",(0,o.jsxs)(r.ol,{children:["\n",(0,o.jsxs)(r.li,{children:["\u5b89\u88c5",(0,o.jsx)(r.a,{href:"https://github.com/google/pprof",children:"standalone pprof"}),"\uff0c\u5e76\u628a\u4e0b\u8f7d\u7684pprof\u4e8c\u8fdb\u5236\u6587\u4ef6\u8def\u5f84\u5199\u5165\u73af\u5883\u53d8\u91cfGOOGLE_PPROF_BINARY_PATH\u4e2d"]}),"\n",(0,o.jsxs)(r.li,{children:["\u5b89\u88c5llvm-symbolizer\uff08\u5c06\u51fd\u6570\u7b26\u53f7\u8f6c\u5316\u4e3a\u51fd\u6570\u540d\uff09\uff0c\u76f4\u63a5\u7528brew\u5b89\u88c5\u5373\u53ef\uff1a",(0,o.jsx)(r.code,{children:"brew install llvm"})]}),"\n"]})]})}function x(e={}){const{wrapper:r}={...(0,l.R)(),...e.components};return r?(0,o.jsx)(r,{...e,children:(0,o.jsx)(u,{...e})}):u(e)}},8453:(e,r,n)=>{n.d(r,{R:()=>i,x:()=>c});var p=n(6540);const o={},l=p.createContext(o);function i(e){const r=p.useContext(l);return p.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function c(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:i(e.components),p.createElement(l.Provider,{value:r},e.children)}}}]);