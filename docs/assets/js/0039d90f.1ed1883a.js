"use strict";(globalThis.webpackChunkwebsite=globalThis.webpackChunkwebsite||[]).push([[2136],{5996:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>a,contentTitle:()=>l,default:()=>h,frontMatter:()=>t,metadata:()=>i,toc:()=>o});const i=JSON.parse('{"id":"store/kv/rocksdb/backup","title":"RocksDB Backup and Restore","description":"This document explains how to perform backup and restore in RocksDB, including snapshot-based and file-based (checkpoint) approaches, their use cases, and examples for syncing replicas.","source":"@site/docs/store/kv/rocksdb/backup.mdx","sourceDirName":"store/kv/rocksdb","slug":"/store/kv/rocksdb/backup","permalink":"/cppdev/docs/store/kv/rocksdb/backup","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"title":"RocksDB Backup and Restore"},"sidebar":"tutorialSidebar","previous":{"title":"RocksDB Snapshot and SST Loading","permalink":"/cppdev/docs/store/kv/rocksdb/snapshot"},"next":{"title":"Granite Key/Value Encapsulation and Workflow","permalink":"/cppdev/docs/store/kv/rocksdb/granite"}}');var r=s(4848),c=s(8453);const t={title:"RocksDB Backup and Restore"},l="RocksDB Backup and Restore",a={},o=[{value:"1. Overview of Backup Methods",id:"1-overview-of-backup-methods",level:2},{value:"2. File-based Backup Using Checkpoints",id:"2-file-based-backup-using-checkpoints",level:2},{value:"2.1 Creating a Checkpoint",id:"21-creating-a-checkpoint",level:3},{value:"2.2 Restoring from Checkpoint",id:"22-restoring-from-checkpoint",level:3},{value:"3. Backup vs. Restore with Snapshots",id:"3-backup-vs-restore-with-snapshots",level:2},{value:"3.1 Creating Backup via Snapshots",id:"31-creating-backup-via-snapshots",level:3},{value:"3.2 Restoring Backup via Snapshots",id:"32-restoring-backup-via-snapshots",level:3},{value:"4. Catching Up a Replica Using Snapshots",id:"4-catching-up-a-replica-using-snapshots",level:2},{value:"5. Comparison of Backup Methods",id:"5-comparison-of-backup-methods",level:2},{value:"6. Best Practices",id:"6-best-practices",level:2}];function d(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,c.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"rocksdb-backup-and-restore",children:"RocksDB Backup and Restore"})}),"\n",(0,r.jsxs)(n.p,{children:["This document explains how to perform backup and restore in RocksDB, including ",(0,r.jsx)(n.strong,{children:"snapshot-based"})," and ",(0,r.jsx)(n.strong,{children:"file-based (checkpoint)"})," approaches, their use cases, and examples for syncing replicas."]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"1-overview-of-backup-methods",children:"1. Overview of Backup Methods"}),"\n",(0,r.jsx)(n.p,{children:"RocksDB provides two primary backup methods:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Snapshot-based Backup"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Uses RocksDB's internal ",(0,r.jsx)(n.strong,{children:"SST snapshots"}),"."]}),"\n",(0,r.jsx)(n.li,{children:"Captures a consistent point-in-time view of the database."}),"\n",(0,r.jsx)(n.li,{children:"Typically implemented by traversing column families and exporting SSTs."}),"\n",(0,r.jsx)(n.li,{children:"Useful for replication, incremental backup, and fast restores."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"File-based Backup (Checkpoint)"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Uses ",(0,r.jsx)(n.strong,{children:"RocksDB checkpoint"})," API to create a copy of the database files."]}),"\n",(0,r.jsxs)(n.li,{children:["Produces a consistent ",(0,r.jsx)(n.strong,{children:"directory snapshot"})," of the entire database."]}),"\n",(0,r.jsx)(n.li,{children:"Easier to use than manual SST export, but typically larger and less flexible for selective restore."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"2-file-based-backup-using-checkpoints",children:"2. File-based Backup Using Checkpoints"}),"\n",(0,r.jsxs)(n.p,{children:["RocksDB provides ",(0,r.jsx)(n.code,{children:"rocksdb::Checkpoint"})," for creating backups at the file level."]}),"\n",(0,r.jsx)(n.h3,{id:"21-creating-a-checkpoint",children:"2.1 Creating a Checkpoint"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-cpp",children:'#include <rocksdb/checkpoint.h>\n\nrocksdb::Checkpoint* checkpoint;\nrocksdb::Status s = rocksdb::Checkpoint::Create(db, &checkpoint);\nif (!s.ok()) {\n    // handle error\n}\n\ns = checkpoint->CreateCheckpoint("/path/to/backup_dir");\nif (!s.ok()) {\n    // handle error\n}\n\ndelete checkpoint;\n'})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Produces a ",(0,r.jsx)(n.strong,{children:"directory"})," containing all database files, including:"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.code,{children:"MANIFEST"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"LOG"})," files"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"All SST files for all column families"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Ensures ",(0,r.jsx)(n.strong,{children:"point-in-time consistency"}),"."]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"22-restoring-from-checkpoint",children:"2.2 Restoring from Checkpoint"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Copy the checkpoint directory to a new location."}),"\n",(0,r.jsx)(n.li,{children:"Open a new RocksDB instance using the checkpoint path:"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-cpp",children:'rocksdb::DB* new_db;\nrocksdb::Options options;\ns = rocksdb::DB::Open(options, "/path/to/backup_dir", &new_db);\n'})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"All CFs and data are restored exactly as they were at checkpoint creation."}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"3-backup-vs-restore-with-snapshots",children:"3. Backup vs. Restore with Snapshots"}),"\n",(0,r.jsx)(n.h3,{id:"31-creating-backup-via-snapshots",children:"3.1 Creating Backup via Snapshots"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"As shown previously, snapshot backup involves exporting SSTs per column family."}),"\n",(0,r.jsxs)(n.li,{children:["Useful for ",(0,r.jsx)(n.strong,{children:"incremental backup"})," and ",(0,r.jsx)(n.strong,{children:"replication"}),"."]}),"\n",(0,r.jsx)(n.li,{children:"Can selectively backup specific CFs."}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"32-restoring-backup-via-snapshots",children:"3.2 Restoring Backup via Snapshots"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-cpp",children:"for (const auto &cf_name : snapshot_order) {\n    auto cf_handle = db->GetColumnFamilyHandle(cf_name);\n    db->IngestExternalFile(cf_handle, sst_files_for_cf[cf_name], ingest_options);\n}\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Must respect ",(0,r.jsx)(n.strong,{children:"original SST ingestion order"}),"."]}),"\n",(0,r.jsx)(n.li,{children:"Can merge multiple SST backups into an existing DB."}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"4-catching-up-a-replica-using-snapshots",children:"4. Catching Up a Replica Using Snapshots"}),"\n",(0,r.jsx)(n.p,{children:"For replication or secondary nodes catching up:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Take a snapshot of the primary node (or upstream DB)."}),"\n",(0,r.jsx)(n.li,{children:"Transfer the SSTs to the replica node."}),"\n",(0,r.jsx)(n.li,{children:"Ingest SSTs in the same column family order."}),"\n",(0,r.jsx)(n.li,{children:"Resume normal replication using WALs or transaction logs."}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-cpp",children:"// Example: applying snapshot to a follower\nfor (const auto &cf_name : snapshot_order) {\n    auto cf_handle = follower_db->GetColumnFamilyHandle(cf_name);\n    follower_db->IngestExternalFile(cf_handle, sst_files_for_cf[cf_name], ingest_options);\n}\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Ensures the replica has ",(0,r.jsx)(n.strong,{children:"exactly the same state"})," as the snapshot point."]}),"\n",(0,r.jsxs)(n.li,{children:["Useful for ",(0,r.jsx)(n.strong,{children:"fast bootstrap"})," or ",(0,r.jsx)(n.strong,{children:"catching up lagging replicas"}),"."]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"5-comparison-of-backup-methods",children:"5. Comparison of Backup Methods"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Feature"}),(0,r.jsx)(n.th,{children:"Snapshot Backup"}),(0,r.jsx)(n.th,{children:"File-based Checkpoint"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Granularity"}),(0,r.jsx)(n.td,{children:"Column-family level, can be selective"}),(0,r.jsx)(n.td,{children:"Whole DB only"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Size"}),(0,r.jsx)(n.td,{children:"Smaller if incremental"}),(0,r.jsx)(n.td,{children:"Typically larger"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Restore flexibility"}),(0,r.jsx)(n.td,{children:"Can merge into existing DB"}),(0,r.jsx)(n.td,{children:"Must restore whole DB"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Consistency"}),(0,r.jsx)(n.td,{children:"Point-in-time per SST"}),(0,r.jsx)(n.td,{children:"Atomic point-in-time for entire DB"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Use cases"}),(0,r.jsx)(n.td,{children:"Replication, incremental backup, selective restore"}),(0,r.jsx)(n.td,{children:"Full backup, disaster recovery, migration"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Complexity"}),(0,r.jsx)(n.td,{children:"Higher, requires tracking SSTs and CF order"}),(0,r.jsx)(n.td,{children:"Lower, just copy directory"})]})]})]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"6-best-practices",children:"6. Best Practices"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:"Use snapshots for:"})}),"\n"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Replication"}),"\n",(0,r.jsx)(n.li,{children:"Incremental backup"}),"\n",(0,r.jsx)(n.li,{children:"Selective CF restore"}),"\n"]}),"\n",(0,r.jsxs)(n.ol,{start:"2",children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:"Use checkpoints for:"})}),"\n"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Full database backup"}),"\n",(0,r.jsx)(n.li,{children:"Disaster recovery"}),"\n",(0,r.jsx)(n.li,{children:"Moving or migrating the database"}),"\n"]}),"\n",(0,r.jsxs)(n.ol,{start:"3",children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:"Tracking backup metadata"})}),"\n"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"For snapshots, maintain:"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"CF names"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"SST file list"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Ingestion order"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.ol,{start:"4",children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:"Apply backups in order"})}),"\n"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Critical for consistency, especially when restoring multiple CFs."}),"\n"]}),"\n",(0,r.jsxs)(n.ol,{start:"5",children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.strong,{children:"Verify backup"})}),"\n"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Always use iterators to check data integrity after restore."}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,c.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>t,x:()=>l});var i=s(6540);const r={},c=i.createContext(r);function t(e){const n=i.useContext(c);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:t(e.components),i.createElement(c.Provider,{value:n},e.children)}}}]);