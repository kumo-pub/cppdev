"use strict";(globalThis.webpackChunkwebsite=globalThis.webpackChunkwebsite||[]).push([[6500],{4167:(n,e,s)=>{s.r(e),s.d(e,{assets:()=>a,contentTitle:()=>o,default:()=>h,frontMatter:()=>t,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"store/kv/rocksdb/snapshot","title":"RocksDB Snapshot and SST Loading","description":"This document explains the process of loading RocksDB snapshots, handling SST files, and considerations regarding column families (CFs) and consistency.","source":"@site/docs/store/kv/rocksdb/snapshot.mdx","sourceDirName":"store/kv/rocksdb","slug":"/store/kv/rocksdb/snapshot","permalink":"/cppdev/docs/store/kv/rocksdb/snapshot","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"title":"RocksDB Snapshot and SST Loading"},"sidebar":"tutorialSidebar","previous":{"title":"RocksDB Configuration and Initialization","permalink":"/cppdev/docs/store/kv/rocksdb/config"},"next":{"title":"RocksDB Backup and Restore","permalink":"/cppdev/docs/store/kv/rocksdb/backup"}}');var r=s(4848),l=s(8453);const t={title:"RocksDB Snapshot and SST Loading"},o="RocksDB Snapshot and SST Loading",a={},c=[{value:"1. Overview",id:"1-overview",level:2},{value:"2. SST File Writing and Traversal",id:"2-sst-file-writing-and-traversal",level:2},{value:"2.1 Writing an SST File",id:"21-writing-an-sst-file",level:3},{value:"2.2 Traversing SST Content",id:"22-traversing-sst-content",level:3},{value:"3. Snapshot Loading Process",id:"3-snapshot-loading-process",level:2},{value:"4. Column Family Consistency",id:"4-column-family-consistency",level:2},{value:"5. Important Notes and Best Practices",id:"5-important-notes-and-best-practices",level:2},{value:"6. Example Loading Sequence",id:"6-example-loading-sequence",level:2},{value:"7. Summary",id:"7-summary",level:2}];function d(n){const e={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,l.R)(),...n.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e.header,{children:(0,r.jsx)(e.h1,{id:"rocksdb-snapshot-and-sst-loading",children:"RocksDB Snapshot and SST Loading"})}),"\n",(0,r.jsx)(e.p,{children:"This document explains the process of loading RocksDB snapshots, handling SST files, and considerations regarding column families (CFs) and consistency."}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h2,{id:"1-overview",children:"1. Overview"}),"\n",(0,r.jsx)(e.p,{children:"Snapshots in RocksDB are external representations of database state, often stored as SST files. They are used for:"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Backup and restore"}),"\n",(0,r.jsx)(e.li,{children:"Replication"}),"\n",(0,r.jsx)(e.li,{children:"Data migration"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"Important points:"}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["Each ",(0,r.jsx)(e.strong,{children:"SST file contains data for exactly one column family"}),"."]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["RocksDB does ",(0,r.jsx)(e.strong,{children:"not allow multiple column families"})," in a single SST file."]}),"\n",(0,r.jsxs)(e.li,{children:["To restore multiple column families, you must maintain a ",(0,r.jsx)(e.strong,{children:"mapping of SST files to CFs"}),"."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"Loading order matters"}),"."]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"If snapshots are applied in the wrong order, the database may become inconsistent."}),"\n",(0,r.jsx)(e.li,{children:"For example, applying an older SST after a newer one can overwrite recent updates."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["Snapshots can be applied using the ",(0,r.jsxs)(e.strong,{children:[(0,r.jsx)(e.code,{children:"IngestExternalFile"})," API"]}),"."]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h2,{id:"2-sst-file-writing-and-traversal",children:"2. SST File Writing and Traversal"}),"\n",(0,r.jsx)(e.h3,{id:"21-writing-an-sst-file",children:"2.1 Writing an SST File"}),"\n",(0,r.jsxs)(e.p,{children:["You can use RocksDB\u2019s native ",(0,r.jsx)(e.code,{children:"SstFileWriter"})," to generate SSTs:"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-cpp",children:'rocksdb::SstFileWriter writer(rocksdb::EnvOptions(), cf_options);\nwriter.Open("path/to/file.sst");\nwriter.Put(key, value);\nwriter.Finish();\n'})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["Each writer is tied to a ",(0,r.jsx)(e.strong,{children:"single column family"}),"."]}),"\n",(0,r.jsx)(e.li,{children:"SST files are immutable after creation."}),"\n"]}),"\n",(0,r.jsx)(e.h3,{id:"22-traversing-sst-content",children:"2.2 Traversing SST Content"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["SSTs are ",(0,r.jsx)(e.strong,{children:"sorted key-value sequences"}),"."]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["Traversal is done via ",(0,r.jsx)(e.code,{children:"rocksdb::Iterator"})," on the database after ingestion, or using ",(0,r.jsx)(e.code,{children:"SstFileReader"})," in some APIs."]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["Keys in SSTs are ",(0,r.jsx)(e.strong,{children:"sorted lexicographically"}),", and iterators allow:"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.code,{children:"Seek(key)"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.code,{children:"SeekToFirst()"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:(0,r.jsx)(e.code,{children:"SeekToLast()"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.code,{children:"Next()"})," / ",(0,r.jsx)(e.code,{children:"Prev()"})]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h2,{id:"3-snapshot-loading-process",children:"3. Snapshot Loading Process"}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.strong,{children:"Prepare Column Family Handles"})}),"\n"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Ensure all target column families exist in the database."}),"\n",(0,r.jsx)(e.li,{children:"Missing column families must be created before ingestion."}),"\n"]}),"\n",(0,r.jsxs)(e.ol,{start:"2",children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.strong,{children:"Ingest SST Files"})}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-cpp",children:"rocksdb::IngestExternalFileOptions options;\noptions.move_files = true; // optionally move instead of copy\ndb->IngestExternalFile(cf_handle, sst_files, options);\n"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"One SST per column family."}),"\n",(0,r.jsx)(e.li,{children:"Multiple SSTs for the same column family can be ingested sequentially."}),"\n"]}),"\n",(0,r.jsxs)(e.ol,{start:"3",children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.strong,{children:"Maintain Order for Consistency"})}),"\n"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"For a multi-column-family snapshot:"}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:["Apply SSTs in ",(0,r.jsx)(e.strong,{children:"the order they were exported"}),"."]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"Ensure dependent column families (e.g., raft_log, metadata) are ingested first if other CFs rely on them."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.ol,{start:"4",children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.strong,{children:"Optional Flush / Compact"})}),"\n"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"After ingestion, you can flush or compact:"}),"\n"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-cpp",children:"db->Flush(rocksdb::FlushOptions(), cf_handle);\ndb->CompactRange(rocksdb::CompactRangeOptions(), cf_handle);\n"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Ensures the ingested data is immediately visible and reduces read amplification."}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h2,{id:"4-column-family-consistency",children:"4. Column Family Consistency"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"SST files per column family:"})," One SST maps to one CF."]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"Multiple CFs in a snapshot:"})," Keep a manifest or metadata that records which SST belongs to which CF and their ingestion order."]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"Atomicity:"})," RocksDB ingestion is ",(0,r.jsx)(e.strong,{children:"atomic per SST file"}),", but ",(0,r.jsx)(e.strong,{children:"not across multiple column families"}),"."]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["\n",(0,r.jsx)(e.p,{children:"To achieve cross-CF consistency, the snapshot loader must apply CFs in the original order and consider dependencies."}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h2,{id:"5-important-notes-and-best-practices",children:"5. Important Notes and Best Practices"}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"Never mix CFs in a single SST file"}),"."]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"Always create missing CFs before loading snapshots"}),"."]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"Track snapshot version"}),": ingestion must follow chronological order to avoid overwriting newer data."]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsxs)(e.strong,{children:["Use write-ahead logging (",(0,r.jsx)(e.code,{children:"disableWAL=false"}),")"]})," if durability is required during ingestion."]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"Check status"})," after every ",(0,r.jsx)(e.code,{children:"IngestExternalFile"})," call; ingestion can fail due to corruption, existing keys, or incompatible options."]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"Iterators after ingestion"})," can be used to verify snapshot correctness."]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h2,{id:"6-example-loading-sequence",children:"6. Example Loading Sequence"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-cpp",children:"for (const auto &cf_name : snapshot_order) {\n    auto cf_handle = db->GetColumnFamilyHandle(cf_name);\n    db->IngestExternalFile(cf_handle, sst_files_for_cf[cf_name], ingest_options);\n}\n"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"snapshot_order"})," must reflect ",(0,r.jsx)(e.strong,{children:"original export order"}),"."]}),"\n",(0,r.jsx)(e.li,{children:"Each CF can have multiple SST files; ingest them sequentially."}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h2,{id:"7-summary",children:"7. Summary"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.strong,{children:"SST \u2192 1 CF"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.strong,{children:"Multiple CFs \u2192 maintain order"})}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"IngestExternalFile"})," is atomic per SST"]}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.strong,{children:"Order and dependencies are critical"})}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"Flush/compact after ingestion"})," to ensure visibility and performance"]}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"By following this procedure, you can safely restore RocksDB snapshots without breaking CF consistency."})]})}function h(n={}){const{wrapper:e}={...(0,l.R)(),...n.components};return e?(0,r.jsx)(e,{...n,children:(0,r.jsx)(d,{...n})}):d(n)}},8453:(n,e,s)=>{s.d(e,{R:()=>t,x:()=>o});var i=s(6540);const r={},l=i.createContext(r);function t(n){const e=i.useContext(l);return i.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function o(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(r):n.components||r:t(n.components),i.createElement(l.Provider,{value:e},n.children)}}}]);